<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desa - Loading & Inventory System</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png"> <!-- Make sure you have a favicon.png or remove this line -->

    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <!-- External JS (Signature Pad) -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <style>
        /* --- THis is the CSS HERE --- */
        :root {
            --primary-blue: #0056b3;
            --secondary-blue: #007bff;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #343a40;
            --text-muted: #6c757d;
            --danger-red: #dc3545;
            --success-green: #28a745;
            --white: #ffffff;
            --border-radius: 6px;
            --box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif; background-color: var(--light-gray); margin: 0; padding: 20px; color: var(--dark-gray); line-height: 1.6; }
        .container { background-color: var(--white); border-radius: 10px; box-shadow: var(--box-shadow); width: 100%; max-width: 1100px; margin: 20px auto; overflow: hidden; }
        .header { background-color: var(--primary-blue); color: var(--white); padding: 25px 30px; text-align: center; border-bottom: 5px solid var(--secondary-blue); }
        .header-logo { display: block; height: 50px; width: auto; margin: 0 auto 15px auto; }
        .header h1 { margin: 0; font-size: 2rem; font-weight: 600; }
        .header p { margin: 5px 0 0; font-size: 1rem; opacity: 0.9; }
        .content { padding: 30px; }
        .section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 15px; color: var(--primary-blue); padding-bottom: 10px; border-bottom: 2px solid var(--medium-gray); display: flex; align-items: center; gap: 10px; }
        .project-selection-area { padding: 20px; margin-bottom: 15px; }
        .project-selection-area label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--dark-gray); }
        .project-selection-area select { width: 100%; padding: 12px 15px; border: 1px solid #ced4da; border-radius: var(--border-radius); font-size: 1rem; transition: border-color 0.3s, box-shadow 0.3s; line-height: 1.5; background-color: var(--white); appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 16px 12px; padding-right: 2.5rem; }
        .project-selection-area select.select2-hidden-accessible { background-image: none; padding-right: 15px; }
        .project-selection-area select:focus { border-color: var(--secondary-blue); outline: none; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
        form { background-color: var(--white); padding: 25px; border-radius: var(--border-radius); border: 1px solid var(--medium-gray); margin-bottom: 25px; margin-top: 0; }
        .intro-paragraph { padding: 0 25px; margin-bottom: 15px; color: var(--text-muted); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--dark-gray); }
        .form-group input[type="text"], .form-group input[type="number"], .form-group input[type="date"], .form-group input[type="tel"], .form-group textarea, .form-group select, .form-control { width: 100%; padding: 12px 15px; border: 1px solid #ced4da; border-radius: var(--border-radius); font-size: 1rem; transition: border-color 0.3s, box-shadow 0.3s; line-height: 1.5; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .form-group input:focus, .form-group input[type="tel"]:focus, .form-group textarea:focus, .form-group select:focus, .form-control:focus { border-color: var(--secondary-blue); outline: none; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
        .unit-label { color: var(--text-muted); font-size: 0.85rem; margin-left: 5px; font-weight: normal; }
        .button-group { display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; flex-wrap: wrap; }
        .btn { padding: 10px 25px; border: none; border-radius: var(--border-radius); font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; gap: 8px; text-decoration: none; line-height: 1.5; }
        .btn:hover { transform: translateY(-2px); filter: brightness(110%); }
        .btn-next { background-color: var(--success-green); color: var(--white); } .btn-next:hover { background-color: #218838; }
        .btn-cancel, .btn-secondary { background-color: var(--medium-gray); color: var(--dark-gray); } .btn-cancel:hover, .btn-secondary:hover { background-color: #d6d8db; }
        .btn-print, .btn-primary { background-color: var(--primary-blue); color: var(--white); } .btn-print:hover, .btn-primary:hover { background-color: #004494; }
        .btn-edit { background-color: var(--secondary-blue); color: var(--white); } .btn-edit:hover { background-color: #0056b3; }
        .btn-delete { background-color: var(--danger-red); color: var(--white); } .btn-delete:hover { background-color: #c82333; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; gap: 5px; }
        .input-icon { position: relative; } .input-icon i { position: absolute; right: 15px; top: calc(50% + 5px); transform: translateY(-50%); color: var(--text-muted); pointer-events: none; } .input-icon input { padding-right: 40px; }
        .skid-details { margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background-color: var(--white); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--box-shadow); border: 1px solid var(--medium-gray); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--medium-gray); vertical-align: middle; }
        th { background-color: var(--primary-blue); color: var(--white); font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        tr:last-child td { border-bottom: none; } tr:hover { background-color: #f1f8ff; } td.action-buttons { display: flex; gap: 8px; white-space: nowrap; }
        .form-container { background-color: var(--light-gray); padding: 20px; border-radius: var(--border-radius); margin-top: 20px; margin-bottom: 20px; border: 1px solid var(--medium-gray); }
        .form-container h4 { margin-top: 0; margin-bottom: 20px; color: var(--primary-blue); display: flex; align-items: center; gap: 8px; }
        .row { display: flex; flex-wrap: wrap; margin: 0 -10px; }
        .col-md-3, .col-md-4, .col-md-6, .col-md-12 { padding: 0 10px; margin-bottom: 15px; }
        .col-md-3 { flex: 0 0 25%; max-width: 25%; } .col-md-4 { flex: 0 0 33.333%; max-width: 33.333%; } .col-md-6 { flex: 0 0 50%; max-width: 50%; } .col-md-12 { flex: 0 0 100%; max-width: 100%; }
        .input-group { display: flex; } .input-group input { border-top-right-radius: 0; border-bottom-right-radius: 0; } .input-group-text { padding: 12px 15px; background-color: var(--medium-gray); border: 1px solid #ced4da; border-left: none; border-radius: 0 var(--border-radius) var(--border-radius) 0; font-size: 1rem; color: var(--text-muted); }
        .mt-3 { margin-top: 1rem; } .d-flex { display: flex; } .justify-content-between { justify-content: space-between; } .align-items-center { align-items: center; }
        .loading-instructions { background-color: #eef7ff; padding: 20px; border-radius: var(--border-radius); margin-top: 20px; border: 1px solid #bde0ff; }
        .loading-instructions h5 { margin-top: 0; margin-bottom: 15px; color: var(--primary-blue); display: flex; align-items: center; gap: 8px; } .loading-instructions ul { padding-left: 20px; margin-bottom: 0; } .loading-instructions li { margin-bottom: 5px; }
        .warning { color: var(--danger-red); font-weight: 600; background-color: #ffebee; padding: 10px; border-radius: var(--border-radius); margin-top: 10px; border: 1px solid var(--danger-red); } .warning i { margin-right: 5px; }
        .page { display: none; } .page.active { display: block; animation: fadeIn 0.5s ease-in-out; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .document-container { background-color: var(--white); padding: 40px; box-shadow: none; border: 1px solid var(--medium-gray); border-radius: var(--border-radius); position: relative; margin-bottom: 30px; }
        .packing-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid var(--primary-blue); }
        .logo-container { width: 150px; height: 75px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; } .logo-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .packing-title-area { flex-grow: 1; text-align: center; margin: 0 20px; } .packing-title { font-size: 1.8rem; margin-bottom: 5px; color: var(--dark-gray); font-weight: 700; } .subtitle { font-weight: bold; margin-bottom: 0; color: var(--text-muted); font-size: 1rem; line-height: 1.4; }
        .divider { border: 0; height: 1px; background: var(--medium-gray); margin: 30px 0; }
        .form-section { margin-bottom: 30px; } .form-section .section-title { font-weight: 600; color: var(--primary-blue); margin-bottom: 15px; font-size: 1.1rem; border-bottom: 1px solid var(--medium-gray); padding-bottom: 8px; }
        .form-row { display: flex; gap: 25px; margin-bottom: 20px; } .form-row .form-field { flex: 1; min-width: 0; } .form-field { margin-bottom: 20px; } .form-field label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--dark-gray); } .form-field label.required::after { content: " *"; color: var(--danger-red); font-weight: normal; }
        .form-field input[type="text"], .form-field input[type="date"], .form-field input[type="tel"] { width: 100%; padding: 12px 15px; border: 1px solid #ced4da; border-radius: var(--border-radius); font-size: 1rem; } .form-field input:focus, .form-field input[type="tel"]:focus { border-color: var(--secondary-blue); outline: none; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
        .fixed-info { margin-bottom: 20px; padding: 15px 20px; background-color: var(--light-gray); border-radius: var(--border-radius); border-left: 4px solid var(--secondary-blue); } .fixed-info p { margin: 8px 0; line-height: 1.5; } .fixed-info strong { color: var(--primary-blue); }
        .signature-area { margin-top: 40px; padding-top: 30px; border-top: 1px dashed var(--medium-gray); }
        .signature-container { border: 2px dashed var(--medium-gray); border-radius: var(--border-radius); margin-top: 10px; position: relative; height: 200px; background-color: #fdfdfd; cursor: crosshair; } #signature-pad { display: block; width: 100%; height: 100%; touch-action: none; }
        .signature-clear { position: absolute; right: 10px; bottom: 10px; background: var(--danger-red); color: var(--white); border: none; padding: 6px 12px; border-radius: var(--border-radius); cursor: pointer; font-size: 0.8rem; transition: background-color 0.3s; } .signature-clear:hover { background-color: #c82333; }
        .packing-action-buttons { display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--medium-gray); }
        .signature-required-error { color: var(--danger-red); font-size: 0.85rem; margin-top: 5px; display: none; }
        .save-status { font-size: 0.85rem; text-align: right; margin-top: 15px; height: 1em; opacity: 0; transition: opacity 0.5s; } .save-status.visible { opacity: 1; }
        @media print { body { padding: 0; background: var(--white) !important; font-size: 10pt; color: #000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; } .container { box-shadow: none; border-radius: 0; max-width: 100%; margin: 0; border: none; } .header, .intro-paragraph, #jobSelectionPage, #projectSelectionPage { display: none !important; } .content { padding: 10px; } .no-print, .button-group, .packing-action-buttons, .save-status, .signature-clear, .action-buttons td .btn-edit, .action-buttons td .btn-delete, .section-title.no-print, .select2-container, .project-selection-area, #inventorySkidSelectionContainer, #inventoryPage .button-group { display: none !important; } form { border: none; padding: 0; margin: 0; box-shadow: none; } .form-field label.required::after { content: "" !important; } .form-field label .print-remove-required { display: none !important; } .form-group select { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: none !important; border: none; padding: 0; } table { page-break-inside: auto; box-shadow: none; border: 1px solid #ccc; border-radius: 0; margin-top: 10px; } tr { page-break-inside: avoid; page-break-after: auto } th { background-color: #eee !important; color: #000 !important; font-size: 9pt; border: 1px solid #ccc; } td { border: 1px solid #ccc; padding: 8px; } .fixed-info { page-break-inside: avoid; background-color: #f0f0f0 !important; border: 1px solid #ccc; padding: 10px 15px; } .document-container { box-shadow: none; padding: 10px; border: none; } .packing-header { border-bottom: 2px solid #666; padding-bottom: 15px; margin-bottom: 15px; } .packing-header .logo-container img { max-height: 60px; } .packing-title { font-size: 1.6rem; } .signature-container { border: 1px solid #999; height: 150px; background-color: #fff !important; } #signature-pad { border: none; } #printTruckInfo { display: block !important; margin-top: 20px; padding: 15px 0; border: none; border-top: 1px solid #ccc; background-color: transparent !important; page-break-before: always !important; } #printLoadingSummary { margin-top: 15px; padding: 15px; background-color: #f5f5f5 !important; border: 1px solid #ddd; font-size: 9pt; } #printLoadingSummary h5 { margin-top: 0; margin-bottom: 10px; font-size: 11pt; color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px; } #printLoadingSummary ul { padding-left: 20px; margin-bottom: 5px; list-style: disc; } #printLoadingSummary li { margin-bottom: 4px; } #printLoadingSummary p.warning { color: #a94442 !important; background-color: #f2dede !important; border: 1px solid #ebccd1 !important; padding: 8px; margin-top: 8px; font-weight: bold; } .print-section-title { font-size: 14pt; color: #000; margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; font-weight: bold; } .print-section-subtitle { font-size: 11pt; color: #333; margin-top: 15px; margin-bottom: 5px; font-weight: bold; } #printTruckInfo p { margin: 4px 0; } .print-skids-table { margin-top: 10px; width: 100%; border-collapse: collapse; } .print-skids-table th, .print-skids-table td { border: 1px solid #ccc; padding: 6px; font-size: 9pt; } .print-skids-table th { background-color: #eee !important; text-align: left; } .print-skids-table tfoot td { background-color: #f5f5f5 !important; } #printTruckInfo p.project-info { } #inventoryPage { display: none !important; } }
        @media (max-width: 992px) { .col-md-3, .col-md-4 { flex: 0 0 50%; max-width: 50%; } .project-selection-area, .intro-paragraph, form { padding-left: 15px; padding-right: 15px; } }
        @media (max-width: 768px) { body { padding: 10px; } .container { margin: 10px auto; } .content { padding: 15px; } .header { padding: 20px 15px; } .header-logo { height: 40px; margin-bottom: 10px;} .header h1 { font-size: 1.8rem; } .col-md-3, .col-md-4, .col-md-6 { flex: 0 0 100%; max-width: 100%; } .button-group, .packing-action-buttons { flex-direction: column; gap: 10px; } .button-group .btn, .packing-action-buttons .btn { width: 100%; justify-content: center; } .form-row { flex-direction: column; gap: 0; } .form-row .form-field { margin-bottom: 20px; } .packing-header { flex-direction: column; text-align: center; } .logo-container { margin-bottom: 15px; width: 120px; height: 60px; } .packing-title-area { margin: 0; } .packing-title { font-size: 1.5rem; } .signature-container { height: 150px; } td.action-buttons { flex-direction: row; flex-wrap: wrap; gap: 5px; } .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; } .project-selection-area, .intro-paragraph, form { padding-left: 10px; padding-right: 10px; } }
        .is-invalid { border-color: var(--danger-red) !important; box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.25) !important; }
        .select2-container--bootstrap-5 .select2-selection.is-invalid { border-color: var(--danger-red) !important; box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.25) !important; }
        .select2-container--bootstrap-5 .select2-selection--single { height: calc(1.5em + 0.75rem + 8px)!important; padding: 12px 15px!important; border: 1px solid #ced4da!important; border-radius: var(--border-radius)!important; }
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered { line-height: 1.5!important; padding-left: 0!important; }
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow { height: calc(1.5em + 0.75rem + 6px)!important; }
        .select2-container--bootstrap-5.select2-container--focus .select2-selection, .select2-container--bootstrap-5.select2-container--open .select2-selection { border-color: var(--secondary-blue) !important; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25) !important; }
        .select2-search__field { border: 1px solid #ced4da!important; border-radius: var(--border-radius)!important; padding: 8px 10px!important; }
        #inventorySkidSelectionContainer { margin-top: 30px; padding: 20px; background-color: #eef7ff; border: 1px solid #bde0ff; border-radius: var(--border-radius); }
        #inventorySkidSelectionContainer h4 { margin-top: 0; margin-bottom: 15px; color: var(--primary-blue); border-bottom: 1px solid var(--medium-gray); padding-bottom: 10px; }
        #inventorySkidSelectionContainer table { margin-bottom: 15px; background-color: var(--white); }
        #inventorySkidSelectionContainer table th, #inventorySkidSelectionContainer table td { font-size: 0.9rem; padding: 8px 12px; }
        #inventorySkidSelectionContainer table th:first-child, #inventorySkidSelectionContainer table td:first-child { width: 50px; text-align: center; }
        /* Ensure invalid feedback displays */
        .invalid-feedback { display: none; width: 100%; margin-top: 0.25rem; font-size: .875em; color: var(--danger-red); }
        .is-invalid ~ .invalid-feedback { display: block; }
        /* Style for disabled inventory selection checkbox */
        .inventory-skid-select:disabled { cursor: not-allowed; }
        .inventory-skid-select:disabled + label { color: var(--text-muted); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
             <img src="./img.webp" alt="Desa Company Logo" class="header-logo"> <!-- Ensure path is correct -->
             <h1>Desa</h1>
             <p>Loading & Inventory System</p>
        </div>

        <div class="content">

            <!-- ==== Page 0: Job Selection ==== -->
            <div id="jobSelectionPage" class="page active">
                <h2 class="section-title"><i class="fas fa-tasks"></i> Select Task</h2>
                <div class="form-group" style="padding: 20px;">
                    <label for="jobTypeSelect">Choose the task you want to perform:</label>
                    <select id="jobTypeSelect" class="form-control">
                        <option value="" disabled selected>-- Select Task Type --</option>
                        <option value="inventory">Inventory Skid Entry</option>
                        <option value="truckEntry">Truck Load Entry & Packing</option>
                    </select>
                </div>
                <div class="button-group" style="padding: 0 20px 20px;">
                    <button type="button" class="btn btn-danger" onclick="resetEntireProcess()" title="Clear all saved data and start over">
                        <i class="fas fa-power-off"></i> Reset All Data
                    </button>
                    <button type="button" class="btn btn-primary" id="proceedJobSelectionBtn">
                        <i class="fas fa-arrow-right"></i> Next: Select Project
                    </button>
                </div>
            </div>

            <!-- ==== NEW: Page 0.5: Project Selection ==== -->
            <div id="projectSelectionPage" class="page">
                 <h2 class="section-title"><i class="fas fa-clipboard-list"></i> Select Project for <span id="projectSelectionTaskName">Task</span></h2>
                 <div class="project-selection-area">
                    <label for="mainProjectSelect">Project <span class="unit-label">(Required)</span></label>
                    <select id="mainProjectSelect" name="mainProject" class="form-control project-selector" style="width: 100%;">
                        <option value="" disabled selected>Select a Project...</option>
                        <!-- Options populated by JS -->
                    </select>
                    <div id="mainProjectSelect-error" class="invalid-feedback" style="display: none;">Project selection is required.</div>
                </div>
                 <div class="button-group" style="padding: 0 20px 20px;">
                     <button type="button" class="btn btn-secondary" onclick="goBackToJobSelection()">
                         <i class="fas fa-arrow-left"></i> Back to Task Selection
                     </button>
                     <button type="button" class="btn btn-primary" id="proceedProjectSelectionBtn">
                         <i class="fas fa-arrow-right"></i> Proceed to <span id="projectSelectionProceedButtonText">Next Step</span>
                     </button>
                 </div>
            </div>

            <!-- ==== Page I: Inventory Management ==== -->
            <div id="inventoryPage" class="page">
                <h2 class="section-title"><i class="fas fa-boxes"></i> Inventory Skid Management for: <span id="inventoryPageProjectName">N/A</span></h2>

                <!-- Project display instead of selection -->
                <div class="fixed-info" style="margin: 0 25px 15px;">
                     <p><strong>Current Project:</strong> <span id="inventoryProjectDisplay">N/A</span></p>
                </div>

                <!-- Inventory Skid Table -->
                 <h3 class="section-title" style="font-size: 1.2rem; margin-top: 30px; border-bottom: none;">
                     <i class="fas fa-list-ul"></i> Skids in Inventory
                 </h3>
                 <div class="table-responsive">
                     <table id="inventorySkidTable">
                         <thead>
                             <tr>
                                 <th>Inv. ID</th><th>Width (ft)</th><th>Length (ft)</th><th>Weight (lbs)</th><th>Description</th><th class="no-print" style="width: 150px;">Actions</th>
                             </tr>
                         </thead>
                         <tbody id="inventorySkidTableBody">
                             <tr><td colspan="6" style="text-align: center;">Loading inventory skids...</td></tr>
                         </tbody>
                     </table>
                 </div>

                 <!-- Action Buttons for Inventory -->
                 <div class="d-flex justify-content-between align-items-center mb-3 mt-3 no-print">
                     <button class="btn btn-success" id="showAddInventorySkidBtn">
                         <i class="fas fa-plus"></i> Add Skid to Inventory
                     </button>
                     <button id="resetInventorySkidsBtn" type="button" class="btn btn-danger" style="margin-left: 10px;" title="Delete all skids listed for the selected project's inventory">
                        <i class="fas fa-trash-alt"></i> Clear All Skids for this Project
                    </button>
                 </div>

                <!-- Add/Edit Skid Form Container -->
                 <div class="form-container no-print" id="addInventorySkidFormContainer" style="display: none;">
                     {/* Content Populated by JS using template */}
                 </div>

                 <!-- Navigation Buttons -->
                 <div class="button-group no-print" style="margin-top: 30px;">
                     <button class="btn btn-secondary" onclick="goBackToJobSelection()">
                         <i class="fas fa-arrow-left"></i> Back to Task Selection
                     </button>
                     <!-- MODIFIED BUTTON BELOW -->
                     <button class="btn btn-primary" onclick="saveInventoryAndReturnToTaskSelection()" title="Save inventory changes and return to Task Selection">
                        <i class="fas fa-save"></i> Save Inventory & Return
                    </button>
                 </div>
            </div>

            <!-- ==== Page 1: Truck Information ==== -->
            <div id="truckInfoPage" class="page">
                <h2 class="section-title"><i class="fas fa-truck"></i> Truck Information Entry for: <span id="truckInfoPageProjectName">N/A</span></h2>

                 <!-- Project display instead of selection -->
                <div class="fixed-info" style="margin: 0 25px 15px;">
                     <p><strong>Current Project:</strong> <span id="truckProjectDisplay">N/A</span></p>
                </div>

                <!-- Intro Paragraph -->
                <p class="intro-paragraph">Enter the truck details below to begin loading planning.</p>

                <!-- Truck Details Form -->
                <form id="truckInfoForm" novalidate>
                    <div class="form-group input-icon">
                        <label for="truckId">Truck Identification <span class="unit-label">(Required)</span></label>
                        <input type="text" id="truckId" name="truckId" class="form-control" placeholder="Enter truck ID or license plate" required>
                        <i class="fas fa-tag"></i>
                        <div class="invalid-feedback">Please enter the Truck Identification.</div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group input-icon">
                                <label for="length">Length <span class="unit-label">(Feet, Required)</span></label>
                                <input type="number" id="length" name="length" class="form-control" placeholder="e.g., 53" step="0.01" min="1" required>
                                <i class="fas fa-ruler-horizontal"></i>
                                <div class="invalid-feedback">Please enter a valid length (min 1).</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group input-icon">
                                <label for="width">Width <span class="unit-label">(Feet, Required)</span></label>
                                <input type="number" id="width" name="width" class="form-control" placeholder="e.g., 8.5" step="0.01" min="1" required>
                                <i class="fas fa-ruler-combined"></i>
                                <div class="invalid-feedback">Please enter a valid width (min 1).</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group input-icon">
                                <label for="weight">Weight Capacity <span class="unit-label">(Pounds, Required)</span></label>
                                <input type="number" id="weight" name="weight" class="form-control" placeholder="e.g., 45000" step="1" min="1000" required>
                                <i class="fas fa-weight-hanging"></i>
                                <div class="invalid-feedback">Please enter a valid weight capacity (min 1000).</div>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="goBackToJobSelection()"><i class="fas fa-arrow-left"></i> Back to Task Selection</button>
                        <button type="button" class="btn btn-cancel" id="resetTruckInfoBtn"><i class="fas fa-undo"></i> Reset Truck Info Fields</button>
                        <button type="submit" class="btn btn-next" id="nextBtn"><i class="fas fa-arrow-right"></i> Next: Add Skids</button>
                    </div>
                </form>
            </div>

            <!-- ==== Page 2: Skid Details ==== -->
            <div id="skidDetailsPage" class="page">
                <h2 class="section-title"><i class="fas fa-pallet"></i> Skids for Truck: <span id="truckIdentifier"></span> (<span id="skidDetailsProjectName">N/A</span>)</h2>
                <p>Add skids directly, select from inventory for this project, or edit/remove skids for this load. <span id="truckSizeDisplay"></span></p>

                <!-- Inventory Skid Selection -->
                <div id="inventorySkidSelectionContainer" class="no-print" style="display: none;">
                     <h4><i class="fas fa-clipboard-check"></i> Select Inventory Skids to Add to Truck</h4>
                     <div class="table-responsive">
                         <table id="inventorySkidSelectionTable">
                             <thead>
                                 <tr>
                                     <th>Add</th><th>Inv. ID</th><th>W (ft)</th><th>L (ft)</th><th>Wt (lbs)</th><th>Description</th>
                                 </tr>
                             </thead>
                             <tbody id="inventorySkidSelectionBody">
                                 <!-- Populated by JS -->
                             </tbody>
                         </table>
                     </div>
                     <button id="addSelectedInventorySkidsBtn" class="btn btn-primary btn-sm">
                         <i class="fas fa-plus-circle"></i> Add Selected Inventory Skids to Truck Load
                     </button>
                </div>

                 <!-- Add/Edit Skid Form Container -->
                 <div class="form-container no-print" id="addTruckSkidFormContainer" style="display: none;">
                    {/* Content Populated by JS using template */}
                 </div>

                 <!-- Action Buttons -->
                 <div class="d-flex justify-content-between align-items-center mb-3 mt-3 no-print">
                     <div>
                         <button class="btn btn-success" id="addTruckSkidBtn">
                             <i class="fas fa-plus"></i> Add Skid Directly to Truck
                         </button>
                         <button id="resetSkidsBtn" type="button" class="btn btn-secondary" style="margin-left: 10px;" title="Remove all skids currently listed for this truck load">
                             <i class="fas fa-undo"></i> Reset Truck Skids List
                         </button>
                     </div>
                     <button class="btn btn-print" onclick="printSkidPage()">
                         <i class="fas fa-print"></i> Print Loading Plan
                     </button>
                 </div>

                <!-- Truck Skid Table -->
                <h3 class="section-title" style="font-size: 1.2rem; margin-top: 30px; border-bottom: none;">
                    <i class="fas fa-truck-loading"></i> Skids Assigned to this Truck Load
                </h3>
                <div class="table-responsive">
                    <table id="truckSkidTable">
                        <thead>
                            <tr>
                                <th>Truck Skid #</th><!-- CHANGED LABEL -->
                                <th>Width (ft)</th><th>Length (ft)</th><th>Weight (lbs)</th><th>Description</th><th class="no-print" style="width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="truckSkidTableBody">
                            <tr><td colspan="6" style="text-align: center;">No skids added to this truck yet.</td></tr>
                        </tbody>
                         <tfoot>
                            <tr style="font-weight: bold; background-color: var(--light-gray);">
                                <td colspan="3">Truck Totals: <span id="totalTruckSkidCount">0</span> Skids</td>
                                <td id="totalTruckSkidWeight">0.00 lbs</td><td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Loading Instructions -->
                <div class="loading-instructions no-print">
                    <div id="loadingInstructions">Enter truck info and add skids to see summary.</div>
                </div>

                <!-- Navigation Buttons -->
                <div class="button-group no-print" style="margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="goBackToJobSelection()">
                        <i class="fas fa-arrow-left"></i> Back to Task Selection
                    </button>
                     <button class="btn btn-secondary" onclick="navigateTo('truckInfoPage')"> <!-- Added Back to Truck Info -->
                         <i class="fas fa-arrow-left"></i> Back to Truck Info
                     </button>
                    <button class="btn btn-next" onclick="proceedToPackingList()">
                        <i class="fas fa-clipboard-list"></i> Next: Packing List
                    </button>
                </div>
            </div>

            <!-- ==== Page 3: Packing List ==== -->
            <div id="packingListPage" class="page">
                 <h2 class="section-title no-print"><i class="fas fa-file-invoice"></i> Packing List & Delivery Confirmation</h2>
                 <div class="document-container">
                     <!-- Packing Header -->
                     <div class="packing-header">
                         <div class="logo-container">
                             <img src="./img.webp" alt="Desa Packing List Logo"> <!-- Ensure path is correct -->
                         </div>
                         <div class="packing-title-area">
                             <div class="packing-title">TRUCK LOAD <span id="packingListTruckId"></span></div>
                             <div class="subtitle">DESA PANELS - PACKING LIST</div>
                         </div>
                     </div>

                     <!-- Packing List Form -->
                     <form id="packing-list-form" novalidate>
                         <!-- Section 1: General Info -->
                        <div class="form-section">
                             <div class="form-row">
                                 <div class="form-field">
                                     <label for="date">DELIVERY DATE: </label>
                                     <input type="date" id="date" name="date" class="form-control">
                                 </div>
                                 <div class="form-field">
                                     <label for="work-order">WORK ORDER NO.:</label>
                                     <!-- This field will be auto-filled -->
                                     <input type="text" id="work-order" name="workOrder" class="form-control" placeholder="Work Order (Auto-filled)" readonly>
                                 </div>
                             </div>
                             <div class="form-field">
                                 <label for="project-name">PROJECT NAME:</label>
                                 <!-- This field will be auto-filled -->
                                 <input type="text" id="project-name" name="projectName" class="form-control" placeholder="Project Name (Auto-filled)" readonly>
                             </div>
                             <div class="form-field">
                                 <label for="project-address">PROJECT ADDRESS:</label>
                                 <!-- This field will be auto-filled -->
                                 <input type="text" id="project-address" name="projectAddress" class="form-control" placeholder="Project Address (Auto-filled)" readonly>
                             </div>
                         </div>
                         <div class="divider"></div>
                         <!-- Section 2: Shipper/Contact -->
                         <div class="form-section">
                             <div class="row">
                                 <div class="col-md-6"><div class="fixed-info"><p><strong>SHIPPER / FROM:</strong><br>DESA Glass<br>285079 Bluegrass Drive<br>Rocky View, AB T1X 0P5 Canada</p></div></div>
                                 <div class="col-md-6"><div class="fixed-info"><p><strong>CONTACT:</strong><br>Phone: 403.230.5011<br>Toll Free: 1.877.508.3965</p></div></div>
                             </div>
                         </div>
                         <!-- Section 3: Delivery Info -->
                         <div class="form-section">
                             <div class="section-title">DELIVERY INFORMATION</div>
                             <div class="form-row">
                                 <div class="form-field">
                                     <label for="requested-by">REQUESTED BY:</label>
                                     <input type="text" id="requested-by" name="requestedBy" class="form-control" placeholder="Name of person requesting">
                                 </div>
                                  <div class="form-field">
                                     <label for="carrier">CARRIER:</label>
                                     <input type="text" id="carrier" name="carrier" class="form-control" placeholder="Shipping Company Name">
                                 </div>
                             </div>
                         </div>
                         <!-- Section 4: Consignee -->
                         <div class="form-section">
                             <div class="section-title">CONSIGNEE DETAILS</div>
                            <div class="form-field">
                                 <label for="consignee">CONSIGNEE / TO:</label>
                                 <input type="text" id="consignee" name="consignee" class="form-control" placeholder="Receiving Company or Person">
                             </div>
                             <div class="form-field">
                                 <label for="consignee-address">DELIVERY ADDRESS:</label>
                                 <!-- This field will be auto-filled -->
                                 <input type="text" id="consignee-address" name="consigneeAddress" class="form-control" placeholder="Delivery Address (Auto-filled)">
                             </div>
                             <div class="form-row">
                                 <div class="form-field">
                                     <label for="site-contact">SITE CONTACT:</label>
                                     <!-- This field will be auto-filled -->
                                     <input type="text" id="site-contact" name="siteContact" class="form-control" placeholder="Site Contact (Auto-filled)">
                                 </div>
                                 <div class="form-field">
                                     <label for="site-phone">SITE PHONE:</label>
                                     <!-- This field will be auto-filled -->
                                     <input type="tel" id="site-phone" name="sitePhone" class="form-control" pattern="[0-9]{3}-?[0-9]{3}-?[0-9]{4}" placeholder="Site Phone (Auto-filled)">
                                 </div>
                             </div>
                         </div>
                         <!-- Section 5: Confirmation -->
                         <div class="form-section">
                             <div class="section-title">SHIPMENT CONFIRMATION</div>
                            <div class="form-row">
                                 <div class="form-field">
                                     <label for="delivery-date">ACTUAL DELIVERY DATE:</label>
                                     <input type="date" id="delivery-date" name="deliveryDate" class="form-control">
                                 </div>
                                 <div class="form-field">
                                     <label for="packaged-by">PACKAGED BY:</label>
                                     <input type="text" id="packaged-by" name="packagedBy" class="form-control" placeholder="Initials or Name">
                                 </div>
                             </div>
                             <div class="form-field">
                                 <label for="checked-by">LOADED BY (LOADER):</label>
                                 <input type="text" id="checked-by" name="checkedBy" class="form-control" placeholder="Initials or Name">
                             </div>
                         </div>
                         <!-- Section 6: Signature -->
                         <div class="signature-area">
                            <div class="form-field">
                                 <label for="received-by" class="required">DRIVER BY (PRINT NAME):</label>
                                 <input type="text" id="received-by" name="receivedBy" class="form-control" placeholder="Print Name of Receiver" required>
                                 <div class="invalid-feedback">Driver's printed name is required.</div>
                             </div>
                             <div style="margin-top: 20px;">
                                 <label class="required">DRIVER SIGNATURE:</label>
                                 <div class="signature-container">
                                     <canvas id="signature-pad"></canvas>
                                 </div>
                                 <button type="button" class="signature-clear no-print"><i class="fas fa-eraser"></i> Clear Signature</button>
                                 <div class="signature-required-error" id="signature-error">Signature is required for completion.</div>
                             </div>
                         </div>

                         <!-- Save Status -->
                         <div class="save-status no-print" id="save-status"></div>

                         <!-- Hidden Print Section -->
                         <div id="printTruckInfo" style="display: none;">
                             <h3 class="print-section-title">Load Details</h3>
                             <h4 class="print-section-subtitle">Truck Information</h4>
                             <p><strong>Truck ID:</strong> <span id="printTruckId"></span></p>
                             <p class="project-info"><strong>Project:</strong> <span id="printProject">N/A</span></p>
                             <p><strong>Dimensions:</strong> <span id="printTruckDimensions"></span></p>
                             <p><strong>Weight Capacity:</strong> <span id="printTruckWeight"></span> lbs</p>
                             <h4 class="print-section-subtitle">Skid Details (<span id="printTotalSkids"></span> Total)</h4>
                             <table class="print-skids-table">
                                 <thead><tr><th>Skid #</th><!-- CHANGED LABEL --><th>Width (ft)</th><th>Length (ft)</th><th>Weight (lbs)</th><th>Description</th></tr></thead>
                                 <tbody id="printSkidsBody"></tbody>
                                 <tfoot><tr style="font-weight: bold;"><td colspan="3" style="text-align: right;">Total Weight:</td><td id="printTotalWeight"></td><td></td></tr></tfoot>
                             </table>
                             <div id="printLoadingSummary"></div>
                         </div>
                     </form> <!-- End Packing List Form -->
                 </div> <!-- End document-container -->

                 <!-- Packing List Action Buttons -->
                <div class="packing-action-buttons no-print">
                     <button type="button" class="btn btn-secondary" onclick="goBackToSkidDetails()"><i class="fas fa-arrow-left"></i> Back to Skid Details</button>
                     <button id="resetPackingListBtn" type="button" class="btn btn-cancel">
                         <i class="fas fa-undo"></i> Reset Form
                     </button>
                     <button type="button" class="btn btn-print" id="printPackingListBtn"><i class="fas fa-print"></i> Print Packing List</button>
                     <button type="button" class="btn btn-primary" id="saveProgressBtn"><i class="fas fa-save"></i> Save Progress</button>
                     <button type="button" class="btn btn-success" onclick="completePackingList()"><i class="fas fa-check-circle"></i> Mark as Complete & Save</button>
                 </div>
            </div> <!-- End packingListPage -->

        </div> <!-- End content -->
    </div> <!-- End container -->

    <!-- === Reusable Skid Form HTML Template === -->
    <template id="skidFormTemplate">
        <!-- Title will be added dynamically by JS -->
        <form class="add-skid-form" novalidate> <!-- Use class for easier selection -->
            <input type="hidden" class="edit-skid-index">
            <input type="hidden" class="skid-context"> <!-- 'inventory' or 'truck' -->
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="skidWidth" class="form-label required">Width <span class="unit-label">(ft)</span></label>
                        <div class="input-group">
                            <input type="number" class="form-control skid-width" min="0.1" max="40" step="0.01" required placeholder="e.g., 4">
                            <span class="input-group-text">ft</span>
                        </div>
                        <div class="invalid-feedback">Please enter a valid width (0.1-40).</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="skidLength" class="form-label required">Length <span class="unit-label">(ft)</span></label>
                        <div class="input-group">
                            <input type="number" class="form-control skid-length" min="0.1" max="40" step="0.01" required placeholder="e.g., 4">
                            <span class="input-group-text">ft</span>
                        </div>
                         <div class="invalid-feedback">Please enter a valid length (0.1-40).</div>
                    </div>
                </div>
                <div class="col-md-3">
                     <div class="form-group">
                        <label for="skidWeight" class="form-label required">Weight <span class="unit-label">(lbs)</span></label>
                        <div class="input-group">
                            <input type="number" class="form-control skid-weight" min="1" required placeholder="e.g., 500">
                            <span class="input-group-text">lbs</span>
                        </div>
                         <div class="invalid-feedback">Please enter a valid weight (min 1).</div>
                    </div>
                </div>
                <div class="col-md-3">
                     <div class="form-group">
                        <label for="skidDescription" class="form-label">Description</label>
                        <textarea class="form-control skid-description" placeholder="Type description here..." rows="3"></textarea>
                        <!-- No validation needed -->
                     </div>
                </div>
            </div>
            <div class="button-group">
                <button type="button" class="btn btn-secondary cancel-skid-btn" onclick="hideAddEditSkidForm()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" class="btn btn-primary save-skid-btn">
                   {/* Text set by JS */}
                </button>
            </div>
        </form>
    </template>
    <!-- === END Template === -->


    <!-- Load JS Libraries (jQuery must come before Select2) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Main Application Script -->
    <script>
        // --- State Variables ---
        let appState = {
            currentPage: 'jobSelectionPage',
            inventory: { selectedProject: null, skids: {}, nextSkidId: {} },
            truckLoad: { truckInfo: { id: '', project: null, length: null, width: null, weight: null }, skids: [], nextSkidId: 1, packingList: {}, signatureData: null },
            _selectedJobType: null
        };
        let signaturePad;
        let saveTimeout;
        const APP_STATE_KEY = 'desaWorkflowData_v5'; // Incremented version for new project data structure

        // === NEW COMPREHENSIVE PROJECT DATA (Replaces PROJECT_OPTIONS) ===
        // Data manually correlated from the provided OCR pages.
        // 'value' is typically the Work Order No. for uniqueness.
        // 'text' is the display text in the dropdown.
        // Other fields are for auto-population.
        // !!! IMPORTANT: YOU MUST COMPLETE THIS ARRAY WITH ALL DATA FROM YOUR PDF !!!
        const PROJECT_DATA = [
            { value: "47603", text: "1900 West - Serina Homes (WO: 47603)", projectName: "1900 West", projectAddress: "Serina Homes", workOrder: "47603", deliveryAddress: "3350-19 Street SW, Calgary", siteContact: "Kurtis Meddins", sitePhone: "403-483-3593" },
            { value: "47749", text: "45 Series Stock Material - Chinook Glass & Screen Ltd. (WO: 47749)", projectName: "45 Series Stock Material", projectAddress: "Chinook Glass & Screen Ltd.", workOrder: "47749", deliveryAddress: "321-16th Avenue NW, T2M 0H9", siteContact: null, sitePhone: null },
            { value: "47754", text: "45HP Caps DQ#34388 - CP Distributors Ltd. (WO: 47754)", projectName: "45HP Caps DQ#34388", projectAddress: "CP Distributors Ltd.", workOrder: "47754", deliveryAddress: "120-4550 25th Street Calgary, Alberta T2B 3P1", siteContact: null, sitePhone: null },
            { value: "47643", text: "Accurate - Economy Glass (WO: 47643)", projectName: "Accurate", projectAddress: "Economy Glass", workOrder: "47643", deliveryAddress: "101-17th Avenue SW Calgary T2S OA1", siteContact: "Cris", sitePhone: null }, // WO also used by Insta-Source
            { value: "47684", text: "Alberta Health - Chinook Glass (WO: 47684)", projectName: "Alberta Health", projectAddress: "Chinook Glass", workOrder: "47684", deliveryAddress: "Calgary Alberta", siteContact: null, sitePhone: null },
            { value: "47765", text: "All Kind Glass DQ#34420 - Miscellaneous -Supply Only (WO: 47765)", projectName: "All Kind Glass DQ#34420", projectAddress: "Miscellaneous -Supply Only", workOrder: "47765", deliveryAddress: null, siteContact: null, sitePhone: null },
            { value: "47663", text: "Aluminum Panel - Diamond Glass (WO: 47663)", projectName: "Aluminum Panel", projectAddress: "Diamond Glass", workOrder: "47663", deliveryAddress: "805 Main St S #2, Airdrie, AB T4B 3M1", siteContact: "James", sitePhone: "780-984-5413" },
            { value: "47112", text: "AMUFL - Cana Construction (WO: 47112)", projectName: "AMUFL", projectAddress: "Cana Construction", workOrder: "47112", deliveryAddress: null, siteContact: null, sitePhone: null },
             { value: "N/A-AntiRolls", text: "Anti Rolls Beige - N/A", projectName: "Anti Rolls Beige", projectAddress: null, workOrder: null, deliveryAddress: null, siteContact: null, sitePhone: null }, // No WO
            { value: "47316", text: "Blood Tribe Recovery Communi - Synergy Builds (WO: 47316)", projectName: "Blood Tribe Recovery Communi", projectAddress: "Synergy Builds", workOrder: "47316", deliveryAddress: "1 Ave W and 1 Ave, Cardston, AB", siteContact: "Chris Hall", sitePhone: "587-897-4277" },
            { value: "45834", text: "Burnaby Hospital - Thermal System (WO: 45834)", projectName: "Burnaby Hospital", projectAddress: "Thermal System", workOrder: "45834", deliveryAddress: "3395 KINCAID STREET, BURNABY, BC V5G 2X6", siteContact: "Alex Babkov", sitePhone: "403-483-0043" }, // Adjusted postcode based on context
            { value: "46870", text: "Calgary Go Auto & RV - Synergy Builds (WO: 46870)", projectName: "Calgary Go Auto & RV", projectAddress: "Synergy Builds", workOrder: "46870", deliveryAddress: "2505 Country Hills Boulevard NE", siteContact: "Brady", sitePhone: "587-335-8593" },
            { value: "47690", text: "Capital City - Capital City (WO: 47690)", projectName: "Capital City", projectAddress: "Capital City", workOrder: "47690", deliveryAddress: "10735 184 Street NW Edmonton, Alberta T5S 2W6", siteContact: "Ace Courier", sitePhone: null }, // Assumed postcode
            { value: "47662", text: "Carpi 45HP DQ#34034 Hepting - Miscellaneous-Supply Only (WO: 47662)", projectName: "Carpi 45HP DQ#34034 Hepting", projectAddress: "Miscellaneous-Supply Only", workOrder: "47662", deliveryAddress: "1145 F Rose ST, Regina SK", siteContact: "Hepting Glass", sitePhone: "306-775-1770" },
            { value: "47716", text: "Castaways DQ#34206 - South Hill Windoews & Awning Ltd (WO: 47716)", projectName: "Castaways DQ#34206", projectAddress: "South Hill Windoews & Awning Ltd", workOrder: "47716", deliveryAddress: "100,153 Clearmile Avenue Red Deer, Alberta", siteContact: "Melissa J Bartherson", sitePhone: "403-347-9320" },
            { value: "46317", text: "CC4 - Lark (WO: 46317)", projectName: "CC4", projectAddress: "Lark", workOrder: "46317", deliveryAddress: "3851 23NE Calgary, AB T2E6T2", siteContact: "Morgan Janzen", sitePhone: "403-629-9244" }, // WO shared by multiple projects
            { value: "47075", text: "CCCBL - CANA Construction (WO: 47075)", projectName: "CCCBL", projectAddress: "CANA Construction", workOrder: "47075", deliveryAddress: "6088 University Boulevard, Vancouver BC", siteContact: "Alex", sitePhone: "403-483-0043" },
            { value: "47666", text: "Cellar Room - Holbie's Glass Ltd. (WO: 47666)", projectName: "Cellar Room", projectAddress: "Holbie's Glass Ltd.", workOrder: "47666", deliveryAddress: "Box 8, Killam Alberta, TOB2L0", siteContact: "Darrin Holbie", sitePhone: "7803853664" },
            { value: "46998", text: "Chinook Feeders - Westco Construction (WO: 46998)", projectName: "Chinook Feeders", projectAddress: "Westco Construction", workOrder: "46998", deliveryAddress: "near the corner of Township Road 172 and Range Road 272 Foothills County, Alberta", siteContact: "Cris Hall", sitePhone: "587-897-4277" }, // WO 46317 also listed? Using 46998 from OCR row.
            { value: "46317-CityCentre", text: "City Centre - Lark (WO: 46317)", projectName: "City Centre", projectAddress: "Lark", workOrder: "46317", deliveryAddress: "9686 137 Street, Surrey, BC", siteContact: "Seth Gowda, Jordan Fuger", sitePhone: "236-268-4474, 204-881-3231" }, // Reusing 46317, added suffix
            { value: "47508", text: "Imperial Group - Wii Projects (WO: 47508)", projectName: "Imperial Group", projectAddress: "Wii Projects", workOrder: "47508", deliveryAddress: "3808 - 7 Street SE, Calgary", siteContact: "Kurtis", sitePhone: "403-483-3593" },
            { value: "47103", text: "Currie Barracks Bldg. 2 - Rohit Group (WO: 47103)", projectName: "Currie Barracks Bldg. 2", projectAddress: "Rohit Group", workOrder: "47103", deliveryAddress: "330 Dieppe Drive SW, Calgary, AB", siteContact: "Sergii Petr", sitePhone: "587-700-6741 / 587-966-4682" },
            { value: "47691", text: "Dairy Queen Memorial Dr.NE D - Chinook Glass & Screen Ltd. (WO: 47691)", projectName: "Dairy Queen Memorial Dr.NE D", projectAddress: "Chinook Glass & Screen Ltd.", workOrder: "47691", deliveryAddress: "321-16 th Avenue NW Calgary Alberta T2M 0H9", siteContact: null, sitePhone: null }, // Assuming same Chinook address
            { value: "47658", text: "Element Hotel - Archicon (WO: 47658)", projectName: "Element Hotel", projectAddress: "Archicon", workOrder: "47658", deliveryAddress: "833 4th Ave. SW, Calgary, AB", siteContact: "Kurtis", sitePhone: "403-483-3593" },
            { value: "47584", text: "Element Hotel  Skip Hoist Repl - Archicon (WO: 47584)", projectName: "Element Hotel  Skip Hoist Repl", projectAddress: "Archicon", workOrder: "47584", deliveryAddress: "833 4th Ave. SW, Calgary AB", siteContact: "Xavier", sitePhone: "403.542.2155" },
            { value: "46781", text: "EV606 Podium - Q Construction (WO: 46781)", projectName: "EV606 Podium", projectAddress: "Q Construction", workOrder: "46781", deliveryAddress: "606 Confluence Way SE Calgary, AB", siteContact: "Jordan", sitePhone: "403-891-6878" },
            { value: "47054", text: "Feyter STS Forma Steel - Westco Construction (WO: 47054)", projectName: "Feyter STS Forma Steel", projectAddress: "Westco Construction", workOrder: "47054", deliveryAddress: "20 Barracks Trail, Fort Macleod, AB", siteContact: "Cris", sitePhone: "587-897-4277" },
            { value: "47513", text: "Glasier Redge - Ledcor (WO: 47513)", projectName: "Glasier Redge", projectAddress: "Ledcor", workOrder: "47513", deliveryAddress: "146 Edith Drive NW, Calgary", siteContact: "Jim", sitePhone: "403-510-2880" },
            { value: "47472", text: "Glenmore Temple - Carlson (WO: 47472)", projectName: "Glenmore Temple", projectAddress: "Carlson", workOrder: "47472", deliveryAddress: "68 Ave DW #921 Calgary T2V ON7", siteContact: null, sitePhone: null },
            { value: "47274", text: "Greystone Coop - CANA Construction (WO: 47274)", projectName: "Greystone Coop", projectAddress: "CANA Construction", workOrder: "47274", deliveryAddress: "264 Park Street Cochrane, Alberta", siteContact: "Roberto", sitePhone: "403-973-1987" },
            { value: "47688", text: "Griffin Glass - Griffin Glass (WO: 47688)", projectName: "Griffin Glass", projectAddress: "Griffin Glass", workOrder: "47688", deliveryAddress: "1307 Hasting Crescent SE, T2G 4C8", siteContact: "Dave", sitePhone: null },
            { value: "N/A-Hampton", text: "Hampton Inn - N/A", projectName: "Hampton Inn", projectAddress: null, workOrder: null, deliveryAddress: "Calgary, AB", siteContact: "Andy", sitePhone: null }, // No WO
            { value: "47685", text: "Independent Glass Contracting - Independent Glass Contracting (WO: 47685)", projectName: "Independent Glass Contracting", projectAddress: "Independent Glass Contracting", workOrder: "47685", deliveryAddress: "109 Cheecham Crt Anzac, AB TOP1JO, Canad", siteContact: "Chad Rithcie", sitePhone: "780-334-1060" },
            { value: "47657", text: "Insight Glazing - Insight Glazing (WO: 47657)", projectName: "Insight Glazing", projectAddress: "Insight Glazing", workOrder: "47657", deliveryAddress: "101-17th Avenue SW Calgary T2S 0A1", siteContact: "Cris", sitePhone: null }, // Same addr as Accurate?
            { value: "47700", text: "Insta-Source DQ#34033 - Economy Glass (WO: 47700)", projectName: "Insta-Source DQ#34033", projectAddress: "Economy Glass", workOrder: "47700", deliveryAddress: "701-30th Street NE, Calgary Alberta T2A 5L7", siteContact: null, sitePhone: null },
             { value: "46317-JIT-NE", text: "JIT North East - JIT (WO: 46317)", projectName: "JIT North East", projectAddress: "JIT", workOrder: "46317", deliveryAddress: "7815 46St. SE", siteContact: null, sitePhone: null }, // Shared WO
            { value: "47119", text: "JIT South East - JIT (WO: 47119)", projectName: "JIT South East", projectAddress: "JIT", workOrder: "47119", deliveryAddress: "#1 220 Avro Lane", siteContact: "Jim", sitePhone: "403-880-8392" }, // Shared WO with Mercury Block II
            { value: "47744", text: "JS Aircraft Hanger - Jim Sibthorpe (WO: 47744)", projectName: "JS Aircraft Hanger", projectAddress: "Jim Sibthorpe", workOrder: "47744", deliveryAddress: "114-25 Belich Crescent Red Deer Counrty, Al", siteContact: "Kevin Taylor", sitePhone: "403-597-5374" },
            { value: "47738", text: "Kikinow Door Adapror Cap - Central Alberta Windowa (WO: 47738)", projectName: "Kikinow Door Adapror Cap", projectAddress: "Central Alberta Windowa", workOrder: "47738", deliveryAddress: "10729-101 Street NW, Edmonton", siteContact: "Amber", sitePhone: "780-2985325" },
            { value: "46917", text: "King's Thunderbird - Chandos (WO: 46917)", projectName: "King's Thunderbird", projectAddress: "Chandos", workOrder: "46917", deliveryAddress: "114-25 Belich Crescent Red Deer Counrty, Al", siteContact: "Kevin Taylor", sitePhone: "403-597-5374" },
            { value: "47743", text: "Kodiak Astragal - Central Alberta Windowa (WO: 47743)", projectName: "Kodiak Astragal", projectAddress: "Central Alberta Windowa", workOrder: "47743", deliveryAddress: "114-25 Belich Crescent Red Deer Counrty, Al", siteContact: "Kevin Taylor", sitePhone: "403-597-5374" },
            { value: "47648", text: "Kodiak DQ#33998 - Central Alberta Windowa (WO: 47648)", projectName: "Kodiak DQ#33998", projectAddress: "Central Alberta Windowa", workOrder: "47648", deliveryAddress: "114-25 Belich Crescent Red Deer Counrty, Alberta T4S 2K5", siteContact: null, sitePhone: null },
            { value: "47752", text: "Kodiak DQ34395 - Central Alberta Windowa (WO: 47752)", projectName: "Kodiak DQ34395", projectAddress: "Central Alberta Windowa", workOrder: "47752", deliveryAddress: "Unit 14, 2305-52nd Avenue SE", siteContact: "Mathew", sitePhone: "'403-244-3283" },
            { value: "47682", text: "Lemon Garden Aluminium DQ#3 - Bennett Glass (WO: 47682)", projectName: "Lemon Garden Aluminium DQ#3", projectAddress: "Bennett Glass", workOrder: "47682", deliveryAddress: "8188 & 8250 Manitoba Street, Vancouver", siteContact: "Alex", sitePhone: "403-483-0043" },
            { value: "45615", text: "Marine Landing - Ventana (WO: 45615)", projectName: "Marine Landing", projectAddress: "Ventana", workOrder: "45615", deliveryAddress: "6088 University Boulevard, Vancouver BC", siteContact: "Alex", sitePhone: "403-483-0043" }, // See also specific lines for this WO
            { value: "45615-MarineLanding", text: "Marine Landing (Detail) - Ventana (WO: 45615)", projectName: "Marine Landing", projectAddress: "Ventana", workOrder: "45615", deliveryAddress: "6088 University Boulevard, Vancouver BC", siteContact: "Alex", sitePhone: "403-483-0043" },
            { value: "45834-Burnaby", text: "Marine Landing Burnaby - Thermal Systems (WO: 45834)", projectName: "Marine Landing Burnaby", projectAddress: "Thermal Systems", workOrder: "45834", deliveryAddress: "3395 KINCAID STREET, BURNABY, BC V5G 2X6", siteContact: "Alex Babkov", sitePhone: "403-483-0043" }, // Assumed same details as Burnaby Hosp
            { value: "46317-CC4", text: "Marine Landing CC4 - Lark (WO: 46317)", projectName: "Marine Landing CC4", projectAddress: "Lark", workOrder: "46317", deliveryAddress: "3851 23NE Calgary, AB T2E6T2", siteContact: "Morgan Janzen", sitePhone: "403-629-9244" }, // Assumed same details as CC4
            { value: "47611", text: "Mary Brow's-Tim Hortons DQ#3 - Central Alberta Windowa (WO: 47611)", projectName: "Mary Brow's-Tim Hortons DQ#3", projectAddress: "Central Alberta Windowa", workOrder: "47611", deliveryAddress: "114-25 Belich Crescent Red Deer Counrty, Al", siteContact: "Kevin Taylor", sitePhone: "403-597-5374" },
            { value: "47705", text: "Mayfair Place DQ#34186 - All Kind Door Services Ltd. (WO: 47705)", projectName: "Mayfair Place DQ#34186", projectAddress: "All Kind Door Services Ltd.", workOrder: "47705", deliveryAddress: "1455-34th Avenue SE Calgary, Alberta T2G 4", siteContact: "Doug Watson", sitePhone: "403-266-1411" },
            { value: "47077", text: "Meadow Vista Bldg. 3000 - Brad Remington (WO: 47077)", projectName: "Meadow Vista Bldg. 3000", projectAddress: "Brad Remington", workOrder: "47077", deliveryAddress: "Calgary, AB T2X 4K9", siteContact: "Jaden", sitePhone: null },
            { value: "47119-Mercury", text: "Mercury Block II - Cana Construction (WO: 47119)", projectName: "Mercury Block II", projectAddress: "Cana Construction", workOrder: "47119", deliveryAddress: "10146-123 STREET NW, EDMONTON, ALBER", siteContact: "Leigh Puder", sitePhone: "780-667-9291" }, // Shared WO
            { value: "47732", text: "Miscellaneous - Supply Only - DNO Glass (WO: 47732)", projectName: "Miscellaneous - Supply Only", projectAddress: "DNO Glass", workOrder: "47732", deliveryAddress: "Calgary Alberta", siteContact: null, sitePhone: null },
            { value: "47727", text: "Miscellaneous Supply Only - Independent Glass Contracting (WO: 47727)", projectName: "Miscellaneous Supply Only", projectAddress: "Independent Glass Contracting", workOrder: "47727", deliveryAddress: "Calgary, alberta", siteContact: "Derik", sitePhone: null },
            { value: "47358", text: "Myne BLDG 1000 - Truman Homes (WO: 47358)", projectName: "Myne BLDG 1000", projectAddress: "Truman Homes", workOrder: "47358", deliveryAddress: "#1000, 63 CORNER GLEN CR NE LOT 1 BLOC", siteContact: "Kurtis", sitePhone: "403-483-3593" },
            { value: "47601", text: "NAPEG - Diamond Glass (WO: 47601)", projectName: "NAPEG", projectAddress: "Diamond Glass", workOrder: "47601", deliveryAddress: "PO Box 1645, 329 Old Airport Road", siteContact: "Bryan Rendell", sitePhone: "867-873-9178" },
            { value: "47672", text: "New Shop Windows - Chinook Glass (WO: 47672)", projectName: "New Shop Windows", projectAddress: "Chinook Glass", workOrder: "47672", deliveryAddress: "321-16th Avenue NW, T2M 0H9", siteContact: "Lorry Roy", sitePhone: null },
            { value: "47709", text: "Noble Ground DQ#33871 - Chinook Glass & Screen Ltd. (WO: 47709)", projectName: "Noble Ground DQ#33871", projectAddress: "Chinook Glass & Screen Ltd.", workOrder: "47709", deliveryAddress: "321-16th Avenue NW Calgary, Alberta T2M", siteContact: "Lorry Roy", sitePhone: null },
            { value: "47623", text: "Noble Grounds Down Town - Chinook Glass (WO: 47623)", projectName: "Noble Grounds Down Town", projectAddress: "Chinook Glass", workOrder: "47623", deliveryAddress: "321-16th Avenue NW, T2M 0H9", siteContact: "Ken Smith", sitePhone: null },
            { value: "46918", text: "Pacific Reach - Q Construction (WO: 46918)", projectName: "Pacific Reach", projectAddress: "Q Construction", workOrder: "46918", deliveryAddress: "521 3 Ave SW, Calgary, AB T2P 3T3", siteContact: "Mike Legal", sitePhone: "403-481-6412" },
            { value: "4677", text: "Paul Davis- Sims Olds - South Hill Windows (WO: 4677)", projectName: "Paul Davis- Sims Olds", projectAddress: "South Hill Windows", workOrder: "4677", deliveryAddress: "100, 153 Clearmile Avenue Red Deer County", siteContact: "Dave", sitePhone: null }, // Pg 7
            { value: "NA-Peak", text: "Peak Landmark LTD - Peak Landmark LTD (WO: NA)", projectName: "Peak Landmark LTD", projectAddress: "Peak Landmark LTD", workOrder: "NA", deliveryAddress: "4436-90TH AVE SE, CALGARY, AB T2C 2S7", siteContact: "Leo", sitePhone: "587-893-6464" },
            { value: "47578", text: "Place 800 - Desa Install (WO: 47578)", projectName: "Place 800", projectAddress: "Desa Install", workOrder: "47578", deliveryAddress: "800 6 Ave SW, Calgary, AB T2P 3G3", siteContact: "Tom", sitePhone: null },
            { value: "47369", text: "Podium Bldg. F - Deveraux (WO: 47369)", projectName: "Podium Bldg. F", projectAddress: "Deveraux", workOrder: "47369", deliveryAddress: "8620 CANADA OLYMPIC DRIVE SW", siteContact: "James", sitePhone: "780-984-5413" },
            { value: "47536", text: "Port o Call Phase 1 & 2 - South Hill Windows (WO: 47536)", projectName: "Port o Call Phase 1 & 2", projectAddress: "South Hill Windows", workOrder: "47536", deliveryAddress: "100, 153 Clearmile Avenue Red Deer County", siteContact: "Dave", sitePhone: null }, // Assumed same address as Paul Davis
            { value: "47670", text: "Precision Builders - Chinook Glass (WO: 47670)", projectName: "Precision Builders", projectAddress: "Chinook Glass", workOrder: "47670", deliveryAddress: "321-16th Avenue NW, T2M 0H9", siteContact: "Ken Smith", sitePhone: null }, // Assumed Chinook Address
            { value: "NA-Rimac", text: "Rimac Fabricators Ltd - Rimac Fabricators Ltd (WO: NA)", projectName: "Rimac Fabricators Ltd", projectAddress: "Rimac Fabricators Ltd", workOrder: null, deliveryAddress: "265 Applewood Crescent, Concord Ontario,", siteContact: "Nick Theodoropolous", sitePhone: "905-669-6963 ext. 102" },
            { value: "46954", text: "Royal BC Museum - Maple Reinders (WO: 46954)", projectName: "Royal BC Museum", projectAddress: "Maple Reinders", workOrder: "46954", deliveryAddress: "3608 Ryder Hesjedal Way Coldwood, BC V9", siteContact: "Alex", sitePhone: "403-483-0043" },
            { value: "47368", text: "Sage Hill Estates - Spray Group (WO: 47368)", projectName: "Sage Hill Estates", projectAddress: "Spray Group", workOrder: "47368", deliveryAddress: "30 Sage Hill Row NW, Calgary", siteContact: "Adam/Jordan", sitePhone: "403-408-9277/403-805-3925" },
            { value: "47342", text: "Save on Food - Laurin Group (WO: 47342)", projectName: "Save on Food", projectAddress: "Laurin Group", workOrder: "47342", deliveryAddress: "NA'A Drive SW, Calgary AB T2E 7G9", siteContact: "Kurtis", sitePhone: "403.483.3593" },
            { value: "47026", text: "Seton Market - Ledcor (WO: 47026)", projectName: "Seton Market", projectAddress: "Ledcor", workOrder: "47026", deliveryAddress: "3815 Front St SE #125 Calgary.", siteContact: "Brendan Mark", sitePhone: "403-827-5628 / 403-466-1817" },
            { value: "47641", text: "Slider Door - Griffin Glass (WO: 47641)", projectName: "Slider Door", projectAddress: "Griffin Glass", workOrder: "47641", deliveryAddress: "1307 Hasting Crescent SE, T2G 4C8", siteContact: "Dave", sitePhone: null }, // Assumed Griffin address
            { value: "47659", text: "South Hill (47659,...) - South Hill Windows (WO: 47659)", projectName: "South Hill (Multiple WOs)", projectAddress: "South Hill Windows", workOrder: "47659, 47725, 47724, 47726, 47729", deliveryAddress: "100, 153 Clearmile Avenue Red Deer County", siteContact: "Dave", sitePhone: null }, // Combined multi-WO entry
            { value: "47587", text: "St. Mary Church - South Hill Windows (WO: 47587)", projectName: "St. Mary Church", projectAddress: "South Hill Windows", workOrder: "47587", deliveryAddress: "100, 153 Clearmile Avenue Red Deer County", siteContact: "Dave", sitePhone: null },
            { value: "47597", text: "St. Mary's Church DG#33860 - South Hill Windoews & Awning Ltd. (WO: 47597)", projectName: "St. Mary's Church DG#33860", projectAddress: "South Hill Windoews & Awning Ltd.", workOrder: "47597", deliveryAddress: "114-25 Belich Crescent Red Deer Counrty, Alberta T4S 2K5", siteContact: null, sitePhone: null }, // Assumed address based on other South Hill Awning
            { value: "47681", text: "State & Main DQ#34043 - Central Alberta Windowa (WO: 47681)", projectName: "State & Main DQ#34043", projectAddress: "Central Alberta Windowa", workOrder: "47681", deliveryAddress: "1455-34th Avenue SE Calgary, Alberta T", siteContact: "Doug Watson", sitePhone: "403-266-1411" }, // Matched based on Doug Watson
            { value: "47764", text: "Stock 12\" Pull Handle - All Kind Door Services Ltd. (WO: 47764)", projectName: "Stock 12\" Pull Handle", projectAddress: "All Kind Door Services Ltd.", workOrder: "47764", deliveryAddress: "860 Rutherford Road Maple, Ontario L6A 1", siteContact: "Nadia", sitePhone: "(289) 276-6077" },
            { value: "47730", text: "Stock DQ#34323 - Abtek Door Services Ltd. (WO: 47730)", projectName: "Stock DQ#34323", projectAddress: "Abtek Door Services Ltd.", workOrder: "47730", deliveryAddress: "100,153 Clearmile Avenue Red Deer, Alberta", siteContact: "Melissa J Bartherson", sitePhone: "403-347-9320" },
            { value: "47741", text: "Stock Handles & Covers - South Hill Windows & Awning Ltd. (WO: 47741)", projectName: "Stock Handles & 3 3/4 Cover Ca", projectAddress: "South Hill Windows & Awning Ltd.", workOrder: "47741", deliveryAddress: "100,153 Clearmile Avenue Red Deer, Alberta", siteContact: "Melissa J Bartherson", sitePhone: "403-347-9320" }, // Combined handle entries
            { value: "47718", text: "Stock Hardware - Griffin Glass (WO: 47718)", projectName: "Stock Hardware", projectAddress: "Griffin Glass", workOrder: "47718", deliveryAddress: "1307 Hasting Crescent SE, T2G 4C8", siteContact: "Matt", sitePhone: null }, // Assumed Griffin addr
            { value: "47736", text: "Stock Hardware DQ#34319 - CP Distributors Ltd. (WO: 47736)", projectName: "Stock Hardware DQ#34319", projectAddress: "CP Distributors Ltd.", workOrder: "47736", deliveryAddress: "120-4550 25th Street Calgary Alberta", siteContact: null, sitePhone: null }, // Assumed CP Dist addr
            { value: "47751", text: "Stock Hardware DQ#34393 - Independent Glass Contracting (WO: 47751)", projectName: "Stock Hardware DQ#34393", projectAddress: "Independent Glass Contracting", workOrder: "47751", deliveryAddress: "Unit#2-701 30th Street NE Calgary AB T2A 6A3", siteContact: null, sitePhone: null },
            { value: "47762", text: "Stock Hardware DQ#34417 - Capital Glass Brooks 2010 Ltd. (WO: 47762)", projectName: "Stock Hardware DQ#34417", projectAddress: "Capital Glass Brooks 2010 Ltd.", workOrder: "47762", deliveryAddress: "Box 1150, 824-2nd Street West Brooks, Albe", siteContact: "Corey Kristianson", sitePhone: "403-362-5531" },
            { value: "47733", text: "Stock Material DQ#34325 - Bennett Glass (WO: 47733)", projectName: "Stock Material DQ#34325", projectAddress: "Bennett Glass", workOrder: "47733", deliveryAddress: "Unit 14, 2305-52nd Avenue SE", siteContact: "Mathew", sitePhone: "403-244-3283" },
            { value: "47776", text: "Stock Material DQ#34459 - King's Glass Ltd. (WO: 47776)", projectName: "Stock Material DQ#34459", projectAddress: "King's Glass Ltd.", workOrder: "47776", deliveryAddress: "6320 Centre Street SE", siteContact: "Fred Denomme", sitePhone: "4032581798" },
            { value: "47766", text: "Stock Steel Angle DQ#34427 - South Hill Windoews & Awning Ltd. (WO: 47766)", projectName: "Stock Steel Angle DQ#34427", projectAddress: "South Hill Windoews & Awning Ltd.", workOrder: "47766", deliveryAddress: "100, 153 Clearmile Avenue Red Deer County", siteContact: "Dave", sitePhone: null }, // Assumed South Hill addr
            { value: "46999", text: "Teck Sparwood - Ellis Don (WO: 46999)", projectName: "Teck Sparwood", projectAddress: "Ellis Don", workOrder: "46999", deliveryAddress: "2202 Middletown Place Sparwood BC", siteContact: "Wyatt", sitePhone: "403-650-9789" },
            { value: "47687", text: "Terrigno - South Hill Windows (WO: 47687)", projectName: "Terrigno", projectAddress: "South Hill Windows", workOrder: "47687", deliveryAddress: "321-16th Avenue NW, T2M 0H9", siteContact: "Ken Smith", sitePhone: null }, // Assumed South Hill addr
            { value: "47723", text: "Thai Thai DQ#34266 - King's Glass Ltd. (WO: 47723)", projectName: "Thai Thai DQ#34266", projectAddress: "King's Glass Ltd.", workOrder: "47723", deliveryAddress: "6320 Centre Street SE", siteContact: "Fred Denomme", sitePhone: "4032581798" },
            { value: "47340", text: "The Gateway 3 Sister - Cana Construction (WO: 47340)", projectName: "The Gateway 3 Sister", projectAddress: "Cana Construction", workOrder: "47340", deliveryAddress: "Cascade Drive, Canmore, AB", siteContact: "Jordan", sitePhone: "403-891-6878" },
            { value: "47159", text: "The Loft - Maple Reinders (WO: 47159)", projectName: "The Loft", projectAddress: "Maple Reinders", workOrder: "47159", deliveryAddress: "744-4 Avenue SW Calgary, Alberta", siteContact: "Roberto", sitePhone: "403-973-1987" },
            { value: "47734", text: "Tim Horton's 17th Ave DQ#3433 - King's Glass Ltd. (WO: 47734)", projectName: "Tim Horton's 17th Ave DQ#3433", projectAddress: "King's Glass Ltd.", workOrder: "47734", deliveryAddress: "6320 Centre Street SE", siteContact: "Fred Denomme", sitePhone: "4032581798" },
            { value: "47712", text: "Trail Construction - Chinook Glass (WO: 47712)", projectName: "Trail Construction", projectAddress: "Chinook Glass", workOrder: "47712", deliveryAddress: "321-16th Avenue NW, T2M 0H9", siteContact: "Lorry Roy", sitePhone: null }, // Assumed Chinook Addr
            { value: "47109", text: "Trinity Hills - Laurin Group (WO: 47109)", projectName: "Trinity Hills", projectAddress: "Laurin Group", workOrder: "47109", deliveryAddress: "924 Na'a Drive SW, Calgary, Alberta", siteContact: "Morgan Janzen", sitePhone: "403-629-9244" },
            { value: "45621", text: "UBC-SBME - Ventana (WO: 45621)", projectName: "UBC-SBME", projectAddress: "Ventana", workOrder: "45621", deliveryAddress: "6088 University Boulevard, Vancouver, BC", siteContact: "Alex", sitePhone: "403-483-0043" },
            { value: "47303", text: "USAY Youth Center - Synergy Builds (WO: 47303)", projectName: "USAY Youth Center", projectAddress: "Synergy Builds", workOrder: "47303", deliveryAddress: "1715 - 36 Street SE, Calgary", siteContact: "Jordan", sitePhone: "403-891-6878" }, // Page 4 / Page 8 Match
            { value: "47290", text: "We Wai Kai - Ketza Pacific (WO: 47290)", projectName: "We Wai Kai", projectAddress: "Ketza Pacific", workOrder: "47290", deliveryAddress: "2025 Eagle Drive, Campbell River, BC V9H 1", siteContact: "Alex", sitePhone: "403-483-0043" }, // Page 4 / Page 8 Match
            { value: "47703", text: "Westbrook DQ#34210 - GQM Services (WO: 47703)", projectName: "Westbrook DQ#34210", projectAddress: "GQM Services", workOrder: "47703", deliveryAddress: "228 Mt.Cornwall Mews SE Calgary, Alberta T2Z 2J8", siteContact: null, sitePhone: null }, // Page 4 / Page 8 Match
            { value: "47566", text: "WSCC - Diamond Glass (WO: 47566)", projectName: "WSCC", projectAddress: "Diamond Glass", workOrder: "47566", deliveryAddress: "PO Box 1645, 329 Old Airport Road, Yellowk", siteContact: "Bryan Rendell", sitePhone: "867-873-9178" } // Page 4 / Page 8 Match

        ];
        // === END NEW PROJECT DATA ===


        // --- DOM Elements ---
        const jobSelectionPage = document.getElementById('jobSelectionPage');
        const projectSelectionPage = document.getElementById('projectSelectionPage');
        const inventoryPage = document.getElementById('inventoryPage');
        const truckInfoPage = document.getElementById('truckInfoPage');
        const skidDetailsPage = document.getElementById('skidDetailsPage');
        const packingListPage = document.getElementById('packingListPage');
        const jobTypeSelect = document.getElementById('jobTypeSelect');
        const proceedJobSelectionBtn = document.getElementById('proceedJobSelectionBtn');
        const projectSelectionTaskNameSpan = document.getElementById('projectSelectionTaskName');
        const mainProjectSelect = document.getElementById('mainProjectSelect');
        const mainProjectSelectErrorDiv = document.getElementById('mainProjectSelect-error');
        const proceedProjectSelectionBtn = document.getElementById('proceedProjectSelectionBtn');
        const projectSelectionProceedButtonTextSpan = document.getElementById('projectSelectionProceedButtonText');
        const inventoryPageProjectNameSpan = document.getElementById('inventoryPageProjectName');
        const inventoryProjectDisplaySpan = document.getElementById('inventoryProjectDisplay');
        const inventorySkidTableBody = document.getElementById('inventorySkidTableBody');
        const showAddInventorySkidBtn = document.getElementById('showAddInventorySkidBtn');
        const resetInventorySkidsBtn = document.getElementById('resetInventorySkidsBtn');
        const addInventorySkidFormContainer = document.getElementById('addInventorySkidFormContainer');
        const truckInfoPageProjectNameSpan = document.getElementById('truckInfoPageProjectName');
        const truckProjectDisplaySpan = document.getElementById('truckProjectDisplay');
        const truckInfoForm = document.getElementById('truckInfoForm');
        const truckIdentifierSpan = document.getElementById('truckIdentifier');
        const skidDetailsProjectNameSpan = document.getElementById('skidDetailsProjectName');
        const truckSizeDisplaySpan = document.getElementById('truckSizeDisplay');
        const truckSkidTableBody = document.getElementById('truckSkidTableBody');
        const totalTruckSkidCountSpan = document.getElementById('totalTruckSkidCount');
        const totalTruckSkidWeightSpan = document.getElementById('totalTruckSkidWeight');
        const loadingInstructionsDiv = document.getElementById('loadingInstructions');
        const addTruckSkidFormContainer = document.getElementById('addTruckSkidFormContainer');
        const inventorySkidSelectionContainer = document.getElementById('inventorySkidSelectionContainer');
        const inventorySkidSelectionBody = document.getElementById('inventorySkidSelectionBody');
        const addSelectedInventorySkidsBtn = document.getElementById('addSelectedInventorySkidsBtn');
        const packingListForm = document.getElementById('packing-list-form');
        const packingListTruckIdSpan = document.getElementById('packingListTruckId');
        const signatureCanvas = document.getElementById('signature-pad');
        const signatureErrorDiv = document.getElementById('signature-error');
        const saveStatusDiv = document.getElementById('save-status');
        const projectNameInput = document.getElementById('project-name'); // Packing list field
        const projectAddressInput = document.getElementById('project-address'); // Packing list field
        const workOrderInput = document.getElementById('work-order'); // Packing list field
        const consigneeAddressInput = document.getElementById('consignee-address'); // Packing list field
        const siteContactInput = document.getElementById('site-contact'); // Packing list field
        const sitePhoneInput = document.getElementById('site-phone'); // Packing list field
        const printTruckId = document.getElementById('printTruckId');
        const printProject = document.getElementById('printProject');
        const printTruckDimensions = document.getElementById('printTruckDimensions');
        const printTruckWeight = document.getElementById('printTruckWeight');
        const printTotalSkids = document.getElementById('printTotalSkids');
        const printSkidsBody = document.getElementById('printSkidsBody');
        const printTotalWeight = document.getElementById('printTotalWeight');
        const printLoadingSummaryDiv = document.getElementById('printLoadingSummary');
        const skidFormTemplate = document.getElementById('skidFormTemplate');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Loaded. Initializing application...");
            loadState();
            populateProjectSelectors();
            initializeSignaturePad();
            setupEventListeners(); // Setup listeners AFTER elements are defined
            initializeSelect2();
            renderCurrentPage();
            if (appState.inventory.selectedProject || appState.truckLoad.truckInfo.project) {
                updateDynamicContentForState();
            }
            console.log("Application Initialized. Current State:", JSON.parse(JSON.stringify(appState)));
        });

        function populateProjectSelectors() {
             mainProjectSelect.innerHTML = '<option value="" disabled selected>Select a Project...</option>';
             // *** MODIFIED: Use PROJECT_DATA ***
             PROJECT_DATA.forEach(proj => {
                 const option = document.createElement('option');
                 option.value = proj.value; // Use the defined value (e.g., WO#)
                 option.textContent = proj.text; // Use the defined display text
                 mainProjectSelect.appendChild(option);
             });
             console.log("Main project selector populated from PROJECT_DATA.");
         }

        function initializeSelect2() {
             try {
                 if (typeof $ !== 'undefined' && typeof $.fn.select2 === 'function') {
                     $(mainProjectSelect).select2({
                         placeholder: "Select a Project...",
                         allowClear: false, width: '100%', theme: "bootstrap-5",
                         dropdownParent: $('#projectSelectionPage') // Ensure it's attached correctly
                     }).on('select2:open', () => {
                         setTimeout(() => { document.querySelector('.select2-search__field')?.focus(); }, 10);
                     }).on('change', () => {
                         clearProjectValidationError(mainProjectSelect, mainProjectSelectErrorDiv);
                     });
                     console.log(`Select2 initialized for #mainProjectSelect`);
                 } else {
                     console.warn("jQuery or Select2 library not loaded.");
                     if(mainProjectSelect) { mainProjectSelect.addEventListener('change', () => clearProjectValidationError(mainProjectSelect, mainProjectSelectErrorDiv)); }
                 }
             } catch (error) {
                 console.error("Error initializing Select2:", error);
                   if(mainProjectSelect) { mainProjectSelect.addEventListener('change', () => clearProjectValidationError(mainProjectSelect, mainProjectSelectErrorDiv)); }
             }
         }

        // --- Signature Pad ---
        function initializeSignaturePad(){
            if (!signatureCanvas) { console.error("Signature canvas element not found!"); return; }
            try {
                resizeCanvas();
                signaturePad = new SignaturePad(signatureCanvas, { backgroundColor: 'rgb(255, 255, 255)', penColor: 'rgb(0, 0, 0)' });
                if (appState.truckLoad.signatureData) {
                     // Delay loading slightly to ensure canvas is fully ready
                     setTimeout(() => { try { signaturePad.fromDataURL(appState.truckLoad.signatureData); } catch (loadError) { console.error("Error loading signature data:", loadError); appState.truckLoad.signatureData = null; } }, 100);
                }
                window.addEventListener('resize', debounce(resizeCanvas, 250));
                // Prevent scrolling on touch devices when drawing
                ['touchstart', 'touchmove', 'touchend'].forEach(event => { signatureCanvas.addEventListener(event, (e) => { if (e.cancelable) e.preventDefault(); }, { passive: false }); });
                signaturePad.addEventListener("endStroke", debounce(() => {
                    if (!signaturePad.isEmpty()) {
                        signatureErrorDiv.style.display = 'none';
                        signatureCanvas.parentElement.style.border = '2px dashed var(--medium-gray)';
                        appState.truckLoad.signatureData = signaturePad.toDataURL();
                        saveState(); // Auto-save on signature change
                    } else {
                        appState.truckLoad.signatureData = null;
                        saveState(); // Auto-save if cleared
                    }
                }, 250));
                console.log('Signature pad initialized.');
            } catch(error) { console.error("Error initializing SignaturePad:", error); }
        }
        function resizeCanvas(){
            if (!signatureCanvas) return;
             const ratio = Math.max(window.devicePixelRatio || 1, 1);
             let data;
             if (signaturePad && !signaturePad.isEmpty()) { data = signaturePad.toDataURL(); } // Save current signature
             signatureCanvas.style.width = '100%'; signatureCanvas.style.height = '200px';
             signatureCanvas.width = signatureCanvas.offsetWidth * ratio; signatureCanvas.height = signatureCanvas.offsetHeight * ratio;
             const ctx = signatureCanvas.getContext('2d'); ctx.scale(ratio, ratio);
             // Restore signature if it existed
             if (signaturePad) { signaturePad.clear(); if (data && data !== 'data:,') { try { signaturePad.fromDataURL(data); } catch(e){ console.error("Error restoring sig on resize",e); } } }
        }
        function debounce(func, wait){ let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }

        // --- Event Listeners ---
        function setupEventListeners() {
            // Job Selection Page
            proceedJobSelectionBtn.addEventListener('click', handleJobSelectionProceed);

            // Project Selection Page
            proceedProjectSelectionBtn.addEventListener('click', handleProjectSelectionProceed);

            // Inventory Page Buttons
            showAddInventorySkidBtn.addEventListener('click', () => showAddSkidForm('inventory'));
            resetInventorySkidsBtn.addEventListener('click', handleResetInventoryProjectSkids);
            // The "Save Inventory & Return" button's onclick is now directly in the HTML

            // Truck Skid Page Button
            const addTruckSkidButton = document.getElementById('addTruckSkidBtn');
            if (addTruckSkidButton) {
                addTruckSkidButton.addEventListener('click', () => showAddSkidForm('truck'));
            } else {
                 console.warn("Button #addTruckSkidBtn not found during initial setup.");
            }

            // Truck Info Form Submission & Reset
            truckInfoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                let isFormValid = validateTruckInfoForm();
                if (isFormValid) {
                    proceedToSkidDetails();
                } else {
                    console.log(`Truck Info Validation failed.`);
                    const firstInvalid = truckInfoForm.querySelector('.is-invalid, :invalid'); // Broader selector
                    if(firstInvalid) firstInvalid.focus();
                 }
            });
            document.getElementById('resetTruckInfoBtn').addEventListener('click', handleResetTruckInfoClick);
             // Clear truck form errors on input
            truckInfoForm.querySelectorAll('input.form-control').forEach(input => {
                 input.addEventListener('input', handleFormInputChange.bind(null, input));
             });

            // Add Selected Inventory Skids Button
            addSelectedInventorySkidsBtn.addEventListener('click', addSelectedInventorySkidsToTruck);

            // Packing List
            packingListForm.addEventListener('input', debounce(handlePackingListInputChange, 500));
            document.querySelector('.signature-clear').addEventListener('click', clearSignature);
            document.getElementById('saveProgressBtn').addEventListener('click', handleManualSave);
            document.getElementById('printPackingListBtn').addEventListener('click', handlePrintPackingList);

             // Reset buttons listeners (ensure they are available)
            const resetSkidsBtn = document.getElementById('resetSkidsBtn');
            if(resetSkidsBtn) resetSkidsBtn.addEventListener('click', handleResetTruckSkids);
             const resetPackingListBtn = document.getElementById('resetPackingListBtn');
            if(resetPackingListBtn) resetPackingListBtn.addEventListener('click', handleResetPackingList);
        }

        // --- Event Handlers ---
        function handleJobSelectionProceed() {
            const selectedJob = jobTypeSelect.value;
            if (!selectedJob) { alert("Please select a task type."); return; }
            appState._selectedJobType = selectedJob;
            console.log("Task selected:", selectedJob);
            const taskName = selectedJob === 'inventory' ? 'Inventory Entry' : 'Truck Loading';
            projectSelectionTaskNameSpan.textContent = taskName;
            projectSelectionProceedButtonTextSpan.textContent = selectedJob === 'inventory' ? 'Inventory Skids' : 'Truck Details';
            // Reset project selection when going to this page
            $(mainProjectSelect).val('').trigger('change.select2');
            clearProjectValidationError(mainProjectSelect, mainProjectSelectErrorDiv);
            navigateTo('projectSelectionPage');
         }
        function handleProjectSelectionProceed() {
            const selectedProjectId = mainProjectSelect.value; // This is the 'value' from PROJECT_DATA (e.g., WO#)
            const selectedJobType = appState._selectedJobType;

            if (!validateProjectSelection(mainProjectSelect, mainProjectSelectErrorDiv)) { return; }
            if (!selectedJobType) { console.error("Error: Job type (_selectedJobType) is missing."); alert("An error occurred. Please go back and select the task type again."); goBackToJobSelection(); return; }

            console.log(`Project ${selectedProjectId} selected for task ${selectedJobType}`);

            let nextPageId = '';
            if (selectedJobType === 'inventory') {
                // Inventory selection logic remains the same, just using the new project ID
                appState.inventory.selectedProject = selectedProjectId;
                 if (!appState.inventory.skids[selectedProjectId]) { appState.inventory.skids[selectedProjectId] = []; }
                 if (!appState.inventory.nextSkidId[selectedProjectId]) { appState.inventory.nextSkidId[selectedProjectId] = 1; }
                nextPageId = 'inventoryPage';
            } else if (selectedJobType === 'truckEntry') {
                // *** MODIFIED: Store the selected Project ID (value) in truckInfo ***
                if (appState.truckLoad.truckInfo.project !== selectedProjectId) {
                    // Existing logic for handling project change warning
                    const oldProjectText = PROJECT_DATA.find(p => p.value === appState.truckLoad.truckInfo.project)?.text || appState.truckLoad.truckInfo.project || 'None';
                    const newProjectText = PROJECT_DATA.find(p => p.value === selectedProjectId)?.text || selectedProjectId;

                    if (appState.truckLoad.skids.length > 0 && appState.truckLoad.truckInfo.project !== null && !confirm(`You have changed the project for this truck load from '${oldProjectText}' to '${newProjectText}'. Do you want to keep the ${appState.truckLoad.skids.length} skids currently assigned, or clear them? \n\nOK = Keep Skids, Cancel = Clear Skids`)) {
                        console.log("User opted to clear truck skids due to project change.");
                        appState.truckLoad.skids = [];
                        if(appState.currentPage === 'skidDetailsPage') {
                           displayInventorySkidsForSelection(selectedProjectId); // Display for the *new* project
                        }
                    } else {
                        console.log("User opted to keep existing truck skids or it's the first selection.");
                    }
                    // *** Store the selected project's value (e.g., WO#) ***
                    appState.truckLoad.truckInfo.project = selectedProjectId;
                    console.log("Updated truck project ID to:", selectedProjectId);
                    // Clear previous packing list data when project changes for truck load
                    if (appState.truckLoad.packingList && Object.keys(appState.truckLoad.packingList).length > 0) {
                        console.log("Clearing packing list data due to project change.");
                        appState.truckLoad.packingList = {};
                        if(signaturePad) signaturePad.clear();
                        appState.truckLoad.signatureData = null;
                    }
                }
                nextPageId = 'truckInfoPage';
            }

             appState._selectedJobType = null; // Clear the temporary selection
             if (nextPageId) { navigateTo(nextPageId); } else { console.error("Could not determine next page ID."); }
         }
        function handleResetTruckInfoClick() {
             if (confirm('Reset truck identification, length, width, and weight fields? This will not change the selected project.')) {
                document.getElementById('truckId').value = ''; document.getElementById('length').value = ''; document.getElementById('width').value = ''; document.getElementById('weight').value = '';
                clearTruckInfoFormErrors();
                 appState.truckLoad.truckInfo.id = ''; appState.truckLoad.truckInfo.length = null; appState.truckLoad.truckInfo.width = null; appState.truckLoad.truckInfo.weight = null;
                saveState();
                console.log("Truck info form fields reset (Project unchanged).");
            }
         }
        function handlePackingListInputChange(event) {
             // Avoid auto-saving for the read-only project name, address, WO# fields
             const autoFilledIds = ['project-name', 'project-address', 'work-order', 'consignee-address', 'site-contact', 'site-phone'];
             if (!autoFilledIds.includes(event.target.id)) {
                 collectPackingListData(); // Collects ALL data including auto-filled ones for consistency in state
                 saveState();
             } else {
                // If user somehow edits a field intended for auto-fill, still collect it
                 collectPackingListData();
                 saveState();
             }
         }
        function handleManualSave() { collectPackingListData(); saveState(true); } // Project name is handled by collect/populate
        function handlePrintPackingList() { collectPackingListData(); updatePrintSection(); window.print(); } // Project name is handled by updatePrintSection
        function handleFormInputChange(inputElement) {
            // Also validate on input for truck form
            if (inputElement.form === truckInfoForm && !inputElement.checkValidity()) {
                 inputElement.classList.add('is-invalid');
                 const feedback = inputElement.closest('.form-group,.col-md-4,.col-md-6')?.querySelector('.invalid-feedback');
                 if (feedback) feedback.style.display = 'block';
            } else if (inputElement.checkValidity()) {
                 inputElement.classList.remove('is-invalid');
                 const feedback = inputElement.closest('.form-group,.col-md-4,.col-md-6,.form-field')?.querySelector('.invalid-feedback');
                 if (feedback) feedback.style.display = 'none';
            }
        }


        // --- Validation Helpers ---
        function validateProjectSelection(selectElement, errorDiv) { const value = (typeof $ !== 'undefined' && $.fn.select2 && $(selectElement).hasClass('select2-hidden-accessible')) ? $(selectElement).val() : selectElement.value; if (!value) { showProjectValidationError(selectElement, errorDiv); if (typeof $ !== 'undefined' && $.fn.select2 && $(selectElement).hasClass('select2-hidden-accessible')) { $(selectElement).select2('open'); } else { selectElement.focus(); } return false; } clearProjectValidationError(selectElement, errorDiv); return true; }
        function showProjectValidationError(selectElement, errorDiv) { if (typeof $ !== 'undefined' && $.fn.select2 && $(selectElement).hasClass('select2-hidden-accessible')) { $(selectElement).next('.select2-container').find('.select2-selection').addClass('is-invalid'); } else { selectElement.classList.add('is-invalid'); } if (errorDiv) errorDiv.style.display = 'block'; }
        function clearProjectValidationError(selectElement, errorDiv) { if (typeof $ !== 'undefined' && $.fn.select2 && $(selectElement).hasClass('select2-hidden-accessible')) { $(selectElement).next('.select2-container').find('.select2-selection').removeClass('is-invalid'); } else { selectElement.classList.remove('is-invalid'); } if (errorDiv) errorDiv.style.display = 'none'; }
        function validateTruckInfoForm() { clearTruckInfoFormErrors(); const isValid = truckInfoForm.checkValidity(); if (!isValid) { let firstInvalidElement = null; Array.from(truckInfoForm.elements).forEach(el => { if (el.willValidate && !el.checkValidity()) { el.classList.add('is-invalid'); const feedback = el.closest('.form-group,.col-md-4,.col-md-6')?.querySelector('.invalid-feedback'); if (feedback) feedback.style.display = 'block'; if (!firstInvalidElement) firstInvalidElement = el; } }); /* Focus handled in submit listener */ } return isValid; }
        function clearTruckInfoFormErrors() { Array.from(truckInfoForm.elements).forEach(el => { el.classList.remove('is-invalid'); const feedback = el.closest('.form-group,.col-md-4,.col-md-6')?.querySelector('.invalid-feedback'); if (feedback) feedback.style.display = 'none'; }); }
        function validatePackingListForm() { let isValid = true; let firstInvalidField = null; packingListForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid')); packingListForm.querySelectorAll('.invalid-feedback').forEach(el => el.style.display = 'none'); // Hide text feedback
            signatureErrorDiv.style.display = 'none'; if(signatureCanvas) signatureCanvas.parentElement.style.border = '2px dashed var(--medium-gray)';
            const receivedByInput = document.getElementById('received-by');
            if (!receivedByInput.checkValidity()) {
                isValid = false; receivedByInput.classList.add('is-invalid');
                const feedback = receivedByInput.closest('.form-field')?.querySelector('.invalid-feedback');
                if (feedback) feedback.style.display = 'block';
                if (!firstInvalidField) firstInvalidField = receivedByInput;
            }
            if (!signaturePad || signaturePad.isEmpty()) {
                isValid = false; signatureErrorDiv.style.display = 'block'; if(signatureCanvas) signatureCanvas.parentElement.style.border = '2px dashed var(--danger-red)';
                if (!firstInvalidField) firstInvalidField = signatureCanvas.parentElement;
            }
            if (!isValid) {
                alert('Please fill in all required fields (marked with *). Driver Name and Signature are mandatory.');
                if (firstInvalidField) { setTimeout(() => { if (firstInvalidField.focus) firstInvalidField.focus(); firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100); }
            } return isValid;
        }
        function validateSkidForm(formElement) {
             formElement.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
             formElement.querySelectorAll('.invalid-feedback').forEach(el => el.style.display = 'none');
             const isValid = formElement.checkValidity();
             if (!isValid) {
                let firstInvalidElement = null;
                 Array.from(formElement.elements).forEach(el => {
                     if (el.willValidate && !el.checkValidity()) {
                         el.classList.add('is-invalid');
                         const feedback = el.closest('.form-group')?.querySelector('.invalid-feedback');
                         if (feedback) feedback.style.display = 'block';
                         if (!firstInvalidElement) firstInvalidElement = el;
                     }
                 });
                 if(firstInvalidElement) firstInvalidElement.focus();
             }
             return isValid;
        }


        // --- State Management ---
        function saveState(showStatus = false) {
            if (signaturePad && !signaturePad.isEmpty()) { appState.truckLoad.signatureData = signaturePad.toDataURL(); } else { appState.truckLoad.signatureData = null; }
            // Packing list data is collected on input/manual save, no need to explicitly call collect here
            try {
                localStorage.setItem(APP_STATE_KEY, JSON.stringify(appState));
                if (showStatus) showSaveStatus("Progress saved successfully!");
            } catch (e) {
                console.error("Error saving state:", e); showSaveStatus("Error saving progress.", true);
                if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') { alert('Error: Could not save data. Browser local storage might be full.'); }
            }
        }
        function loadState() {
             const savedState = localStorage.getItem(APP_STATE_KEY);
             if (savedState) {
                 try {
                     const loadedData = JSON.parse(savedState);
                     // Reset state partially before loading to avoid merging issues with complex objects
                     appState = {
                         currentPage: loadedData.currentPage || 'jobSelectionPage',
                         _selectedJobType: null, // Always reset this transient state
                         inventory: { selectedProject: null, skids: {}, nextSkidId: {}, ...(loadedData.inventory || {}) },
                         truckLoad: { truckInfo: { id: '', project: null, length: null, width: null, weight: null }, skids: [], nextSkidId: 1, packingList: {}, signatureData: null, ...(loadedData.truckLoad || {}) }
                     };
                     // Ensure nested objects exist
                     appState.inventory.skids = appState.inventory.skids || {};
                     appState.inventory.nextSkidId = appState.inventory.nextSkidId || {};
                     appState.truckLoad.truckInfo = appState.truckLoad.truckInfo || { id: '', project: null, length: null, width: null, weight: null };
                     appState.truckLoad.skids = appState.truckLoad.skids || [];
                     appState.truckLoad.packingList = appState.truckLoad.packingList || {};
                     // Ensure nextSkidId is at least 1 and >= current skid count + 1 for truck
                     if (!appState.truckLoad.nextSkidId || appState.truckLoad.nextSkidId <= appState.truckLoad.skids.length) {
                        appState.truckLoad.nextSkidId = appState.truckLoad.skids.length + 1;
                     }
                     // Ensure inventory nextSkidId is consistent per project
                     for (const projId in appState.inventory.skids) {
                         const count = appState.inventory.skids[projId].length;
                         if (!appState.inventory.nextSkidId[projId] || appState.inventory.nextSkidId[projId] <= count) {
                             appState.inventory.nextSkidId[projId] = count + 1;
                         }
                     }

                     console.log("State loaded successfully.");
                 } catch (e) {
                     console.error("Error parsing saved state:", e);
                     localStorage.removeItem(APP_STATE_KEY); // Remove corrupted state
                     // Reset to default state
                     appState = { currentPage: 'jobSelectionPage', _selectedJobType: null, inventory: { selectedProject: null, skids: {}, nextSkidId: {} }, truckLoad: { truckInfo: { id: '', project: null, length: null, width: null, weight: null }, skids: [], nextSkidId: 1, packingList: {}, signatureData: null } };
                     alert("Could not load previous session data due to an error. Starting fresh.");
                 }
             } else {
                 console.log("No saved state found. Starting fresh.");
                 // Ensure default structure is set even if no state is loaded
                  appState = { currentPage: 'jobSelectionPage', _selectedJobType: null, inventory: { selectedProject: null, skids: {}, nextSkidId: {} }, truckLoad: { truckInfo: { id: '', project: null, length: null, width: null, weight: null }, skids: [], nextSkidId: 1, packingList: {}, signatureData: null } };
             }
             // Populate initial form fields from loaded state
             document.getElementById('truckId').value = appState.truckLoad.truckInfo.id || '';
             document.getElementById('length').value = appState.truckLoad.truckInfo.length || '';
             document.getElementById('width').value = appState.truckLoad.truckInfo.width || '';
             document.getElementById('weight').value = appState.truckLoad.truckInfo.weight || '';
             // Don't automatically populate project select, let navigation handle it
        }
        function showSaveStatus(message, isError = false){ if (!saveStatusDiv) return; saveStatusDiv.textContent = message; saveStatusDiv.style.color = isError ? 'var(--danger-red)' : 'var(--success-green)'; saveStatusDiv.classList.add('visible'); clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { saveStatusDiv.classList.remove('visible'); saveStatusDiv.textContent = ''; }, 3000); }

        // --- Navigation & Page Updates ---
        function renderCurrentPage() {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const currentPageElement = document.getElementById(appState.currentPage);
            if (currentPageElement) {
                currentPageElement.classList.add('active');
                hideAddEditSkidForm(); // Hide forms when switching pages
                updateDynamicContentForState(); // Update content based on the new page
            } else {
                console.warn(`Page element ID "${appState.currentPage}" not found. Defaulting to jobSelectionPage.`);
                jobSelectionPage.classList.add('active');
                appState.currentPage = 'jobSelectionPage';
                updateDynamicContentForState();
            }
         }
        function updateDynamicContentForState() {
             const currentPage = appState.currentPage;
             // *** MODIFIED: Find project details using the stored ID (value) ***
             const inventoryProjectDetails = PROJECT_DATA.find(p => p.value === appState.inventory.selectedProject);
             const truckProjectDetails = PROJECT_DATA.find(p => p.value === appState.truckLoad.truckInfo.project);

             // Update common elements or specific page elements
             if (currentPage === 'inventoryPage') {
                 const projText = inventoryProjectDetails ? inventoryProjectDetails.text : 'N/A';
                 inventoryPageProjectNameSpan.textContent = projText;
                 inventoryProjectDisplaySpan.textContent = projText;
                 renderInventorySkidsTable(appState.inventory.selectedProject); // Pass the project ID (value)
                 showAddInventorySkidBtn.disabled = !appState.inventory.selectedProject;
                 resetInventorySkidsBtn.disabled = !appState.inventory.selectedProject || (appState.inventory.skids[appState.inventory.selectedProject]?.length || 0) === 0;
             } else if (currentPage === 'truckInfoPage') {
                 const projText = truckProjectDetails ? truckProjectDetails.text : 'N/A';
                 truckInfoPageProjectNameSpan.textContent = projText;
                 truckProjectDisplaySpan.textContent = projText;
                  // Ensure truck form reflects current state (in case of back navigation)
                  document.getElementById('truckId').value = appState.truckLoad.truckInfo.id || '';
                  document.getElementById('length').value = appState.truckLoad.truckInfo.length || '';
                  document.getElementById('width').value = appState.truckLoad.truckInfo.width || '';
                  document.getElementById('weight').value = appState.truckLoad.truckInfo.weight || '';
             } else if (currentPage === 'skidDetailsPage') {
                 updateSkidPageHeader(); // Will use truckProjectDetails logic inside
                 displayInventorySkidsForSelection(appState.truckLoad.truckInfo.project); // Pass the project ID (value)
                 updateTruckSkidTable();
                 updateLoadingInstructions();
                 // (Keep existing button checks)
                 const resetSkidsBtn = document.getElementById('resetSkidsBtn');
                 if(resetSkidsBtn) resetSkidsBtn.disabled = (appState.truckLoad.skids?.length || 0) === 0;

             } else if (currentPage === 'packingListPage') {
                 // *** populatePackingListForm now handles auto-fill ***
                 populatePackingListForm();
                 updatePackingListPageHeader(); // Uses truck ID
                 updatePrintSection(); // Prepare print data based on state
                 resizeCanvas(); // Ensure signature pad is sized correctly
                 // Re-load signature if needed (might be redundant if loadState worked, but safe)
                 if (signaturePad && appState.truckLoad.signatureData) {
                     try { signaturePad.fromDataURL(appState.truckLoad.signatureData); } catch(e) {console.error("Error reloading signature on page render",e)}
                 } else if (signaturePad) {
                     signaturePad.clear();
                 }
                 // Disable reset if form likely empty
                 const resetPackingListBtn = document.getElementById('resetPackingListBtn');
                 if(resetPackingListBtn) resetPackingListBtn.disabled = Object.keys(appState.truckLoad.packingList || {}).length === 0 && (!signaturePad || signaturePad.isEmpty());
             } else if (currentPage === 'projectSelectionPage') {
                // Pre-select project based on the flow (task) that led here
                 const currentProject = appState._selectedJobType === 'inventory' ? appState.inventory.selectedProject : appState.truckLoad.truckInfo.project;
                 $(mainProjectSelect).val(currentProject || '').trigger('change.select2');
             }
             // Ensure Select2 dropdown is correctly associated if page renders directly
             if (currentPage === 'projectSelectionPage' && typeof $ !== 'undefined' && $.fn.select2) {
                // Re-initialize or update options if needed, ensure parent is correct
                $(mainProjectSelect).select2({
                    placeholder: "Select a Project...",
                    allowClear: false, width: '100%', theme: "bootstrap-5",
                    dropdownParent: $('#projectSelectionPage') // Explicitly set parent on re-render
                });
             }
         }
        function navigateTo(pageId) { hideAddEditSkidForm(); appState.currentPage = pageId; renderCurrentPage(); saveState(); window.scrollTo(0, 0); console.log("Navigated to:", pageId); }
        function goBackToJobSelection() {
            appState.inventory.selectedProject = null; // Clear selected inventory project
            // Keep truck project if returning from inventory, maybe they want to load it next?
            // appState.truckLoad.truckInfo.project = null;
            appState._selectedJobType = null;
            navigateTo('jobSelectionPage');
        }
        // *** NEW FUNCTION ***
        function saveInventoryAndReturnToTaskSelection() {
            console.log("Saving inventory changes and returning to task selection...");
            saveState(false); // Save the state without showing the default status message
            goBackToJobSelection(); // Navigate back to the task selection page
            // Optional: Briefly show a status message if desired, but navigation might be too fast
            // showSaveStatus("Inventory saved. Returning to task selection...");
            // setTimeout(goBackToJobSelection, 500); // Delay navigation slightly if showing status
        }
        function proceedToSkidDetails() { appState.truckLoad.truckInfo = { ...appState.truckLoad.truckInfo, id: document.getElementById('truckId').value.trim(), length: parseFloat(document.getElementById('length').value) || null, width: parseFloat(document.getElementById('width').value) || null, weight: parseFloat(document.getElementById('weight').value) || null }; navigateTo('skidDetailsPage'); }
        function goBackToSkidDetails() { collectPackingListData(); saveState(); navigateTo('skidDetailsPage'); }
        function proceedToPackingList() { collectPackingListData(); navigateTo('packingListPage'); } // Data collected before nav
        function completePackingList() { collectPackingListData(); if (!validatePackingListForm()) return; saveState(true); alert(`Packing list for Truck ${appState.truckLoad.truckInfo.id} completed and saved.`); /* Optionally navigate away or reset */ }

        // --- UI Update Helpers ---
        function updateSkidPageHeader() {
            truckIdentifierSpan.textContent = appState.truckLoad.truckInfo.id || 'N/A';
            // *** MODIFIED: Use PROJECT_DATA ***
            const projectDetails = PROJECT_DATA.find(p => p.value === appState.truckLoad.truckInfo.project);
            skidDetailsProjectNameSpan.textContent = projectDetails ? projectDetails.text : (appState.truckLoad.truckInfo.project || 'N/A');
            truckSizeDisplaySpan.textContent = `(${appState.truckLoad.truckInfo.length || '?'}ft L  ${appState.truckLoad.truckInfo.width || '?'}ft W, ${appState.truckLoad.truckInfo.weight || '?'}lbs Cap.)`;
        }
        function updatePackingListPageHeader() { packingListTruckIdSpan.textContent = appState.truckLoad.truckInfo.id || 'N/A'; }

        // updatePackingListProjectName() is no longer needed as populatePackingListForm handles this.


        // --- Skid Management (Inventory) ---
        function renderInventorySkidsTable(projectId) {
             inventorySkidTableBody.innerHTML = '';
             if (!projectId) { inventorySkidTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Select a project first.</td></tr>'; return; }
             const skids = appState.inventory.skids[projectId] || [];
             if (skids.length === 0) { const projectText = PROJECT_DATA.find(p => p.value === projectId)?.text || projectId; inventorySkidTableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">No inventory skids found for project ${projectText}.</td></tr>`; return; }
             skids.forEach((skid, index) => {
                 const row = inventorySkidTableBody.insertRow();
                 const displayId = skid.invId || `Error-No-ID-${index}`;
                 const descriptionText = skid.description ? skid.description.replace(/\n/g, '<br>') : '-';
                 row.innerHTML = `
                    <td>${displayId}</td>
                    <td>${skid.width?.toFixed(2) || '?'}</td>
                    <td>${skid.length?.toFixed(2) || '?'}</td>
                    <td>${skid.weight?.toFixed(2) || '?'}</td>
                    <td>${descriptionText}</td>
                    <td class="action-buttons no-print">
                        <button class="btn btn-edit btn-sm" onclick="showEditSkidForm(${index}, 'inventory')" title="Edit Inventory Skid ${displayId}"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn btn-delete btn-sm" onclick="deleteInventorySkid(${index})" title="Delete Inventory Skid ${displayId}"><i class="fas fa-trash"></i> Delete</button>
                    </td>`;
             });
             // Update reset button state
             const resetBtn = document.getElementById('resetInventorySkidsBtn');
             if(resetBtn) resetBtn.disabled = skids.length === 0;
         }
        function deleteInventorySkid(index) {
             const projectId = appState.inventory.selectedProject;
             if (!projectId || !appState.inventory.skids[projectId] || !appState.inventory.skids[projectId][index]) { console.error("Could not delete inventory skid: Invalid project or index."); return; }
             const skidToDelete = appState.inventory.skids[projectId][index];
             const displayId = skidToDelete.invId || `INV-${projectId}-temp-${index + 1}`;
             const projectText = PROJECT_DATA.find(p => p.value === projectId)?.text || projectId;
             if (confirm(`Are you sure you want to permanently delete Inventory Skid ${displayId} for project ${projectText}? This cannot be undone.`)) {
                 // Store the ID before deleting
                 const deletedInvId = skidToDelete.invId;

                 appState.inventory.skids[projectId].splice(index, 1);
                 console.log(`Deleted inventory skid ${displayId} at index ${index} for project ${projectId}`);

                 // Renumber Inventory IDs for this project
                 const remainingSkids = appState.inventory.skids[projectId];
                 for (let i = 0; i < remainingSkids.length; i++) { // Renumber ALL remaining skids based on new index
                     const newIdNumber = i + 1;
                     const newInvId = `INV-${projectId}-${newIdNumber}`;
                     if (remainingSkids[i].invId !== newInvId) {
                         console.log(`Renumbering inventory skid ${remainingSkids[i].invId} to ${newInvId}`);
                         remainingSkids[i].invId = newInvId;
                     }
                 }
                 // Update the next ID counter
                 appState.inventory.nextSkidId[projectId] = remainingSkids.length + 1;

                 renderInventorySkidsTable(projectId); // Re-render the inventory table

                 // Check if this deleted inventory skid was on the CURRENT truck load and remove it
                 const truckSkidIndex = appState.truckLoad.skids.findIndex(ts => ts.originalInvId === deletedInvId);
                 if (truckSkidIndex > -1) {
                     console.warn(`Inventory skid ${deletedInvId} was also on the current truck load. Removing it from the truck.`);
                     appState.truckLoad.skids.splice(truckSkidIndex, 1);
                     // If on skid details page, update truck table immediately
                     if (appState.currentPage === 'skidDetailsPage') {
                         updateTruckSkidTable();
                         updateLoadingInstructions();
                         // Also re-render the selection list as the item is now gone entirely
                         displayInventorySkidsForSelection(appState.truckLoad.truckInfo.project);
                     }
                 }

                 saveState();
             }
         }
        function handleResetInventoryProjectSkids() {
             const projectId = appState.inventory.selectedProject;
             if (!projectId) { alert("Please select a project first."); return; }
             const skids = appState.inventory.skids[projectId] || [];
             const projectText = PROJECT_DATA.find(p => p.value === projectId)?.text || projectId;
             if (skids.length === 0) { alert(`Inventory for project ${projectText} is already empty.`); return; }
             if (confirm(`ARE YOU SURE you want to REMOVE ALL ${skids.length} inventory skids listed for project ${projectText}? This will reset the ID counter and cannot be undone.`)) {
                 console.log(`Resetting inventory skids for project ${projectId}...`);

                 // Find which of these skids are on the current truck load
                 const invIdsToClear = skids.map(s => s.invId).filter(id => !!id); // Get valid IDs before clearing

                 // Clear inventory
                 appState.inventory.skids[projectId] = [];
                 appState.inventory.nextSkidId[projectId] = 1;
                 renderInventorySkidsTable(projectId); // Updates table and reset button state

                 // Remove corresponding skids from the current truck load if any
                 const initialTruckSkidCount = appState.truckLoad.skids.length;
                 appState.truckLoad.skids = appState.truckLoad.skids.filter(ts => !invIdsToClear.includes(ts.originalInvId));
                 const removedFromTruckCount = initialTruckSkidCount - appState.truckLoad.skids.length;

                 if (removedFromTruckCount > 0) {
                    console.warn(`Removed ${removedFromTruckCount} skids from the current truck load as their inventory source was cleared.`);
                 }

                 // If on skid details page, update truck table and selection list
                 if (appState.currentPage === 'skidDetailsPage') {
                      updateTruckSkidTable();
                      updateLoadingInstructions();
                      displayInventorySkidsForSelection(appState.truckLoad.truckInfo.project); // Re-render selection (will be empty for this project)
                 }

                 saveState();
                 alert(`Inventory skid list for project ${projectText} has been reset.`);
             }
         }

        // --- Skid Management (Truck Load & Shared Form Logic) ---
        function showAddSkidForm(context = 'truck') {
            console.log(`Attempting to show skid form. Context: ${context}.`);
            const formContainerId = (context === 'inventory') ? 'addInventorySkidFormContainer' : 'addTruckSkidFormContainer';
            const formContainer = document.getElementById(formContainerId);
            console.log(`Target container ID: ${formContainerId}`);
            if (!formContainer) { console.error(`Target form container #${formContainerId} NOT FOUND!`); alert(`Error: Could not find the form area for ${context}.`); return; }
            if (!skidFormTemplate) { console.error("Skid form template #skidFormTemplate not found!"); alert("Error: Cannot display skid form because the template is missing."); return; }
            console.log("Container and template found. Injecting form...");
            formContainer.innerHTML = ''; // Clear previous form
            const templateContent = skidFormTemplate.content.cloneNode(true);
            formContainer.appendChild(templateContent);

            // Get elements from the newly added template content
            const form = formContainer.querySelector('.add-skid-form'); // Use class selector
            const saveBtn = formContainer.querySelector('.save-skid-btn');
            const indexInput = formContainer.querySelector('.edit-skid-index');
            const contextInput = formContainer.querySelector('.skid-context');

            if (!form || !saveBtn || !indexInput || !contextInput) { console.error("Error finding required elements within the injected skid form!"); alert("Error: Could not initialize the skid form correctly."); return; }

            // Add dynamic title
            let formTitleElement = formContainer.querySelector('h4.skid-form-title-dynamic');
            if (!formTitleElement) {
                formTitleElement = document.createElement('h4');
                formTitleElement.className = 'skid-form-title-dynamic no-print';
                formTitleElement.style.color = 'var(--primary-blue)';
                formTitleElement.style.marginBottom = '15px'; formTitleElement.style.marginTop = '0';
                formContainer.insertBefore(formTitleElement, form); // Insert before the form
            }

            // Configure for Add mode
            indexInput.value = '';
            contextInput.value = context;
            form.reset();
            formTitleElement.innerHTML = `<i class="fas fa-plus-circle"></i> Add New Skid ${context === 'inventory' ? 'to Inventory' : 'to Truck'}`;
            saveBtn.innerHTML = `<i class="fas fa-plus"></i> Add Skid`;
            console.log("Attaching submit listener...");

            // Detach previous listener if any, then attach new one
            form.onsubmit = null;
            form.onsubmit = function(e) { e.preventDefault(); console.log(`Skid form submitted. Context: ${context}`); saveSkid(this); };

            // Clear any previous validation states
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            form.querySelectorAll('.invalid-feedback').forEach(el => el.style.display = 'none');

            console.log(`Displaying container #${formContainerId} and focusing input...`);
            formContainer.style.display = 'block';
            setTimeout(() => {
                // Use class selectors from template
                const firstInput = formContainer.querySelector('.skid-width');
                if (firstInput) {
                    firstInput.focus();
                    console.log("Focused on skidWidth input.");
                } else { console.warn("Could not find skidWidth input to focus."); }
            }, 50); // Short delay for rendering
        }
        function showEditSkidForm(index, context = 'truck') {
            console.log(`Showing edit skid form for index ${index}, context: ${context}`);
            const formContainer = (context === 'inventory') ? addInventorySkidFormContainer : addTruckSkidFormContainer;
            if (!formContainer) { console.error("Target form container not found for context:", context); return; }
            if (!skidFormTemplate) { console.error("Skid form template not found!"); return; }

            let skid;
            let projectId;
            let displaySkidId; // ID for display in title

            if (context === 'inventory') {
                projectId = appState.inventory.selectedProject;
                if (!projectId || !appState.inventory.skids[projectId] || !appState.inventory.skids[projectId][index]) { console.error("Invalid project or index for editing inventory skid."); hideAddEditSkidForm(); return; }
                skid = appState.inventory.skids[projectId][index];
                displaySkidId = skid.invId || `INV-${projectId}-temp-${index + 1}`;
            } else { // context === 'truck'
                if (!appState.truckLoad.skids[index]) { console.error("Invalid index for editing truck skid."); hideAddEditSkidForm(); return; }
                skid = appState.truckLoad.skids[index];
                displaySkidId = `#${index + 1}`; // Use positional number for truck skids
            }

            formContainer.innerHTML = ''; // Clear previous form
            const templateContent = skidFormTemplate.content.cloneNode(true);
            formContainer.appendChild(templateContent);

            // Get elements from the newly added template content using class selectors
            const form = formContainer.querySelector('.add-skid-form');
            const saveBtn = formContainer.querySelector('.save-skid-btn');
            const indexInput = formContainer.querySelector('.edit-skid-index');
            const contextInput = formContainer.querySelector('.skid-context');
            const widthInput = formContainer.querySelector('.skid-width');
            const lengthInput = formContainer.querySelector('.skid-length');
            const weightInput = formContainer.querySelector('.skid-weight');
            const descriptionInput = formContainer.querySelector('.skid-description');

            // Add dynamic title
             let formTitleElement = formContainer.querySelector('h4.skid-form-title-dynamic');
             if (!formTitleElement) {
                 formTitleElement = document.createElement('h4');
                 formTitleElement.className = 'skid-form-title-dynamic no-print';
                 formTitleElement.style.color = 'var(--primary-blue)';
                 formTitleElement.style.marginBottom = '15px'; formTitleElement.style.marginTop = '0';
                 formContainer.insertBefore(formTitleElement, form); // Insert before the form
             }

            // Configure for Edit mode
            indexInput.value = index;
            contextInput.value = context;
            widthInput.value = skid.width || '';
            lengthInput.value = skid.length || '';
            weightInput.value = skid.weight || '';
            descriptionInput.value = skid.description || '';

            formTitleElement.innerHTML = `<i class="fas fa-edit"></i> Edit Skid ${displaySkidId} ${context === 'inventory' ? '(Inventory)' : '(Truck Load)'}`;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';

            // Detach previous listener if any, then attach new one
            form.onsubmit = null;
            form.onsubmit = function(e) { e.preventDefault(); saveSkid(this); };

            // Clear any previous validation states
             form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
             form.querySelectorAll('.invalid-feedback').forEach(el => el.style.display = 'none');

            formContainer.style.display = 'block';
            setTimeout(() => { widthInput?.focus(); }, 50);
        }
        function hideAddEditSkidForm() {
             if (addInventorySkidFormContainer) { addInventorySkidFormContainer.style.display = 'none'; addInventorySkidFormContainer.innerHTML = '';}
             if (addTruckSkidFormContainer) { addTruckSkidFormContainer.style.display = 'none'; addTruckSkidFormContainer.innerHTML = '';}
        }
        function saveSkid(formElement) {
             // Use the validation helper
             if (!validateSkidForm(formElement)) {
                 console.log("Skid form validation failed.");
                 return;
             }
             console.log("Skid form validation passed.");

             // Use class selectors to get values
             const context = formElement.querySelector('.skid-context').value;
             const indexStr = formElement.querySelector('.edit-skid-index').value;
             const width = parseFloat(formElement.querySelector('.skid-width').value);
             const length = parseFloat(formElement.querySelector('.skid-length').value);
             const weight = parseFloat(formElement.querySelector('.skid-weight').value);
             const description = formElement.querySelector('.skid-description').value.trim();

             const skidData = { width, length, weight, description };

             if (context === 'inventory') {
                 const projectId = appState.inventory.selectedProject;
                 if (!projectId) { alert("Error: No inventory project selected!"); return; }
                 if (!appState.inventory.skids[projectId]) appState.inventory.skids[projectId] = [];
                 if (!appState.inventory.nextSkidId[projectId]) appState.inventory.nextSkidId[projectId] = 1;

                 if (indexStr === '') { // Adding new inventory skid
                     skidData.invId = `INV-${projectId}-${appState.inventory.nextSkidId[projectId]++}`;
                     appState.inventory.skids[projectId].push(skidData);
                     console.log("Added new inventory skid:", skidData);
                 } else { // Editing existing inventory skid
                     const skidIndex = parseInt(indexStr, 10);
                     if (!isNaN(skidIndex) && appState.inventory.skids[projectId][skidIndex]) {
                         skidData.invId = appState.inventory.skids[projectId][skidIndex].invId; // Keep original Inv ID
                         appState.inventory.skids[projectId][skidIndex] = skidData;
                         console.log("Updated inventory skid:", skidData);

                         // Check if the edited inventory item is on the truck and update it there too
                         const truckSkidIndex = appState.truckLoad.skids.findIndex(ts => ts.originalInvId === skidData.invId);
                         if (truckSkidIndex > -1) {
                             console.log(`Inventory skid ${skidData.invId} is on truck load, updating truck skid too.`);
                             const truckSkid = appState.truckLoad.skids[truckSkidIndex];
                             // Update relevant fields, keep truck-specific ID and originalInvId link
                             truckSkid.width = skidData.width;
                             truckSkid.length = skidData.length;
                             truckSkid.weight = skidData.weight;
                             truckSkid.description = skidData.description;
                             if (appState.currentPage === 'skidDetailsPage') {
                                 updateTruckSkidTable(); // Update truck table if visible
                                 updateLoadingInstructions();
                             }
                         }

                     } else {
                         console.error("Invalid index for editing inventory skid:", indexStr);
                         hideAddEditSkidForm(); return;
                     }
                 }
                 renderInventorySkidsTable(projectId); // Re-render inventory table
             } else { // context === 'truck'
                 if (indexStr === '') { // Adding new truck skid
                     skidData.id = `SKID-${appState.truckLoad.nextSkidId++}`; // Internal stable ID
                     appState.truckLoad.skids.push(skidData);
                     console.log("Added new truck skid:", skidData);
                 } else { // Editing existing truck skid
                     const skidIndex = parseInt(indexStr, 10);
                     if (!isNaN(skidIndex) && appState.truckLoad.skids[skidIndex]) {
                         skidData.id = appState.truckLoad.skids[skidIndex].id; // Keep original internal ID
                         // Keep originalInvId if it exists (meaning it came from inventory)
                         if (appState.truckLoad.skids[skidIndex].originalInvId) {
                             skidData.originalInvId = appState.truckLoad.skids[skidIndex].originalInvId;
                         }
                         appState.truckLoad.skids[skidIndex] = skidData;
                         console.log("Updated truck skid:", skidData);
                     } else {
                         console.error("Invalid index for editing truck skid:", indexStr);
                         hideAddEditSkidForm(); return;
                     }
                 }
                 updateTruckSkidTable(); // Re-render truck table
                 updateLoadingInstructions();
             }
             hideAddEditSkidForm(); // Hide form after successful save
             saveState();
         }
        function deleteTruckSkid(index) {
             const skid = appState.truckLoad.skids[index];
             if (!skid) { console.error("Attempted to delete truck skid with invalid index:", index); return; }

             // Use positional number for confirmation
             const displaySkidNumber = index + 1;

             if (confirm(`Are you sure you want to remove Truck Skid #${displaySkidNumber} from this load?`)) {
                 const removedSkid = appState.truckLoad.skids.splice(index, 1)[0]; // Remove and get the removed item
                 console.log(`Removed truck skid #${displaySkidNumber} (Internal ID: ${removedSkid.id}) from load.`);

                 // If the removed skid originated from inventory, re-enable its checkbox in the selection list
                 if (removedSkid.originalInvId) {
                     enableInventorySelectionCheckbox(removedSkid.originalInvId);
                 }

                 updateTruckSkidTable(); // Re-render table, numbers will adjust
                 updateLoadingInstructions();
                 saveState();
                 // Update reset button state
                 const resetBtn = document.getElementById('resetSkidsBtn');
                 if(resetBtn) resetBtn.disabled = (appState.truckLoad.skids?.length || 0) === 0;
             }
         }
        function handleResetTruckSkids() {
             if (appState.truckLoad.skids.length === 0) { alert("Truck skid list is already empty."); return; }
             if (confirm('Are you sure you want to remove ALL skids listed for this truck load?')) {
                 console.log("Resetting truck skids list...");
                 // Find all skids that came from inventory before clearing
                 const removedInvIds = appState.truckLoad.skids.filter(skid => skid.originalInvId).map(skid => skid.originalInvId);

                 appState.truckLoad.skids = []; // Clear the array

                 // Re-enable all corresponding inventory checkboxes
                 removedInvIds.forEach(invId => {
                     enableInventorySelectionCheckbox(invId);
                 });

                 updateTruckSkidTable(); // Re-render empty table
                 updateLoadingInstructions();
                 saveState();
                 alert("Truck skid list has been reset.");
                 // Update reset button state
                 const resetBtn = document.getElementById('resetSkidsBtn');
                 if(resetBtn) resetBtn.disabled = true;
             }
         }

        // --- Truck Load - Inventory Skid Selection ---
        function displayInventorySkidsForSelection(projectId) {
            inventorySkidSelectionBody.innerHTML = ''; // Clear previous list
            inventorySkidSelectionContainer.style.display = 'none'; // Hide by default

            if (!projectId) { console.log("No truck project selected, hiding inventory selection."); return; }

            const inventorySkids = appState.inventory.skids[projectId] || [];
            if (inventorySkids.length === 0) {
                 console.log(`No inventory skids found for project ${projectId} to display for selection.`);
                 // Optionally show a message within the container if it should still be visible
                 // inventorySkidSelectionContainer.style.display = 'block';
                 // inventorySkidSelectionBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No inventory skids available for project ${projectId}.</td></tr>`;
                 addSelectedInventorySkidsBtn.disabled = true;
                 return;
            }

            console.log(`Displaying ${inventorySkids.length} inventory skids from project ${projectId} for selection.`);
            let hasAvailableSkids = false;

            inventorySkids.forEach((skid, index) => {
                const invId = skid.invId; // Use the guaranteed invId
                if (!invId) {
                    console.warn(`Inventory skid at index ${index} for project ${projectId} is missing invId.`);
                    return; // Skip rendering if ID is missing
                }

                // Check if this inventory item (by invId) is already in the truck load skids
                const alreadyAdded = appState.truckLoad.skids.some(truckSkid => truckSkid.originalInvId === invId);

                const row = inventorySkidSelectionBody.insertRow();
                const descriptionText = skid.description ? skid.description.replace(/\n/g, '<br>') : '-';
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="inventory-skid-select" value="${index}"
                               data-project-id="${projectId}" data-inv-id="${invId}"
                               id="inv-select-${invId}" ${alreadyAdded ? 'disabled' : ''}>
                    </td>
                    <td><label for="inv-select-${invId}" title="${alreadyAdded ? 'Already added to truck' : `Select ${invId}`}">${invId}</label></td>
                    <td>${skid.width?.toFixed(2) || '?'}</td>
                    <td>${skid.length?.toFixed(2) || '?'}</td>
                    <td>${skid.weight?.toFixed(2) || '?'}</td>
                    <td>${descriptionText}</td>`;

                if (!alreadyAdded) { hasAvailableSkids = true; }
            });

            inventorySkidSelectionContainer.style.display = 'block'; // Show the container
            addSelectedInventorySkidsBtn.disabled = !hasAvailableSkids;

            if (!hasAvailableSkids && inventorySkids.length > 0) {
                const row = inventorySkidSelectionBody.insertRow();
                row.innerHTML = `<td colspan="6" style="text-align:center; font-style:italic;">All inventory items for this project are already on the truck load.</td>`;
            }
         }
        function addSelectedInventorySkidsToTruck() {
            const selectedCheckboxes = inventorySkidSelectionBody.querySelectorAll('.inventory-skid-select:checked:not(:disabled)');
            if (selectedCheckboxes.length === 0) { alert("Please select one or more available inventory skids to add."); return; }

            let addedCount = 0;
            selectedCheckboxes.forEach(checkbox => {
                const index = parseInt(checkbox.value, 10);
                const projectId = checkbox.dataset.projectId;
                const originalInvId = checkbox.dataset.invId; // Use the invId from data attribute

                if (!isNaN(index) && projectId && originalInvId && appState.inventory.skids[projectId] && appState.inventory.skids[projectId][index]) {
                    const originalSkid = appState.inventory.skids[projectId][index];

                    // Double check the invId matches before adding
                    if (originalSkid.invId === originalInvId) {
                        const newTruckSkid = {
                            width: originalSkid.width,
                            length: originalSkid.length,
                            weight: originalSkid.weight,
                            description: originalSkid.description || '',
                            originalInvId: originalInvId, // Link back to inventory
                            id: `SKID-${appState.truckLoad.nextSkidId++}` // Internal stable ID
                        };
                        appState.truckLoad.skids.push(newTruckSkid);
                        addedCount++;
                        console.log(`Added inventory skid (Inv ID: ${originalInvId}) as truck skid (ID: ${newTruckSkid.id})`);

                        // Disable the checkbox immediately after adding
                        checkbox.disabled = true;
                        checkbox.checked = false; // Uncheck it
                        const label = inventorySkidSelectionBody.querySelector(`label[for="inv-select-${originalInvId}"]`);
                        if(label) label.title = "Already added to truck";

                    } else {
                         console.warn(`Mismatch: Inventory skid at index ${index} has ID ${originalSkid.invId}, but checkbox expected ${originalInvId}. Skipping.`);
                    }
                } else {
                     console.warn("Could not find valid inventory skid for selection:", { projectId, index, originalInvId });
                }
            });

            if (addedCount > 0) {
                updateTruckSkidTable();
                updateLoadingInstructions();
                saveState();
                alert(`Added ${addedCount} skid(s) from inventory to the truck load.`);
                // Update availability for the add button
                const remainingCheckboxes = inventorySkidSelectionBody.querySelectorAll('.inventory-skid-select:not(:disabled)');
                addSelectedInventorySkidsBtn.disabled = remainingCheckboxes.length === 0;
                // Update reset button state
                const resetBtn = document.getElementById('resetSkidsBtn');
                if(resetBtn) resetBtn.disabled = (appState.truckLoad.skids?.length || 0) === 0;
            }
        }
        function enableInventorySelectionCheckbox(invId) {
            // Only attempt if on the skid details page where the selection list exists
            if (appState.currentPage === 'skidDetailsPage' && inventorySkidSelectionBody) {
                const invCheckbox = inventorySkidSelectionBody.querySelector(`.inventory-skid-select[data-inv-id="${invId}"]`);
                 if (invCheckbox) {
                     invCheckbox.disabled = false;
                     invCheckbox.checked = false; // Ensure it's unchecked
                     const label = inventorySkidSelectionBody.querySelector(`label[for="inv-select-${invId}"]`);
                     if(label) label.title = `Select ${invId}`;
                     console.log(`Re-enabled inventory selection checkbox for ${invId}`);
                      // Update the 'Add Selected' button state
                      addSelectedInventorySkidsBtn.disabled = false;
                 } else {
                     console.log(`Inventory checkbox for ${invId} not found in current view, might be for a different project or already removed.`);
                 }
            } else {
                 console.log(`Not on Skid Details page or selection body not found, skipping checkbox enable for ${invId}.`);
            }
        }

        // --- Truck Skid Table Update (Handles Renumbering Display) ---
        function updateTruckSkidTable() {
            truckSkidTableBody.innerHTML = ''; // Clear existing rows
            let totalWeight = 0;

            if (appState.truckLoad.skids.length === 0) {
                truckSkidTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No skids added to this truck yet.</td></tr>';
                totalTruckSkidCountSpan.textContent = '0';
                totalTruckSkidWeightSpan.textContent = '0.00 lbs';
            } else {
                appState.truckLoad.skids.forEach((skid, index) => {
                    totalWeight += (skid.weight || 0);
                    const row = truckSkidTableBody.insertRow();
                    let displayDescription = skid.description ? skid.description.replace(/\n/g, '<br>') : '-';
                    if (skid.originalInvId) {
                        displayDescription += ` <span style="font-size: 0.8em; color: var(--text-muted); white-space: nowrap;">(from Inv: ${skid.originalInvId})</span>`;
                    }

                    const displaySkidNumber = index + 1; // Positional number

                    row.innerHTML = `
                        <td>${displaySkidNumber}</td> <!-- Display positional number -->
                        <td>${skid.width?.toFixed(2) || '?'}</td>
                        <td>${skid.length?.toFixed(2) || '?'}</td>
                        <td>${skid.weight?.toFixed(2) || '?'}</td>
                        <td>${displayDescription}</td>
                        <td class="action-buttons no-print">
                            <button class="btn btn-edit btn-sm" onclick="showEditSkidForm(${index}, 'truck')" title="Edit Truck Skid #${displaySkidNumber}"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn btn-delete btn-sm" onclick="deleteTruckSkid(${index})" title="Remove Truck Skid #${displaySkidNumber} from Load"><i class="fas fa-trash"></i> Delete</button>
                        </td>`;
                });
                totalTruckSkidCountSpan.textContent = appState.truckLoad.skids.length;
                totalTruckSkidWeightSpan.textContent = `${totalWeight.toFixed(2)} lbs`;
            }
             // Update reset button state
             const resetBtn = document.getElementById('resetSkidsBtn');
             if(resetBtn) resetBtn.disabled = (appState.truckLoad.skids?.length || 0) === 0;
        }

        // --- Loading Instructions ---
        function updateLoadingInstructions() { loadingInstructionsDiv.innerHTML = generateLoadingSummaryText(); }
        function generateLoadingSummaryText() {
             const truckInfo = appState.truckLoad.truckInfo;
             const truckSkids = appState.truckLoad.skids;

             if (!truckInfo.length || !truckInfo.width || !truckInfo.weight) { return '<p>Enter complete truck information first.</p>'; }
             if (truckSkids.length === 0) { return '<p>Add skids to the truck load to see loading summary.</p>'; }

             const totalWeight = truckSkids.reduce((s, k) => s + (k.weight || 0), 0);
             const totalArea = truckSkids.reduce((s, k) => s + ((k.width || 0) * (k.length || 0)), 0);
             const truckArea = (truckInfo.width || 0) * (truckInfo.length || 0);
             const truckWeightCap = truckInfo.weight || 0;

             const usedWeightPercent = truckWeightCap > 0 ? (totalWeight / truckWeightCap) * 100 : 0;
             const usedAreaPercent = truckArea > 0 ? (totalArea / truckArea) * 100 : 0;

             let instructionsHTML = `
                <p><strong>Summary for Truck ${truckInfo.id || 'N/A'}:</strong></p>
                <ul>
                    <li>Total Skids on Truck: ${truckSkids.length}</li>
                    <li>Total Weight on Truck: ${totalWeight.toFixed(2)} lbs (${usedWeightPercent.toFixed(1)}% of ${truckWeightCap} lbs capacity)</li>
                    <li>Approx. Area Used: ${totalArea.toFixed(2)} sq ft (${usedAreaPercent.toFixed(1)}% of ${truckArea.toFixed(2)} sq ft available)</li>
                </ul>`;

             let warningsHTML = '';
             if (truckWeightCap > 0 && totalWeight > truckWeightCap) {
                 warningsHTML += '<p class="warning"><i class="fas fa-exclamation-triangle"></i> Warning: Total weight exceeds truck capacity!</p>';
             } else if (usedWeightPercent > 95 && usedWeightPercent <= 100) {
                 warningsHTML += '<p class="warning" style="background-color:#fff3cd;border-color:#ffeeba;color:#856404;"><i class="fas fa-exclamation-circle"></i> Caution: Approaching maximum weight capacity.</p>';
             }

             if (truckArea > 0 && totalArea > truckArea) {
                 warningsHTML += '<p class="warning"><i class="fas fa-exclamation-triangle"></i> Warning: Total skid area exceeds theoretical truck floor space. Check stacking/dimensions.</p>';
             } else if (usedAreaPercent > 95 && usedAreaPercent <= 100) {
                 warningsHTML += '<p class="warning" style="background-color:#fff3cd;border-color:#ffeeba;color:#856404;"><i class="fas fa-exclamation-circle"></i> Caution: High space utilization. Consider loading arrangement.</p>';
             }

             const titleHTML = `<h5><i class="fas fa-info-circle"></i> Loading Summary & Instructions</h5>`;
             return titleHTML + instructionsHTML + warningsHTML;
        }

        // --- Packing List ---
        function collectPackingListData() {
            if (!appState.truckLoad.packingList) appState.truckLoad.packingList = {};
            const formData = new FormData(packingListForm);
            for (const [key, value] of formData.entries()) {
                // Store all user-editable fields' current values from the form
                 appState.truckLoad.packingList[key] = value;
            }
            // Note: The project-related fields (name, address, WO, consigneeAddr, contact, phone)
            // will be overwritten here if the user somehow edited them, but populatePackingListForm
            // will correct them based on PROJECT_DATA when the page is next rendered/updated.
        }

        // *** MODIFIED: populatePackingListForm to Auto-fill ***
        function populatePackingListForm() {
             // 1. Reset form first (optional, but good practice)
             if (packingListForm) packingListForm.reset();

             // 2. Find Project Details based on the stored project ID
             const currentProjectId = appState.truckLoad.truckInfo.project;
             const projectDetails = currentProjectId ? PROJECT_DATA.find(p => p.value === currentProjectId) : null;

             // 3. Auto-fill from Project Details if found
             let autoFilledValues = {}; // Keep track of what we auto-filled
             if (projectDetails) {
                 console.log("Auto-filling packing list from PROJECT_DATA for:", currentProjectId);
                 if(projectNameInput) { projectNameInput.value = projectDetails.text || projectDetails.projectName || ''; autoFilledValues['projectName'] = projectNameInput.value; }
                 if(projectAddressInput) { projectAddressInput.value = projectDetails.projectAddress || ''; autoFilledValues['projectAddress'] = projectAddressInput.value; }
                 if(workOrderInput) { workOrderInput.value = projectDetails.workOrder || projectDetails.value || ''; autoFilledValues['workOrder'] = workOrderInput.value; }
                 // Use Delivery Address for Consignee, fallback to Project Address
                 if(consigneeAddressInput) { consigneeAddressInput.value = projectDetails.deliveryAddress || projectDetails.projectAddress || ''; autoFilledValues['consigneeAddress'] = consigneeAddressInput.value; }
                 if(siteContactInput) { siteContactInput.value = projectDetails.siteContact || ''; autoFilledValues['siteContact'] = siteContactInput.value; }
                 if(sitePhoneInput) { sitePhoneInput.value = projectDetails.sitePhone || ''; autoFilledValues['sitePhone'] = sitePhoneInput.value; }
             } else {
                 console.log("No project selected for truck load, skipping auto-fill.");
                 // Clear fields that would normally be auto-filled
                 if(projectNameInput) projectNameInput.value = '';
                 if(projectAddressInput) projectAddressInput.value = '';
                 if(workOrderInput) workOrderInput.value = '';
                 if(consigneeAddressInput) consigneeAddressInput.value = '';
                 if(siteContactInput) siteContactInput.value = '';
                 if(sitePhoneInput) sitePhoneInput.value = '';
             }

             // 4. Overlay with saved user input from appState.truckLoad.packingList
             // Only apply saved data for fields *not* auto-filled in this round,
             // or for fields where the saved data is different (allowing overrides of non-project fields)
             const savedPackingList = appState.truckLoad.packingList || {};
             for (const [key, value] of Object.entries(savedPackingList)) {
                 const input = packingListForm.querySelector(`[name="${key}"]`);
                 if (input) {
                     // Apply saved value ONLY if:
                     // 1. The field was NOT auto-filled OR
                     // 2. The saved value is different from the auto-filled one (for non-project-ID fields)
                     if (!(key in autoFilledValues) || (key in autoFilledValues && value !== autoFilledValues[key] && !['projectName', 'projectAddress', 'workOrder', 'consigneeAddress', 'siteContact', 'sitePhone'].includes(key) )) {
                         input.value = value || ''; // Use saved value
                         // console.log(`Populating field ${key} from saved state: ${value}`);
                     } else if (key in autoFilledValues) {
                        // console.log(`Field ${key} was auto-filled, keeping auto-filled value: ${autoFilledValues[key]}`);
                     }
                 }
             }

             // Clear validation states when populating
             packingListForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
             packingListForm.querySelectorAll('.invalid-feedback').forEach(el => el.style.display = 'none');
             if(signatureErrorDiv) signatureErrorDiv.style.display = 'none';
             if(signatureCanvas) signatureCanvas.parentElement.style.border = '2px dashed var(--medium-gray)';
         }

        function clearSignature() {
             if (signaturePad) {
                 signaturePad.clear();
                 signatureErrorDiv.style.display = 'none';
                 if(signatureCanvas) signatureCanvas.parentElement.style.border = '2px dashed var(--medium-gray)';
                 appState.truckLoad.signatureData = null;
                 saveState(); // Save the cleared state
             }
        }
        function handleResetPackingList() {
            if (confirm('Are you sure you want to reset the Packing List form? This will clear all fields and the signature.')) {
                 // Clear the form fields
                 if (packingListForm) packingListForm.reset();
                 // Clear signature visually and in state
                 clearSignature(); // Also saves state
                 // Clear packing list data in state
                 appState.truckLoad.packingList = {};
                 // Re-populate with auto-filled data based on the *current* project
                 populatePackingListForm(); // This will apply project defaults if a project is selected
                 // Clear validation states again just in case
                 packingListForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                 packingListForm.querySelectorAll('.invalid-feedback').forEach(el => el.style.display = 'none');
                 if(signatureErrorDiv) signatureErrorDiv.style.display = 'none';
                 if(signatureCanvas) signatureCanvas.parentElement.style.border = '2px dashed var(--medium-gray)';

                 saveState(); // Save the reset state (with potential auto-fill)
                 alert("Packing List form has been reset.");
                 // Update reset button state
                 const resetBtn = document.getElementById('resetPackingListBtn');
                 if(resetBtn) resetBtn.disabled = true;
            }
        }

        // --- Printing ---
        // *** MODIFIED: updatePrintSection to use PROJECT_DATA ***
        function updatePrintSection() {
             if (!printTruckId || !printProject || !printSkidsBody || !PROJECT_DATA ) { console.error("Required print elements or PROJECT_DATA missing."); return; }
             const truckInfo = appState.truckLoad.truckInfo;
             const truckSkids = appState.truckLoad.skids;

             printTruckId.textContent = truckInfo.id || 'N/A';
             printTruckDimensions.textContent = `${truckInfo.length || '?'}ft L  ${truckInfo.width || '?'}ft W`;
             printTruckWeight.textContent = `${truckInfo.weight || '?'} lbs`;

             // *** Get project text from PROJECT_DATA ***
             let projText = 'N/A';
             const projectDetails = PROJECT_DATA.find(p => p.value === truckInfo.project);
             projText = projectDetails ? projectDetails.text : (truckInfo.project || 'N/A'); // Display the full text
             printProject.textContent = projText;

             printTotalSkids.textContent = truckSkids.length;
             printSkidsBody.innerHTML = ''; // Clear previous print rows
             let printWeightTotal = 0;

             truckSkids.forEach((skid, index) => {
                 printWeightTotal += (skid.weight || 0);
                 const row = printSkidsBody.insertRow();
                 let printDescription = skid.description ? skid.description.replace(/\n/g, ', ') : '-';
                 // Add inventory source to print description if available
                 if (skid.originalInvId) {
                     printDescription += ` (Inv: ${skid.originalInvId})`;
                 }
                 const displaySkidNumber = index + 1; // Use positional number for print

                 row.innerHTML = `
                     <td>${displaySkidNumber}</td> <!-- Print positional number -->
                     <td>${skid.width?.toFixed(2) || '?'}</td>
                     <td>${skid.length?.toFixed(2) || '?'}</td>
                     <td>${skid.weight?.toFixed(2) || '?'}</td>
                     <td>${printDescription}</td>`;
             });
             printTotalWeight.textContent = `${printWeightTotal.toFixed(2)} lbs`;

             if (printLoadingSummaryDiv) {
                 let html = generateLoadingSummaryText().replace(/<h5>.*?<\/h5>/, '<h5>Loading Summary</h5>'); // Get summary, replace title
                 printLoadingSummaryDiv.innerHTML = html;
             }
         }
        function printSkidPage() { updatePrintSection(); window.print(); }

        // --- Utility ---
        function resetEntireProcess() {
             if (confirm('ARE YOU SURE you want to clear ALL data (Inventory and Truck Loads) and start over? This cannot be undone.')) {
                 if (confirm('FINAL CONFIRMATION: This will erase everything. Proceed?')) {
                     console.log("Resetting entire application state...");
                     localStorage.removeItem(APP_STATE_KEY);
                     // Reset state variable to initial default
                     appState = { currentPage: 'jobSelectionPage', _selectedJobType: null, inventory: { selectedProject: null, skids: {}, nextSkidId: {} }, truckLoad: { truckInfo: { id: '', project: null, length: null, width: null, weight: null }, skids: [], nextSkidId: 1, packingList: {}, signatureData: null } };

                     // Reset UI elements
                     if(jobTypeSelect) jobTypeSelect.value = '';
                     if(truckInfoForm) truckInfoForm.reset(); clearTruckInfoFormErrors();
                     if(packingListForm) packingListForm.reset();
                     if (signaturePad) signaturePad.clear();
                      // Clear Select2 if loaded
                      if (typeof $ !== 'undefined' && $.fn.select2 && $(mainProjectSelect).hasClass('select2-hidden-accessible')) {
                        $(mainProjectSelect).val('').trigger('change.select2');
                      } else { if (mainProjectSelect) mainProjectSelect.value = ''; } // Fallback for no Select2

                     clearProjectValidationError(mainProjectSelect, mainProjectSelectErrorDiv); // Clear project errors
                     if(signatureErrorDiv) signatureErrorDiv.style.display = 'none'; // Hide sig error
                     if(signatureCanvas) signatureCanvas.parentElement.style.border = '2px dashed var(--medium-gray)'; // Reset sig border

                     // Hide skid forms if they were open
                     hideAddEditSkidForm();

                     // Navigate back to the start and render
                     navigateTo('jobSelectionPage'); // This calls renderCurrentPage and updateDynamicContent

                     console.log("Application Reset Complete.");
                     alert("All application data has been cleared.");
                 }
             }
         }

    </script>

</body>
</html>