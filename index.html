<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desa - Complete Loading & Packing Solution</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png"> <!-- Make sure you have a favicon.png or remove this line -->

    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <!-- External JS (Signature Pad) -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

    <style>
        :root {
            --primary-blue: #0056b3;
            --secondary-blue: #007bff;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #343a40;
            --text-muted: #6c757d;
            --danger-red: #dc3545;
            --success-green: #28a745;
            --white: #ffffff;
            --border-radius: 6px;
            --box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background-color: var(--light-gray);
            margin: 0;
            padding: 20px;
            color: var(--dark-gray);
            line-height: 1.6;
        }

        .container {
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 1100px;
            margin: 20px auto;
            overflow: hidden;
        }

        .header {
            background-color: var(--primary-blue);
            color: var(--white);
            padding: 25px 30px;
            text-align: center;
            border-bottom: 5px solid var(--secondary-blue);
        }

        .header-logo {
            display: block;
            height: 50px;
            width: auto;
            margin: 0 auto 15px auto;
            /* If your logo needs to be white on blue: filter: brightness(0) invert(1); */
        }

        .header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 600;
        }

        .header p {
            margin: 5px 0 0;
            font-size: 1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px; /* Space after title */
            color: var(--primary-blue);
            padding-bottom: 10px;
            border-bottom: 2px solid var(--medium-gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Styling for the project group outside the form */
        .project-selection-group {
             padding: 0 25px 15px 25px; /* Match form padding H, add bottom padding */
             margin-bottom: 15px; /* Space before the intro paragraph */
             /* border-bottom: 1px dashed var(--medium-gray); Optional separator */
        }
        .project-selection-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--dark-gray);
        }
        .project-selection-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            line-height: 1.5;
            background-color: var(--white);
            appearance: none; /* Remove default OS styling */
             /* Default arrow */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
            padding-right: 2.5rem;
        }
         /* Hide arrow when Select2 is active */
        .project-selection-group select.select2-hidden-accessible {
            background-image: none;
            padding-right: 15px; /* Reset padding */
        }
         .project-selection-group select:focus {
            border-color: var(--secondary-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }


        /* Form specific styles */
        form {
            background-color: var(--white);
            padding: 25px;
            border-radius: var(--border-radius);
            border: 1px solid var(--medium-gray);
            margin-bottom: 25px;
            margin-top: 0; /* Remove top margin if paragraph is above */
        }

        /* Intro paragraph style */
        .intro-paragraph {
            padding: 0 25px; /* Match form horizontal padding */
            margin-bottom: 15px; /* Space before form */
            color: var(--text-muted);
        }


        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--dark-gray);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group input[type="tel"],
        .form-group textarea,
        .form-group select, /* Keep style for potential future selects in forms */
        .form-control /* Bootstrap compatibility */
         {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            line-height: 1.5;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group input[type="tel"]:focus,
        .form-group textarea:focus,
        .form-group select:focus,
        .form-control:focus {
            border-color: var(--secondary-blue);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .unit-label {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-left: 5px;
            font-weight: normal;
        }

        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            line-height: 1.5;
        }
        .btn:hover { transform: translateY(-2px); filter: brightness(110%); }
        .btn-next { background-color: var(--success-green); color: var(--white); }
        .btn-next:hover { background-color: #218838; }
        .btn-cancel, .btn-secondary { background-color: var(--medium-gray); color: var(--dark-gray); }
        .btn-cancel:hover, .btn-secondary:hover { background-color: #d6d8db; }
        .btn-print, .btn-primary { background-color: var(--primary-blue); color: var(--white); }
        .btn-print:hover, .btn-primary:hover { background-color: #004494; }
        .btn-edit { background-color: var(--secondary-blue); color: var(--white); }
        .btn-edit:hover { background-color: #0056b3; }
        .btn-delete { background-color: var(--danger-red); color: var(--white); }
        .btn-delete:hover { background-color: #c82333; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; gap: 5px; }

        .input-icon { position: relative; }
        .input-icon i { position: absolute; right: 15px; top: calc(50% + 5px); transform: translateY(-50%); color: var(--text-muted); pointer-events: none; }
        .input-icon input { padding-right: 40px; }

        /* Skid Details Styles */
        .skid-details { margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; background-color: var(--white); border-radius: var(--border-radius); overflow: hidden; box-shadow: var(--box-shadow); border: 1px solid var(--medium-gray); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--medium-gray); vertical-align: middle; }
        th { background-color: var(--primary-blue); color: var(--white); font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f1f8ff; }
        td.action-buttons { display: flex; gap: 8px; white-space: nowrap; }
        .form-container { background-color: var(--light-gray); padding: 20px; border-radius: var(--border-radius); margin-top: 20px; margin-bottom: 20px; border: 1px solid var(--medium-gray); }
        .form-container h4 { margin-top: 0; margin-bottom: 20px; color: var(--primary-blue); display: flex; align-items: center; gap: 8px; }
        .row { display: flex; flex-wrap: wrap; margin: 0 -10px; }
        .col-md-3, .col-md-4, .col-md-6, .col-md-12 { padding: 0 10px; margin-bottom: 15px; }
        .col-md-3 { flex: 0 0 25%; max-width: 25%; }
        .col-md-4 { flex: 0 0 33.333%; max-width: 33.333%; }
        .col-md-6 { flex: 0 0 50%; max-width: 50%; }
        .col-md-12 { flex: 0 0 100%; max-width: 100%; }
        .input-group { display: flex; }
        .input-group input { border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .input-group-text { padding: 12px 15px; background-color: var(--medium-gray); border: 1px solid #ced4da; border-left: none; border-radius: 0 var(--border-radius) var(--border-radius) 0; font-size: 1rem; color: var(--text-muted); }
        .mt-3 { margin-top: 1rem; }
        .d-flex { display: flex; }
        .justify-content-between { justify-content: space-between; }
        .align-items-center { align-items: center; }
        .loading-instructions { background-color: #eef7ff; padding: 20px; border-radius: var(--border-radius); margin-top: 20px; border: 1px solid #bde0ff; }
        .loading-instructions h5 { margin-top: 0; margin-bottom: 15px; color: var(--primary-blue); display: flex; align-items: center; gap: 8px; }
        .loading-instructions ul { padding-left: 20px; margin-bottom: 0; }
        .loading-instructions li { margin-bottom: 5px; }
        .warning { color: var(--danger-red); font-weight: 600; background-color: #ffebee; padding: 10px; border-radius: var(--border-radius); margin-top: 10px; border: 1px solid var(--danger-red); }
        .warning i { margin-right: 5px; }

        /* Page Transition */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Packing List Styles */
        .document-container { background-color: var(--white); padding: 40px; box-shadow: none; border: 1px solid var(--medium-gray); border-radius: var(--border-radius); position: relative; margin-bottom: 30px; }
        .packing-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid var(--primary-blue); }
        .logo-container { width: 150px; height: 75px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .logo-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .packing-title-area { flex-grow: 1; text-align: center; margin: 0 20px; }
        .packing-title { font-size: 1.8rem; margin-bottom: 5px; color: var(--dark-gray); font-weight: 700; }
        .subtitle { font-weight: bold; margin-bottom: 0; color: var(--text-muted); font-size: 1rem; line-height: 1.4; }
        .divider { border: 0; height: 1px; background: var(--medium-gray); margin: 30px 0; }
        .form-section { margin-bottom: 30px; }
        .form-section .section-title { font-weight: 600; color: var(--primary-blue); margin-bottom: 15px; font-size: 1.1rem; border-bottom: 1px solid var(--medium-gray); padding-bottom: 8px; }
        .form-row { display: flex; gap: 25px; margin-bottom: 20px; }
        .form-row .form-field { flex: 1; min-width: 0; }
        .form-field { margin-bottom: 20px; }
        .form-field label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: var(--dark-gray); }
        .form-field label.required::after { content: " *"; color: var(--danger-red); font-weight: normal; }
        .form-field input[type="text"], .form-field input[type="date"], .form-field input[type="tel"] { width: 100%; padding: 12px 15px; border: 1px solid #ced4da; border-radius: var(--border-radius); font-size: 1rem; }
        .form-field input:focus, .form-field input[type="tel"]:focus { border-color: var(--secondary-blue); outline: none; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
        .fixed-info { margin-bottom: 20px; padding: 15px 20px; background-color: var(--light-gray); border-radius: var(--border-radius); border-left: 4px solid var(--secondary-blue); }
        .fixed-info p { margin: 8px 0; line-height: 1.5; }
        .fixed-info strong { color: var(--primary-blue); }
        .signature-area { margin-top: 40px; padding-top: 30px; border-top: 1px dashed var(--medium-gray); }
        .signature-container { border: 2px dashed var(--medium-gray); border-radius: var(--border-radius); margin-top: 10px; position: relative; height: 200px; background-color: #fdfdfd; cursor: crosshair; }
        #signature-pad { display: block; width: 100%; height: 100%; touch-action: none; }
        .signature-clear { position: absolute; right: 10px; bottom: 10px; background: var(--danger-red); color: var(--white); border: none; padding: 6px 12px; border-radius: var(--border-radius); cursor: pointer; font-size: 0.8rem; transition: background-color 0.3s; }
        .signature-clear:hover { background-color: #c82333; }
        .packing-action-buttons { display: flex; justify-content: flex-end; gap: 15px; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--medium-gray); }
        .signature-required-error { color: var(--danger-red); font-size: 0.85rem; margin-top: 5px; display: none; }
        .save-status { font-size: 0.85rem; text-align: right; margin-top: 15px; height: 1em; opacity: 0; transition: opacity 0.5s; }
        .save-status.visible { opacity: 1; }

        /* Print Styles */
        @media print {
            body { padding: 0; background: var(--white) !important; font-size: 10pt; color: #000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .container { box-shadow: none; border-radius: 0; max-width: 100%; margin: 0; border: none; }
            .header, .intro-paragraph /* Hide header and intro para */ { display: none !important; }
            .content { padding: 10px; }
            .no-print, .button-group, .packing-action-buttons, .save-status, .signature-clear, .action-buttons td .btn-edit, .action-buttons td .btn-delete, .section-title.no-print,
            .select2-container, /* Hide Select2 UI */
            .project-selection-group /* Hide project group */ { display: none !important; }
            form { border: none; padding: 0; margin: 0; box-shadow: none; }
             .form-field label.required::after { content: "" !important; }
             .form-field label .print-remove-required { display: none !important; }
             .form-group select { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: none !important; border: none; padding: 0; }

            table { page-break-inside: auto; box-shadow: none; border: 1px solid #ccc; border-radius: 0; margin-top: 10px; }
            tr { page-break-inside: avoid; page-break-after: auto }
            th { background-color: #eee !important; color: #000 !important; font-size: 9pt; border: 1px solid #ccc; }
            td { border: 1px solid #ccc; padding: 8px; }
            .fixed-info { page-break-inside: avoid; background-color: #f0f0f0 !important; border: 1px solid #ccc; padding: 10px 15px; }
            .document-container { box-shadow: none; padding: 10px; border: none; }
            .packing-header { border-bottom: 2px solid #666; padding-bottom: 15px; margin-bottom: 15px; }
            .packing-header .logo-container img { max-height: 60px; }
            .packing-title { font-size: 1.6rem; }
            .signature-container { border: 1px solid #999; height: 150px; background-color: #fff !important; }
            #signature-pad { border: none; }
            #printTruckInfo { display: block !important; margin-top: 20px; padding: 15px 0; border: none; border-top: 1px solid #ccc; background-color: transparent !important; page-break-before: always !important; }
            #printLoadingSummary { margin-top: 15px; padding: 15px; background-color: #f5f5f5 !important; border: 1px solid #ddd; font-size: 9pt; }
            #printLoadingSummary h5 { margin-top: 0; margin-bottom: 10px; font-size: 11pt; color: #333; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
            #printLoadingSummary ul { padding-left: 20px; margin-bottom: 5px; list-style: disc; }
            #printLoadingSummary li { margin-bottom: 4px; }
            #printLoadingSummary p.warning { color: #a94442 !important; background-color: #f2dede !important; border: 1px solid #ebccd1 !important; padding: 8px; margin-top: 8px; font-weight: bold; }
            .print-section-title { font-size: 14pt; color: #000; margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; font-weight: bold; }
            .print-section-subtitle { font-size: 11pt; color: #333; margin-top: 15px; margin-bottom: 5px; font-weight: bold; }
            #printTruckInfo p { margin: 4px 0; }
            .print-skids-table { margin-top: 10px; width: 100%; border-collapse: collapse; }
            .print-skids-table th, .print-skids-table td { border: 1px solid #ccc; padding: 6px; font-size: 9pt; }
            .print-skids-table th { background-color: #eee !important; text-align: left; }
            .print-skids-table tfoot td { background-color: #f5f5f5 !important; }
            #printTruckInfo p.project-info { /* Style as needed */ }
        }

        /* Responsive Adjustments */
        @media (max-width: 992px) {
            .col-md-3, .col-md-4 { flex: 0 0 50%; max-width: 50%; }
            .project-selection-group, .intro-paragraph, form { padding-left: 15px; padding-right: 15px; }
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { margin: 10px auto; }
            .content { padding: 15px; }
            .header { padding: 20px 15px; }
            .header-logo { height: 40px; margin-bottom: 10px;}
            .header h1 { font-size: 1.8rem; }
            .col-md-3, .col-md-4, .col-md-6 { flex: 0 0 100%; max-width: 100%; }
            .button-group, .packing-action-buttons { flex-direction: column; gap: 10px; }
            .button-group .btn, .packing-action-buttons .btn { width: 100%; justify-content: center; }
            .form-row { flex-direction: column; gap: 0; }
            .form-row .form-field { margin-bottom: 20px; }
            .packing-header { flex-direction: column; text-align: center; }
            .logo-container { margin-bottom: 15px; width: 120px; height: 60px; }
            .packing-title-area { margin: 0; }
            .packing-title { font-size: 1.5rem; }
            .signature-container { height: 150px; }
            td.action-buttons { flex-direction: row; flex-wrap: wrap; gap: 5px; }
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .project-selection-group, .intro-paragraph, form { padding-left: 10px; padding-right: 10px; }
        }

        /* Style for invalid fields */
        .is-invalid { /* For regular form inputs */
            border-color: var(--danger-red) !important;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.25) !important;
        }
        /* Style invalid Select2 */
        .select2-container--bootstrap-5 .select2-selection.is-invalid {
            border-color: var(--danger-red) !important;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.25) !important;
        }

        /* Select2 Customizations */
        .select2-container--bootstrap-5 .select2-selection--single {
            height: calc(1.5em + 0.75rem + 8px)!important; /* Match input height */
            padding: 12px 15px!important; /* Match input padding */
            border: 1px solid #ced4da!important;
            border-radius: var(--border-radius)!important;
        }
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
             line-height: 1.5!important;
             padding-left: 0!important; /* Reset padding */
        }
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
            height: calc(1.5em + 0.75rem + 6px)!important; /* Adjust arrow height */
        }
        .select2-container--bootstrap-5.select2-container--focus .select2-selection,
        .select2-container--bootstrap-5.select2-container--open .select2-selection {
            border-color: var(--secondary-blue) !important;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25) !important;
        }
        .select2-search__field {
            border: 1px solid #ced4da!important; /* Style search field within dropdown */
            border-radius: var(--border-radius)!important;
            padding: 8px 10px!important;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
             <!-- Make sure this path is correct -->
             <img src="./img.webp" alt="Desa Company Logo" class="header-logo">
            <h1>Desa</h1>
            <p>Complete Loading & Packing Solution</p>
        </div>

        <div class="content">
            <!-- Page 1: Truck Information -->
            <div id="truckInfoPage" class="page"> <!-- JS will add 'active' class -->
                <h2 class="section-title"><i class="fas fa-truck"></i> Truck Information Entry</h2>

                <!-- Project Selection - Outside the Form -->
                <div class="project-selection-group">
                    <label for="project">Project <span class="unit-label">(Required)</span></label>
                    <select id="project" name="project" class="form-control" style="width: 100%;"> <!-- form-control class helps with styling consistency -->
                        <option value="" disabled selected>Select a Project...</option>
                        <option value="47290">47290 – We Wai Kai</option>
                           <option value="47402">47402 – 104Ave</option>
                        <option value="47578">47578 - Place 800</option>
                        <option value="45863">45863 – DeVille Tower</option>
                        <option value="47773">47773 – River Cree Hotel</option>
                    </select>
                    <div id="project-error" style="color: var(--danger-red); font-size: 0.85rem; margin-top: 5px; display: none;">Project selection is required.</div>
                </div>

                <!-- Intro Paragraph -->
                <p class="intro-paragraph">Enter the truck details below to begin loading planning.</p>

                <!-- Truck Details Form -->
                <form id="truckInfoForm" novalidate> <!-- novalidate prevents default browser validation bubbles -->
                    <div class="form-group input-icon">
                        <label for="truckId">Truck Identification <span class="unit-label">(Required)</span></label>
                        <input type="text" id="truckId" name="truckId" class="form-control" placeholder="Enter truck ID or license plate" required>
                        <i class="fas fa-tag"></i>
                        <!-- HTML5 validation message placeholder (optional) -->
                        <div class="invalid-feedback" style="display: none;">Please enter the Truck Identification.</div> <!-- Hide initially -->
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group input-icon">
                                <label for="length">Length <span class="unit-label">(Feet, Required)</span></label>
                                <input type="number" id="length" name="length" class="form-control" placeholder="e.g., 53" step="0.01" min="1" required>
                                <i class="fas fa-ruler-horizontal"></i>
                                <div class="invalid-feedback" style="display: none;">Please enter a valid length.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group input-icon">
                                <label for="width">Width <span class="unit-label">(Feet, Required)</span></label>
                                <input type="number" id="width" name="width" class="form-control" placeholder="e.g., 8.5" step="0.01" min="1" required>
                                <i class="fas fa-ruler-combined"></i>
                                <div class="invalid-feedback" style="display: none;">Please enter a valid width.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group input-icon">
                                <label for="weight">Weight Capacity <span class="unit-label">(Pounds, Required)</span></label>
                                <input type="number" id="weight" name="weight" class="form-control" placeholder="e.g., 45000" step="1" min="1000" required>
                                <i class="fas fa-weight-hanging"></i>
                                <div class="invalid-feedback" style="display: none;">Please enter a valid weight capacity (min 1000).</div>
                            </div>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-cancel" id="resetTruckInfoBtn"><i class="fas fa-undo"></i> Reset</button>
                        <button type="submit" class="btn btn-next" id="nextBtn"><i class="fas fa-arrow-right"></i> Next: Add Skids</button>
                    </div>
                </form>
            </div>

            <!-- Page 2: Skid Details -->
            <div id="skidDetailsPage" class="page">
                <h2 class="section-title"><i class="fas fa-pallet"></i> Skid Details for Truck: <span id="truckIdentifier"></span></h2>
                <p>Add, edit, or remove the skids for this load. <span id="truckSizeDisplay"></span></p>

                 <!-- Add/Edit Skid Form -->
                 <div class="form-container no-print" id="addSkidFormContainer" style="display: none;">
                    <h4 id="skidFormTitle"><i class="fas fa-plus-circle"></i> Add New Skid</h4>
                    <form id="addSkidForm">
                         <input type="hidden" id="editSkidIndex">
                         <div class="row">
                             <div class="col-md-3">
                                 <label for="skidWidth" class="form-label required">Width <span class="unit-label">(ft)</span></label>
                                 <div class="input-group">
                                     <input type="number" class="form-control" id="skidWidth" min="0.1" max="40" step="0.01" required placeholder="e.g., 4">
                                     <span class="input-group-text">ft</span>
                                 </div>
                             </div>
                             <div class="col-md-3">
                                 <label for="skidLength" class="form-label required">Length <span class="unit-label">(ft)</span></label>
                                 <div class="input-group">
                                     <input type="number" class="form-control" id="skidLength" min="0.1" max="40" step="0.01" required placeholder="e.g., 4">
                                     <span class="input-group-text">ft</span>
                                 </div>
                             </div>
                             <div class="col-md-3">
                                 <label for="skidWeight" class="form-label required">Weight <span class="unit-label">(lbs)</span></label>
                                 <div class="input-group">
                                     <input type="number" class="form-control" id="skidWeight" min="1" required placeholder="e.g., 500">
                                     <span class="input-group-text">lbs</span>
                                 </div>
                             </div>
                             <div class="col-md-3">
                                 <label for="skidDescription" class="form-label">Description</label>
                                 <input type="text" class="form-control" id="skidDescription" placeholder="Optional info">
                             </div>
                         </div>
                         <div class="button-group">
                             <button type="button" class="btn btn-secondary" onclick="hideAddEditSkidForm()">
                                 <i class="fas fa-times"></i> Cancel
                             </button>
                             <button type="submit" class="btn btn-primary" id="saveSkidBtn">
                                 <!-- Text set by JS -->
                             </button>
                         </div>
                     </form>
                 </div>

                 <!-- Action Buttons -->
                 <div class="d-flex justify-content-between align-items-center mb-3 mt-3 no-print">
                     <div> <!-- Group Add and Reset buttons -->
                         <button class="btn btn-success" onclick="showAddSkidForm()">
                             <i class="fas fa-plus"></i> Add Skid
                         </button>
                         <!-- === MODIFIED: Added Reset Skids Button === -->
                         <button id="resetSkidsBtn" type="button" class="btn btn-secondary" style="margin-left: 10px;" onclick="handleResetSkids()">
                             <i class="fas fa-undo"></i> Reset Skids List
                         </button>
                         <!-- === END MODIFICATION === -->
                     </div>
                     <button class="btn btn-print" onclick="printSkidPage()">
                         <i class="fas fa-print"></i> Print Loading Plan
                     </button>
                 </div>

                <!-- Skid Table -->
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Skid ID</th><th>Width (ft)</th><th>Length (ft)</th><th>Weight (lbs)</th><th>Description</th><th class="no-print" style="width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="skidTableBody">
                            <tr><td colspan="6" style="text-align: center;">No skids added yet.</td></tr>
                        </tbody>
                         <tfoot>
                            <tr style="font-weight: bold; background-color: var(--light-gray);">
                                <td colspan="3">Totals: <span id="totalSkidCount">0</span> Skids</td>
                                <td id="totalSkidWeight">0.00 lbs</td><td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Loading Instructions -->
                <div class="loading-instructions no-print">
                    <div id="loadingInstructions">Enter truck info and add skids to see summary.</div>
                </div>

                <!-- Navigation Buttons -->
                <div class="button-group no-print" style="margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="goBackToTruckInfo()">
                        <i class="fas fa-arrow-left"></i> Back to Truck Info
                    </button>
                    <button class="btn btn-next" onclick="proceedToPackingList()">
                        <i class="fas fa-clipboard-list"></i> Next: Packing List
                    </button>
                </div>
            </div>

            <!-- Page 3: Packing List -->
            <div id="packingListPage" class="page">
                 <h2 class="section-title no-print"><i class="fas fa-file-invoice"></i> Packing List & Delivery Confirmation</h2>
                 <div class="document-container">
                     <!-- Packing Header -->
                     <div class="packing-header">
                         <div class="logo-container">
                             <img src="./img.webp" alt="Desa Packing List Logo">
                         </div>
                         <div class="packing-title-area">
                             <div class="packing-title">TRUCK LOAD <span id="packingListTruckId"></span></div>
                             <div class="subtitle">DESA PANELS - PACKING LIST</div>
                         </div>
                     </div>

                     <!-- Packing List Form -->
                     <form id="packing-list-form">
                        <!-- Section 1: General Info -->
                        <div class="form-section">
                             <div class="form-row">
                                 <div class="form-field">
                                     <label for="date">DELIVERY DATE: </label>
                                     <input type="date" id="date" name="date" class="form-control">
                                 </div>
                                 <div class="form-field">
                                     <label for="work-order">WORK ORDER NO.:</label>
                                     <input type="text" id="work-order" name="workOrder" class="form-control" placeholder="Enter Work Order Number">
                                 </div>
                             </div>
                             <div class="form-field">
                                 <label for="project-name">PROJECT NAME:</label>
                                 <input type="text" id="project-name" name="projectName" class="form-control" placeholder="Project Name (Auto-filled)"> <!-- Updated placeholder -->
                             </div>
                             <div class="form-field">
                                 <label for="project-address">PROJECT ADDRESS:</label>
                                 <input type="text" id="project-address" name="projectAddress" class="form-control" placeholder="Enter Project Site Address">
                             </div>
                         </div>
                         <div class="divider"></div>
                         <!-- Section 2: Shipper/Contact -->
                         <div class="form-section">
                             <div class="row">
                                 <div class="col-md-6"><div class="fixed-info"><p><strong>SHIPPER / FROM:</strong><br>DESA Glass<br>285079 Bluegrass Drive<br>Rocky View, AB T1X 0P5 Canada</p></div></div>
                                 <div class="col-md-6"><div class="fixed-info"><p><strong>CONTACT:</strong><br>Phone: 403.230.5011<br>Toll Free: 1.877.508.3965</p></div></div>
                             </div>
                         </div>
                         <!-- Section 3: Delivery Info -->
                         <div class="form-section">
                             <div class="section-title">DELIVERY INFORMATION</div>
                             <div class="form-row">
                                 <div class="form-field">
                                     <label for="requested-by">REQUESTED BY:</label>
                                     <input type="text" id="requested-by" name="requestedBy" class="form-control" placeholder="Name of person requesting">
                                 </div>
                                  <div class="form-field">
                                     <label for="carrier">CARRIER:</label>
                                     <input type="text" id="carrier" name="carrier" class="form-control" placeholder="Shipping Company Name">
                                 </div>
                             </div>
                         </div>
                         <!-- Section 4: Consignee -->
                         <div class="form-section">
                             <div class="section-title">CONSIGNEE DETAILS</div>
                            <div class="form-field">
                                 <label for="consignee">CONSIGNEE / TO:</label>
                                 <input type="text" id="consignee" name="consignee" class="form-control" placeholder="Receiving Company or Person">
                             </div>
                             <div class="form-field">
                                 <label for="consignee-address">DELIVERY ADDRESS:</label>
                                 <input type="text" id="consignee-address" name="consigneeAddress" class="form-control" placeholder="Full Delivery Address">
                             </div>
                             <div class="form-row">
                                 <div class="form-field">
                                     <label for="site-contact">SITE CONTACT:</label>
                                     <input type="text" id="site-contact" name="siteContact" class="form-control" placeholder="Name of person on site">
                                 </div>
                                 <div class="form-field">
                                     <label for="site-phone">SITE PHONE:</label>
                                     <input type="tel" id="site-phone" name="sitePhone" class="form-control" pattern="[0-9]{3}-?[0-9]{3}-?[0-9]{4}" placeholder="e.g., 555-123-4567">
                                 </div>
                             </div>
                         </div>
                         <!-- Section 5: Confirmation -->
                         <div class="form-section">
                             <div class="section-title">SHIPMENT CONFIRMATION</div>
                            <div class="form-row">
                                 <div class="form-field">
                                     <label for="delivery-date">ACTUAL DELIVERY DATE:</label>
                                     <input type="date" id="delivery-date" name="deliveryDate" class="form-control">
                                 </div>
                                 <div class="form-field">
                                     <label for="packaged-by">PACKAGED BY:</label>
                                     <input type="text" id="packaged-by" name="packagedBy" class="form-control" placeholder="Initials or Name">
                                 </div>
                             </div>
                             <div class="form-field">
                                 <label for="checked-by">LOADED BY (LOADER):</label>
                                 <input type="text" id="checked-by" name="checkedBy" class="form-control" placeholder="Initials or Name">
                             </div>
                         </div>
                         <!-- Section 6: Signature -->
                         <div class="signature-area">
                            <div class="form-field">
                                 <label for="received-by">DRIVER BY (PRINT NAME):</label> <!-- Removed required class, validated by JS -->
                                 <input type="text" id="received-by" name="receivedBy" class="form-control" placeholder="Print Name of Receiver">
                             </div>
                             <div style="margin-top: 20px;">
                                 <label>DRIVER SIGNATURE:</label> <!-- Removed required class, validated by JS -->
                                 <div class="signature-container">
                                     <canvas id="signature-pad"></canvas>
                                 </div>
                                 <button type="button" class="signature-clear no-print"><i class="fas fa-eraser"></i> Clear Signature</button>
                                 <div class="signature-required-error" id="signature-error">Signature is required for completion.</div>
                             </div>
                         </div>

                         <!-- Save Status -->
                         <div class="save-status no-print" id="save-status"></div>

                         <!-- Hidden Print Section -->
                         <div id="printTruckInfo" style="display: none;">
                             <h3 class="print-section-title">Load Details</h3>
                             <h4 class="print-section-subtitle">Truck Information</h4>
                             <p><strong>Truck ID:</strong> <span id="printTruckId"></span></p>
                             <p class="project-info"><strong>Project:</strong> <span id="printProject">N/A</span></p>
                             <p><strong>Dimensions:</strong> <span id="printTruckDimensions"></span></p>
                             <p><strong>Weight Capacity:</strong> <span id="printTruckWeight"></span> lbs</p>
                             <h4 class="print-section-subtitle">Skid Details (<span id="printTotalSkids"></span> Total)</h4>
                             <table class="print-skids-table">
                                 <thead><tr><th>Skid ID</th><th>Width (ft)</th><th>Length (ft)</th><th>Weight (lbs)</th><th>Description</th></tr></thead>
                                 <tbody id="printSkidsBody"></tbody>
                                 <tfoot><tr style="font-weight: bold;"><td colspan="3" style="text-align: right;">Total Weight:</td><td id="printTotalWeight"></td><td></td></tr></tfoot>
                             </table>
                             <div id="printLoadingSummary"></div>
                         </div>
                     </form> <!-- End Packing List Form -->
                 </div> <!-- End document-container -->

                 <!-- Packing List Action Buttons -->
                <div class="packing-action-buttons no-print">
                     <button type="button" class="btn btn-secondary" onclick="goBackToSkidDetails()"><i class="fas fa-arrow-left"></i> Back to Skid Details</button>
                     <!-- === MODIFIED: Added Reset Packing List Button === -->
                     <button id="resetPackingListBtn" type="button" class="btn btn-cancel" onclick="handleResetPackingList()">
                         <i class="fas fa-undo"></i> Reset Form
                     </button>
                     <!-- === END MODIFICATION === -->
                     <button type="button" class="btn btn-print" id="printPackingListBtn"><i class="fas fa-print"></i> Print Packing List</button>
                     <button type="button" class="btn btn-primary" id="saveProgressBtn"><i class="fas fa-save"></i> Save Progress</button>
                     <button type="button" class="btn btn-success" onclick="completePackingList()"><i class="fas fa-check-circle"></i> Mark as Complete & Save</button>
                 </div>
            </div> <!-- End packingListPage -->

        </div> <!-- End content -->
    </div> <!-- End container -->

    <!-- Load JS Libraries (jQuery must come before Select2) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!-- Main Application Script -->
    <script>
        // --- State Variables ---
        let appState = {
            currentPage: 'truckInfoPage',
            truckInfo: { id: '', project: '', length: null, width: null, weight: null },
            skids: [],
            nextSkidId: 1, // Default starting ID number
            packingList: {},
            signatureData: null
        };
        let signaturePad;
        let saveTimeout;
        const APP_STATE_KEY = 'desaPackingData';

        // --- DOM Elements ---
        // Pages
        const truckInfoPage = document.getElementById('truckInfoPage');
        const skidDetailsPage = document.getElementById('skidDetailsPage');
        const packingListPage = document.getElementById('packingListPage');
        // Truck Info Page Elements
        const projectSelect = document.getElementById('project');
        const projectErrorDiv = document.getElementById('project-error');
        const truckInfoForm = document.getElementById('truckInfoForm');
        // Skid Details Page Elements
        const truckIdentifierSpan = document.getElementById('truckIdentifier');
        const truckSizeDisplaySpan = document.getElementById('truckSizeDisplay');
        const skidTableBody = document.getElementById('skidTableBody');
        const totalSkidCountSpan = document.getElementById('totalSkidCount');
        const totalSkidWeightSpan = document.getElementById('totalSkidWeight');
        const loadingInstructionsDiv = document.getElementById('loadingInstructions');
        const addSkidFormContainer = document.getElementById('addSkidFormContainer');
        const skidFormTitle = document.getElementById('skidFormTitle');
        const addSkidForm = document.getElementById('addSkidForm');
        const saveSkidBtn = document.getElementById('saveSkidBtn');
        const editSkidIndexInput = document.getElementById('editSkidIndex');
        // Packing List Page Elements
        const packingListForm = document.getElementById('packing-list-form');
        const packingListTruckIdSpan = document.getElementById('packingListTruckId');
        const signatureCanvas = document.getElementById('signature-pad');
        const signatureErrorDiv = document.getElementById('signature-error');
        const saveStatusDiv = document.getElementById('save-status');
        const projectNameInput = document.getElementById('project-name'); // Added for quick access
        // Print Elements
        const printTruckId = document.getElementById('printTruckId');
        const printProject = document.getElementById('printProject');
        const printTruckDimensions = document.getElementById('printTruckDimensions');
        const printTruckWeight = document.getElementById('printTruckWeight');
        const printTotalSkids = document.getElementById('printTotalSkids');
        const printSkidsBody = document.getElementById('printSkidsBody');
        const printTotalWeight = document.getElementById('printTotalWeight');
        const printLoadingSummaryDiv = document.getElementById('printLoadingSummary');


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Loaded. Initializing application...");
            loadState();
            initializeSignaturePad();
            setupEventListeners();
            initializeSelect2(); // Call Select2 initialization function
            renderCurrentPage();
            updateSkidTable();
            updateLoadingInstructions();
            // Update headers/forms if loading directly into later pages
            if (appState.currentPage === 'skidDetailsPage') {
                updateSkidPageHeader();
            }
            if (appState.currentPage === 'packingListPage') {
                populatePackingListForm(); // Populate other fields first
                updatePackingListPageHeader();
                updatePackingListProjectName(); // <<< MODIFICATION: Update project name on load
                updatePrintSection(); // Update print section *after* project name is set
            }
            console.log("Application Initialized. Current State:", appState);
        });

        function initializeSelect2() {
             try {
                 if (typeof $ !== 'undefined' && typeof $.fn.select2 === 'function') {
                     $(projectSelect).select2({
                         placeholder: "Select a Project...",
                         allowClear: false,
                         width: '100%',
                         theme: "bootstrap-5"
                     }).on('select2:open', () => { // Fix focus issue on open
                        document.querySelector('.select2-search__field').focus();
                     }).on('change', handleProjectChange); // <<< MODIFICATION: Call handleProjectChange on Select2 change too

                     console.log("Select2 initialized for Project dropdown.");
                     // Set initial value based on loaded state
                     $(projectSelect).val(appState.truckInfo.project || '').trigger('change.select2');
                 } else {
                     console.warn("jQuery or Select2 library not loaded. Project dropdown search functionality will be disabled.");
                     // Add native change listener as fallback
                     if (projectSelect) {
                        projectSelect.addEventListener('change', handleProjectChange);
                     }
                 }
             } catch (error) {
                 console.error("Error initializing Select2:", error);
                  // Add native change listener as fallback in case of error
                 if (projectSelect) {
                    projectSelect.addEventListener('change', handleProjectChange);
                 }
             }
         }

        // --- Signature Pad ---
        function initializeSignaturePad() {
            if (!signatureCanvas) { console.error("Signature canvas element not found!"); return; }
            try {
                resizeCanvas();
                signaturePad = new SignaturePad(signatureCanvas, { backgroundColor: 'rgb(255, 255, 255)', penColor: 'rgb(0, 0, 0)' });
                if (appState.signatureData) { signaturePad.fromDataURL(appState.signatureData); }
                window.addEventListener('resize', debounce(resizeCanvas, 250));
                // Touch event handling
                ['touchstart', 'touchmove', 'touchend'].forEach(event => {
                    signatureCanvas.addEventListener(event, (e) => { if (e.cancelable) e.preventDefault(); }, { passive: false });
                });
                // Auto-save on end stroke
                signaturePad.addEventListener("endStroke", () => {
                    if (!signaturePad.isEmpty()) {
                        signatureErrorDiv.style.display = 'none';
                        signatureCanvas.parentElement.style.border = '2px dashed var(--medium-gray)';
                        appState.signatureData = signaturePad.toDataURL();
                        saveState();
                    } else {
                        appState.signatureData = null;
                        saveState();
                    }
                });
                console.log('Signature pad initialized.');
            } catch(error) { console.error("Error initializing SignaturePad:", error); }
        }
        function resizeCanvas() {
             if (!signatureCanvas || !signaturePad) return;
             const ratio = Math.max(window.devicePixelRatio || 1, 1);
             const data = signaturePad.toDataURL();
             signatureCanvas.style.width = '100%';
             signatureCanvas.style.height = '200px';
             signatureCanvas.width = signatureCanvas.offsetWidth * ratio;
             signatureCanvas.height = signatureCanvas.offsetHeight * ratio;
             const ctx = signatureCanvas.getContext('2d');
             ctx.scale(ratio, ratio);
             signaturePad.clear();
             if (data && data !== 'data:,') {
                 signaturePad.fromDataURL(data);
             }
        }
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            // Truck Info Form Submission
            truckInfoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                let isProjectValid = validateProjectSelection();
                let isFormValid = validateTruckInfoForm();
                if (isProjectValid && isFormValid) {
                    proceedToSkidDetails();
                } else { console.log(`Validation failed: Project=${isProjectValid}, Form=${isFormValid}`); }
            });
            // Reset Button (Truck Info)
            document.getElementById('resetTruckInfoBtn').addEventListener('click', handleResetClick);

             // Clear form errors on input (Truck Info)
            truckInfoForm.querySelectorAll('input.form-control').forEach(input => {
                 input.addEventListener('input', handleFormInputChange.bind(null, input)); // Pass input element
             });
            // Skid Add/Edit Form
            addSkidForm.addEventListener('submit', function(e) { e.preventDefault(); saveSkid(); });
            // Packing List Form Auto-Save (on input changes)
            packingListForm.addEventListener('input', debounce(handlePackingListInputChange, 500));
            // Signature Clear
            document.querySelector('.signature-clear').addEventListener('click', clearSignature);
            // Manual Save (Packing List)
            document.getElementById('saveProgressBtn').addEventListener('click', handleManualSave);
            // Print Button (Packing List)
            document.getElementById('printPackingListBtn').addEventListener('click', handlePrintPackingList);

            // NOTE: The reset buttons for Skids and Packing List have their listeners
            // attached directly via the 'onclick' attribute in the HTML.
        }

        // --- Event Handlers ---
        function handleResetClick() {
            if (confirm('Reset truck information? This cannot be undone.')) {
                truckInfoForm.reset();
                $(projectSelect).val('').trigger('change.select2'); // Reset Select2
                clearProjectValidationError();
                clearTruckInfoFormErrors();
                appState.truckInfo = { id: '', project: '', length: null, width: null, weight: null };
                updatePackingListProjectName(); // <<< MODIFICATION: Update packing list name on reset
                saveState();
            }
        }

        // <<< MODIFICATION: Updated handleProjectChange >>>
        function handleProjectChange() {
             const selectedValue = this.value;
             if (selectedValue) {
                 clearProjectValidationError();
             }
             // Update the appState immediately when the project changes
             appState.truckInfo.project = selectedValue;
             // Update the packing list field in real-time if it exists/is visible
             updatePackingListProjectName();
             // Optional: Save state immediately on project change if desired
             // saveState();
         }

        function handleFormInputChange(inputElement) {
             if (inputElement.checkValidity()) {
                 inputElement.classList.remove('is-invalid');
                  const feedback = inputElement.closest('.form-group')?.querySelector('.invalid-feedback');
                  if (feedback) feedback.style.display = 'none';
             }
         }
        function handlePackingListInputChange(event) {
             // Prevent project name input from triggering a full packing list data collection
             // if it's the target, as it's handled separately by project selection.
             if (event.target.id !== 'project-name') {
                collectPackingListData();
                saveState();
             } else {
                // If the user *manually* edits the project name, save that change
                 appState.packingList.projectName = event.target.value;
                 saveState();
             }
         }
        function handleManualSave() {
              collectPackingListData(); // Ensure latest data is collected
              updatePackingListProjectName(); // Ensure project name is sync'd before save
              saveState(true); // Save with status message
         }
        function handlePrintPackingList() {
              collectPackingListData(); // Ensure latest data is collected
              updatePackingListProjectName(); // Ensure project name is sync'd
              updatePrintSection(); // Update print data
              window.print();
          }


        // --- Validation Helpers ---
        function validateProjectSelection() {
            if (!projectSelect.value) {
                 showProjectValidationError();
                 return false;
             }
             clearProjectValidationError();
             return true;
        }
        function showProjectValidationError() {
             $(projectSelect).next('.select2-container').find('.select2-selection').addClass('is-invalid');
             projectErrorDiv.style.display = 'block';
        }
        function clearProjectValidationError() {
             $(projectSelect).next('.select2-container').find('.select2-selection').removeClass('is-invalid');
             projectErrorDiv.style.display = 'none';
        }
        function validateTruckInfoForm() {
             clearTruckInfoFormErrors();
             const isValid = truckInfoForm.checkValidity();
             if (!isValid) {
                 let firstInvalidElement = null;
                 Array.from(truckInfoForm.elements).forEach(el => {
                     if (el.willValidate && !el.checkValidity()) {
                         el.classList.add('is-invalid');
                         const feedback = el.closest('.form-group')?.querySelector('.invalid-feedback');
                         if (feedback) feedback.style.display = 'block'; // Show feedback message
                         if (!firstInvalidElement) firstInvalidElement = el; // Track first invalid
                     }
                 });
                 if (firstInvalidElement) firstInvalidElement.focus(); // Focus first invalid
             }
             return isValid;
         }
        function clearTruckInfoFormErrors() {
             Array.from(truckInfoForm.elements).forEach(el => {
                 el.classList.remove('is-invalid');
                 const feedback = el.closest('.form-group')?.querySelector('.invalid-feedback');
                 if (feedback) feedback.style.display = 'none'; // Hide feedback
             });
         }

        // --- State Management ---
        // <<< MODIFICATION: Updated saveState >>>
        function saveState(showStatus = false) {
             if (signaturePad && !signaturePad.isEmpty()) {
                 appState.signatureData = signaturePad.toDataURL();
             } else { appState.signatureData = null; }

             // Ensure project value in appState is current *before* saving
             if (projectSelect) {
                 appState.truckInfo.project = projectSelect.value || ''; // Use '' if nothing selected
             }

             // Ensure packingList object exists
             if (!appState.packingList) {
                 appState.packingList = {};
             }
             // Make sure the packing list project name reflects the main selection *unless*
             // it has been manually overridden recently (less likely with auto-update)
             // updatePackingListProjectName(); // Call here ensures it's updated before save
             // appState.packingList.projectName = projectNameInput.value; // Capture current value

             try {
                 localStorage.setItem(APP_STATE_KEY, JSON.stringify(appState));
                 if (showStatus) showSaveStatus("Progress saved successfully!");
                 // console.log("State saved:", appState); // Optional: for debugging
             } catch (e) { console.error("Error saving state:", e); showSaveStatus("Error saving progress.", true); }
         }
        function loadState() {
            const savedState = localStorage.getItem(APP_STATE_KEY);
            if (savedState) {
                try {
                    const loadedData = JSON.parse(savedState);
                    // Merge carefully, preserving defaults if properties are missing
                    appState.currentPage = loadedData.currentPage || 'truckInfoPage';
                    appState.truckInfo = { id: '', project: '', length: null, width: null, weight: null, ...(loadedData.truckInfo || {}) };
                    appState.skids = loadedData.skids || [];
                    appState.nextSkidId = loadedData.nextSkidId || 1;
                    appState.packingList = loadedData.packingList || {};
                    appState.signatureData = loadedData.signatureData || null;
                    console.log("State loaded successfully:", appState);
                } catch (e) { console.error("Error loading state:", e); localStorage.removeItem(APP_STATE_KEY); /* Reset if invalid */ }
            } else { console.log("No saved state found."); }
            // Populate truck info fields from loaded state
            document.getElementById('truckId').value = appState.truckInfo.id || '';
            document.getElementById('length').value = appState.truckInfo.length || '';
            document.getElementById('width').value = appState.truckInfo.width || '';
            document.getElementById('weight').value = appState.truckInfo.weight || '';
            // Note: Select2 value setting happens in initializeSelect2 after loadState
        }
        function showSaveStatus(message, isError = false) {
            if (!saveStatusDiv) return;
            saveStatusDiv.textContent = message;
            saveStatusDiv.style.color = isError ? 'var(--danger-red)' : 'var(--success-green)';
            saveStatusDiv.classList.add('visible');
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => { saveStatusDiv.classList.remove('visible'); }, 3000);
        }

        // --- Navigation & Page Updates ---
        function renderCurrentPage() {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const currentPageElement = document.getElementById(appState.currentPage);
            if (currentPageElement) {
                currentPageElement.classList.add('active');
                 // <<< MODIFICATION: Update project name if navigating TO packing list page >>>
                 if (appState.currentPage === 'packingListPage') {
                    updatePackingListProjectName();
                }
            }
            else { console.warn(`Page element ID "${appState.currentPage}" not found.`); truckInfoPage.classList.add('active'); appState.currentPage = 'truckInfoPage'; }
        }
        function navigateTo(pageId) {
            appState.currentPage = pageId;
            renderCurrentPage(); // Update display first
            saveState(); // Save the new page state
            window.scrollTo(0, 0);
        }
        function proceedToSkidDetails() {
            // Collect truck info data *before* navigating
            appState.truckInfo = {
                id: document.getElementById('truckId').value.trim(),
                project: projectSelect.value, // Value from the select dropdown
                length: parseFloat(document.getElementById('length').value) || null,
                width: parseFloat(document.getElementById('width').value) || null,
                weight: parseFloat(document.getElementById('weight').value) || null
            };
            updateSkidPageHeader();
            updateLoadingInstructions();
            navigateTo('skidDetailsPage'); // Navigate and save state
        }
        function updateSkidPageHeader() {
             truckIdentifierSpan.textContent = appState.truckInfo.id || 'N/A';
             truckSizeDisplaySpan.textContent = `(${appState.truckInfo.length || '?'}ft L × ${appState.truckInfo.width || '?'}ft W, ${appState.truckInfo.weight || '?'}lbs Cap.)`;
        }
        function goBackToTruckInfo() { navigateTo('truckInfoPage'); }

        // <<< MODIFICATION: Updated proceedToPackingList >>>
        function proceedToPackingList() {
             collectPackingListData(); // Collects current packing list form data
             populatePackingListForm(); // Populates form based on collected/saved data
             updatePackingListPageHeader();
             updatePackingListProjectName(); // <<< Ensure project name is set correctly before navigating
             updatePrintSection();
             navigateTo('packingListPage'); // Navigate and save state
         }

        function updatePackingListPageHeader() {
             packingListTruckIdSpan.textContent = appState.truckInfo.id || 'N/A';
         }
        function goBackToSkidDetails() {
             collectPackingListData(); // Save any changes made on packing list page
             navigateTo('skidDetailsPage');
         }
        function completePackingList() {
             collectPackingListData(); // Get latest data
             updatePackingListProjectName(); // Ensure project name sync
             if (!validatePackingListForm()) return; // Validate required fields (name, sig)
             saveState(true); // Save final state with status message
             alert(`Packing list for Truck ${appState.truckInfo.id} completed and saved.`);
         }

        // --- Helper Function to Update Packing List Project Name ---
        // <<< NEW/MODIFIED FUNCTION >>>
        function updatePackingListProjectName() {
            // Only proceed if the project name input exists
            if (!projectNameInput) {
                // console.log("Project name input not found, likely not on packing list page.");
                return;
            }

            const selectedProjectValue = appState.truckInfo.project;
            let projectText = ''; // Default to empty

            if (selectedProjectValue && projectSelect) {
                // Find the option element in the *original* select dropdown
                const selectedOption = projectSelect.querySelector(`option[value="${selectedProjectValue}"]`);
                if (selectedOption) {
                    projectText = selectedOption.text; // Get the display text (e.g., "47290 – We Wai Kai")
                } else {
                    // Fallback if the option list changed or value is somehow invalid
                    console.warn(`Project value "${selectedProjectValue}" selected but not found in options.`);
                    projectText = selectedProjectValue; // Use the value as a fallback
                }
            }

            // Set the value of the 'PROJECT NAME' input field on the packing list
            projectNameInput.value = projectText;
            // console.log(`Set Packing List Project Name input to: "${projectText}"`);

            // Update the packing list data in the app state immediately
            // This ensures it gets saved correctly even if no other input event fires
            if (appState.packingList) {
                 appState.packingList.projectName = projectText;
             }
        }


        // --- Skid Management ---
        function showAddSkidForm() {
             editSkidIndexInput.value = ''; addSkidForm.reset();
             skidFormTitle.innerHTML = '<i class="fas fa-plus-circle"></i> Add New Skid';
             saveSkidBtn.innerHTML = '<i class="fas fa-plus"></i> Add Skid';
             addSkidFormContainer.style.display = 'block'; document.getElementById('skidWidth').focus();
         }
        function showEditSkidForm(index) {
             const skid = appState.skids[index]; if (!skid) return;
             editSkidIndexInput.value = index;
             document.getElementById('skidWidth').value = skid.width; document.getElementById('skidLength').value = skid.length;
             document.getElementById('skidWeight').value = skid.weight; document.getElementById('skidDescription').value = skid.description || '';
             skidFormTitle.innerHTML = `<i class="fas fa-edit"></i> Edit Skid ${skid.id}`;
             saveSkidBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
             addSkidFormContainer.style.display = 'block'; document.getElementById('skidWidth').focus();
         }
        function hideAddEditSkidForm() {
             addSkidFormContainer.style.display = 'none'; addSkidForm.reset(); editSkidIndexInput.value = '';
         }
        function saveSkid() {
             if (!addSkidForm.checkValidity()) { addSkidForm.reportValidity(); return; }
             const width = parseFloat(document.getElementById('skidWidth').value); const length = parseFloat(document.getElementById('skidLength').value);
             const weight = parseFloat(document.getElementById('skidWeight').value); const description = document.getElementById('skidDescription').value.trim();
             const indexStr = editSkidIndexInput.value;
             const skidData = { width, length, weight, description };
             if (indexStr === '') {
                 skidData.id = `SKID-${appState.nextSkidId++}`; // Use current counter then increment
                 appState.skids.push(skidData); console.log("Added new skid:", skidData);
             } else {
                  const skidIndex = parseInt(indexStr, 10);
                  if (!isNaN(skidIndex) && appState.skids[skidIndex]) {
                      skidData.id = appState.skids[skidIndex].id; appState.skids[skidIndex] = skidData; console.log("Updated skid:", skidData);
                  } else { console.error("Invalid index for editing skid:", indexStr); hideAddEditSkidForm(); return; }
             }
             hideAddEditSkidForm(); updateSkidTable(); updateLoadingInstructions(); saveState();
         }

        function deleteSkid(index) {
             const skidId = appState.skids[index]?.id; // Get ID before deleting
             if (!skidId) {
                 console.error("Attempted to delete skid with invalid index:", index);
                 return;
             }

            if (confirm(`Are you sure you want to delete Skid ${skidId}?`)) {
                appState.skids.splice(index, 1); // Remove the skid from the array
                console.log(`Deleted skid ${skidId}`);
                if (appState.skids.length === 0) {
                    appState.nextSkidId = 1; // Reset the counter if all skids deleted
                    console.log("All skids deleted. Resetting nextSkidId to 1.");
                }
                updateSkidTable();
                updateLoadingInstructions();
                saveState(); // Save changes
            }
        }

        function updateSkidTable() {
            skidTableBody.innerHTML = ''; let totalWeight = 0;
            if (appState.skids.length === 0) {
                skidTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No skids added yet. Click "Add Skid".</td></tr>';
                totalSkidCountSpan.textContent = '0'; totalSkidWeightSpan.textContent = '0.00 lbs'; return;
            }
            appState.skids.forEach((skid, index) => {
                totalWeight += (skid.weight || 0);
                const row = skidTableBody.insertRow();
                row.innerHTML = `<td>${skid.id||'N/A'}</td><td>${skid.width?.toFixed(2)||'?'}</td><td>${skid.length?.toFixed(2)||'?'}</td><td>${skid.weight?.toFixed(2)||'?'}</td><td>${skid.description||'-'}</td><td class="action-buttons no-print"><button class="btn btn-edit btn-sm" onclick="showEditSkidForm(${index})" title="Edit Skid ${skid.id}"><i class="fas fa-edit"></i> Edit</button><button class="btn btn-delete btn-sm" onclick="deleteSkid(${index})" title="Delete Skid ${skid.id}"><i class="fas fa-trash"></i> Delete</button></td>`;
            });
            totalSkidCountSpan.textContent = appState.skids.length; totalSkidWeightSpan.textContent = `${totalWeight.toFixed(2)} lbs`;
        }
        function updateLoadingInstructions() {
            loadingInstructionsDiv.innerHTML = generateLoadingSummaryText();
        }
        function generateLoadingSummaryText() {
            if (!appState.truckInfo.length || !appState.truckInfo.width || !appState.truckInfo.weight) return '<p>Enter complete truck information first.</p>';
            if (appState.skids.length === 0) return '<p>Add skids to see loading summary.</p>';
            const totalWeight = appState.skids.reduce((s, k) => s + (k.weight || 0), 0); const totalArea = appState.skids.reduce((s, k) => s + ((k.width || 0) * (k.length || 0)), 0);
            const truckArea = (appState.truckInfo.width || 0) * (appState.truckInfo.length || 0); const truckWeightCap = appState.truckInfo.weight || 0;
            const usedWeightPercent = truckWeightCap > 0 ? (totalWeight / truckWeightCap) * 100 : 0; const usedAreaPercent = truckArea > 0 ? (totalArea / truckArea) * 100 : 0;
            let instructionsHTML = `<p><strong>Summary for Truck ${appState.truckInfo.id||'N/A'}:</strong></p><ul><li>Total Skids: ${appState.skids.length}</li><li>Total Weight: ${totalWeight.toFixed(2)} lbs (${usedWeightPercent.toFixed(1)}% of ${truckWeightCap} lbs capacity)</li><li>Approx. Area: ${totalArea.toFixed(2)} sq ft (${usedAreaPercent.toFixed(1)}% of ${truckArea.toFixed(2)} sq ft available)</li></ul>`;
            let warningsHTML = '';
            if (truckWeightCap > 0 && totalWeight > truckWeightCap) warningsHTML += '<p class="warning"><i class="fas fa-exclamation-triangle"></i> Warning: Total weight exceeds truck capacity!</p>';
            else if (usedWeightPercent > 95 && usedWeightPercent <= 100) warningsHTML += '<p class="warning" style="background-color:#fff3cd;border-color:#ffeeba;color:#856404;"><i class="fas fa-exclamation-circle"></i> Caution: Approaching maximum weight capacity.</p>';
            if (truckArea > 0 && totalArea > truckArea) warningsHTML += '<p class="warning"><i class="fas fa-exclamation-triangle"></i> Warning: Total skid area exceeds theoretical truck floor space.</p>';
            else if (usedAreaPercent > 95 && usedAreaPercent <= 100) warningsHTML += '<p class="warning" style="background-color:#fff3cd;border-color:#ffeeba;color:#856404;"><i class="fas fa-exclamation-circle"></i> Caution: High space utilization.</p>';
            const titleHTML = `<h5><i class="fas fa-info-circle"></i> Loading Summary & Instructions</h5>`;
            return titleHTML + instructionsHTML + warningsHTML;
         }


        // --- Packing List ---
        function collectPackingListData() {
             // Ensure packingList exists
             if (!appState.packingList) appState.packingList = {};
             const formData = new FormData(packingListForm);
             for (const [key, value] of formData.entries()) {
                 // Only update if the key is not 'projectName', which is handled separately
                 // if (key !== 'projectName') {
                     appState.packingList[key] = value;
                 // }
             }
             // Ensure the project name from state is included if not in form data somehow
             if (!appState.packingList.hasOwnProperty('projectName')) {
                 updatePackingListProjectName(); // This function also updates appState.packingList.projectName
             }
             // console.log("Collected packing list data:", appState.packingList); // Debugging
         }
        function populatePackingListForm() {
             for (const [key, value] of Object.entries(appState.packingList || {})) {
                 const input = packingListForm.querySelector(`[name="${key}"]`);
                 if (input && key !== 'projectName') { // Don't overwrite project name here
                      input.value = value || '';
                 }
             }
             // Specifically set project name *after* other fields are populated
             updatePackingListProjectName();
         }
        function validatePackingListForm() {
             let isValid = true; let firstInvalidField = null;
             packingListForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
             signatureErrorDiv.style.display = 'none'; if(signatureCanvas) signatureCanvas.parentElement.style.border = '2px dashed var(--medium-gray)';

             // Check Driver Name
             const receivedByInput = document.getElementById('received-by');
             if (!receivedByInput || !receivedByInput.value.trim()) {
                 isValid = false;
                 if(receivedByInput) receivedByInput.classList.add('is-invalid');
                 if (!firstInvalidField) firstInvalidField = receivedByInput;
             }

             // Check Signature
             if (!signaturePad || signaturePad.isEmpty()) {
                 isValid = false;
                 signatureErrorDiv.style.display = 'block';
                 if(signatureCanvas) signatureCanvas.parentElement.style.border = '2px dashed var(--danger-red)';
                 if (!firstInvalidField) firstInvalidField = signatureCanvas;
             }

             // Add other required packing list field checks here if needed

             if (!isValid) {
                 alert('Please fill in all required fields (Driver Name and Signature are mandatory).');
                 if (firstInvalidField) setTimeout(() => {
                    if (firstInvalidField.focus) firstInvalidField.focus();
                    firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
             }
             return isValid;
         }
        function clearSignature() {
             if (signaturePad) {
                 signaturePad.clear();
                 signatureErrorDiv.style.display = 'none';
                 if(signatureCanvas) signatureCanvas.parentElement.style.border = '2px dashed var(--medium-gray)';
                 appState.signatureData = null;
                 saveState(); // Save the cleared signature state
             }
         }

        // --- Printing ---
        function updatePrintSection() {
            if (!printTruckId || !printProject || !printSkidsBody || !projectSelect) { console.error("Required print elements or project select missing."); return; }

            // Truck Info
            printTruckId.textContent = appState.truckInfo.id || 'N/A';
            printTruckDimensions.textContent = `${appState.truckInfo.length||'?'}ft L × ${appState.truckInfo.width||'?'}ft W`;
            printTruckWeight.textContent = `${appState.truckInfo.weight||'?'} lbs`;

            // Project Name (get text from the select options)
            let projText = 'N/A';
            if (appState.truckInfo.project) {
                const foundOpt = Array.from(projectSelect.options).find(o => o.value === appState.truckInfo.project);
                projText = foundOpt ? foundOpt.text : appState.truckInfo.project; // Use text if found, else value
            }
            printProject.textContent = projText;

            // Skid Info
            printTotalSkids.textContent = appState.skids.length;
            printSkidsBody.innerHTML = '';
            let printWeightTotal = 0;
            appState.skids.forEach(skid => {
                printWeightTotal += (skid.weight || 0);
                const row = printSkidsBody.insertRow();
                row.innerHTML = `<td>${skid.id||'N/A'}</td><td>${skid.width?.toFixed(2)||'?'}</td><td>${skid.length?.toFixed(2)||'?'}</td><td>${skid.weight?.toFixed(2)||'?'}</td><td>${skid.description||'-'}</td>`;
            });
            printTotalWeight.textContent = `${printWeightTotal.toFixed(2)} lbs`;

            // Loading Summary
            if (printLoadingSummaryDiv) {
                let html = generateLoadingSummaryText().replace(/<h5>.*?<\/h5>/, '<h5>Loading Summary</h5>'); // Replace H5 title for print context
                printLoadingSummaryDiv.innerHTML = html;
            }
        }
        function printSkidPage() { window.print(); } // Alias for printing from skid page

        // --- === NEW/MODIFIED: Reset Functions === ---

        /**
         * Handles resetting the list of skids.
         * Clears the skids array, resets the counter, updates UI, and saves state.
         */
        function handleResetSkids() {
            if (appState.skids.length === 0) {
                alert("Skid list is already empty.");
                return;
            }
            if (confirm('Are you sure you want to remove ALL skids listed for this truck? This action cannot be undone.')) {
                console.log("Resetting skids list...");
                appState.skids = []; // Clear the skids array
                appState.nextSkidId = 1; // Reset the skid ID counter
                updateSkidTable(); // Update the table display (will show "No skids")
                updateLoadingInstructions(); // Update the summary text
                saveState(); // Persist the changes
                alert("Skid list has been reset.");
            }
        }

        /**
         * Handles resetting the Packing List form fields.
         * Clears form inputs, signature, related app state, and saves changes.
         */
        function handleResetPackingList() {
            if (confirm('Are you sure you want to reset the Packing List form? Any unsaved information in the form will be cleared.')) {
                console.log("Resetting Packing List form...");
                // 1. Reset the form visually
                if (packingListForm) {
                    packingListForm.reset(); // Clears standard input fields
                }

                // 2. Clear the signature pad
                clearSignature(); // This already handles clearing the pad and appState.signatureData

                // 3. Clear the corresponding packing list data in the app state
                appState.packingList = {}; // Reset the data object

                // 4. Re-populate fields that should persist or be auto-filled (like Project Name)
                updatePackingListProjectName(); // Put back the project name based on truck info

                // 5. Clear any validation states (optional, but good practice)
                 packingListForm.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
                 if(signatureErrorDiv) signatureErrorDiv.style.display = 'none';
                 if(signatureCanvas) signatureCanvas.parentElement.style.border = '2px dashed var(--medium-gray)';

                // 6. Save the cleared state
                saveState();
                alert("Packing List form has been reset.");
            }
        }
        // --- === END NEW/MODIFIED: Reset Functions === ---


        // --- Utility ---
        function resetEntireProcess() {
             if (confirm('Are you sure you want to clear ALL data and start over? This cannot be undone.')) {
                 localStorage.removeItem(APP_STATE_KEY);
                 // Reset state object to defaults
                 appState = { currentPage: 'truckInfoPage', truckInfo: { id: '', project: '', length: null, width: null, weight: null }, skids: [], nextSkidId: 1, packingList: {}, signatureData: null };
                 // Reset forms
                 if(truckInfoForm) truckInfoForm.reset();
                 if(addSkidForm) addSkidForm.reset();
                 if(packingListForm) packingListForm.reset();
                 // Reset Select2
                 if (typeof $ !== 'undefined' && typeof $.fn.select2 === 'function') {
                    $(projectSelect).val('').trigger('change.select2');
                 } else if (projectSelect) {
                     projectSelect.value = ''; // Fallback for native select
                 }
                 // Clear signature
                 if (signaturePad) signaturePad.clear();
                 // Clear validation errors
                 clearProjectValidationError();
                 clearTruckInfoFormErrors();
                 if(signatureErrorDiv) signatureErrorDiv.style.display = 'none';
                 if(signatureCanvas) signatureCanvas.parentElement.style.border = '2px dashed var(--medium-gray)';
                 // Update UI elements
                 updateSkidTable();
                 updateLoadingInstructions();
                 hideAddEditSkidForm();
                 updatePackingListProjectName(); // Clear packing list project name too
                 renderCurrentPage(); // Show the first page
                 console.log("Application Reset.");
                 alert("Application data cleared.");
             }
         }

    </script>

</body>
</html>